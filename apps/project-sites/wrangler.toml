#:schema node_modules/wrangler/config-schema.json
name = "project-sites"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
send_metrics = false

# ─── Observability ───────────────────────────────────────────
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1

# ─── KV Namespace for caching ────────────────────────────────
[[kv_namespaces]]
binding = "CACHE_KV"
id = "dc6e00fd0de94cc3afc2c6c774347312"

# ─── KV for prompt hotfixes (optional override of bundled prompts) ─
[[kv_namespaces]]
binding = "PROMPT_STORE"
id = "c74012c6439e403487ece3f66b6f1362"

# ─── D1 Database ─────────────────────────────────────────────
[[d1_databases]]
binding = "DB"
database_name = "project-sites-db"
database_id = "f5b59818-c785-4807-8aca-282c9037c58c"

# ─── R2 Bucket for static site output ────────────────────────
[[r2_buckets]]
binding = "SITES_BUCKET"
bucket_name = "project-sites"

# ─── Queue producer for workflow jobs ─────────────────────────
# Uncomment when Queues is enabled on the Cloudflare account
# [[queues.producers]]
# binding = "QUEUE"
# queue = "project-sites-workflow"

# ─── Queue consumer ──────────────────────────────────────────
# [[queues.consumers]]
# queue = "project-sites-workflow"
# max_batch_size = 10
# max_retries = 3

# ─── Cloudflare Workflow for AI site generation ────────────────
[[workflows]]
name = "site-generation-workflow"
binding = "SITE_WORKFLOW"
class_name = "SiteGenerationWorkflow"

# ─── AI binding for Cloudflare Workers AI ─────────────────────
[ai]
binding = "AI"

# ─── Staging ─────────────────────────────────────────────────
[env.staging]
name = "project-sites-staging"
routes = [
  { pattern = "sites-staging.megabyte.space", custom_domain = true }
]

[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.workflows]]
name = "site-generation-workflow-staging"
binding = "SITE_WORKFLOW"
class_name = "SiteGenerationWorkflow"

[env.staging.ai]
binding = "AI"

[env.staging.observability]
enabled = true
head_sampling_rate = 1

[env.staging.observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[env.staging.observability.traces]
enabled = true
head_sampling_rate = 1

[[env.staging.kv_namespaces]]
binding = "CACHE_KV"
id = "1efeecd1a22c4b029beda649938e2e3c"

[[env.staging.kv_namespaces]]
binding = "PROMPT_STORE"
id = "fd15127279a44952a3a4eb2c557722ee"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "project-sites-db-staging"
database_id = "7bdf6256-7b5d-417f-9b29-c7466ec78508"

[[env.staging.r2_buckets]]
binding = "SITES_BUCKET"
bucket_name = "project-sites-staging"

# Uncomment when Queues is enabled on the Cloudflare account
# [[env.staging.queues.producers]]
# binding = "QUEUE"
# queue = "project-sites-workflows-staging"

# [[env.staging.queues.consumers]]
# queue = "project-sites-workflows-staging"
# max_batch_size = 10
# max_retries = 3

# ─── Production ──────────────────────────────────────────────
[env.production]
name = "project-sites"
routes = [
  { pattern = "sites.megabyte.space", custom_domain = true }
]

[env.production.vars]
ENVIRONMENT = "production"

[[env.production.workflows]]
name = "site-generation-workflow-production"
binding = "SITE_WORKFLOW"
class_name = "SiteGenerationWorkflow"

[env.production.ai]
binding = "AI"

[env.production.observability]
enabled = true
head_sampling_rate = 0.1

[env.production.observability.logs]
enabled = true
head_sampling_rate = 0.1
invocation_logs = true

[env.production.observability.traces]
enabled = true
head_sampling_rate = 0.1

[[env.production.kv_namespaces]]
binding = "CACHE_KV"
id = "d4f48d52fbe14ccd884ea6dd368568ba"

[[env.production.kv_namespaces]]
binding = "PROMPT_STORE"
id = "5ab9b9509a0741f5a76a6f5c97d7c709"

[[env.production.d1_databases]]
binding = "DB"
database_name = "project-sites-db-production"
database_id = "ea3e839a-c641-4861-ae30-dfc63bff8032"

[[env.production.r2_buckets]]
binding = "SITES_BUCKET"
bucket_name = "project-sites-production"

# Uncomment when Queues is enabled on the Cloudflare account
# [[env.production.queues.producers]]
# binding = "QUEUE"
# queue = "project-sites-workflows-production"

# [[env.production.queues.consumers]]
# queue = "project-sites-workflows-production"
# max_batch_size = 10
# max_retries = 3
