<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Sites - Your Website, Handled. Finally.</title>
  <meta name="description" content="AI-powered websites for small businesses. Search for your business and get a professional site in minutes.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1f680;</text></svg>">
  <link href="https://releases.transloadit.com/uppy/v4.12.1/uppy.min.css" rel="stylesheet">
  <style>
    /* ======================================================
       CSS Custom Properties
       ====================================================== */
    :root {
      --bg-primary: #0a0a1a;
      --bg-secondary: #111128;
      --bg-card: #161635;
      --bg-card-hover: #1c1c45;
      --bg-input: #0f0f2a;
      --accent: #64ffda;
      --accent-dim: rgba(100, 255, 218, 0.12);
      --accent-glow: rgba(100, 255, 218, 0.25);
      --secondary: #7c3aed;
      --secondary-dim: rgba(124, 58, 237, 0.15);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: rgba(100, 255, 218, 0.1);
      --border-hover: rgba(100, 255, 218, 0.3);
      --error: #ef4444;
      --error-dim: rgba(239, 68, 68, 0.12);
      --success: #22c55e;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
      --shadow-accent: 0 0 30px rgba(100, 255, 218, 0.15);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; height: 100%; }

    body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ======================================================
       Scrollbar
       ====================================================== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-card); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

    /* ======================================================
       Animations
       ====================================================== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes orbFloat1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(60px, -40px) scale(1.1); }
      66% { transform: translate(-30px, 30px) scale(0.95); }
    }
    @keyframes orbFloat2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(-50px, 50px) scale(0.9); }
      66% { transform: translate(40px, -20px) scale(1.05); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0); opacity: 0; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ======================================================
       Header / Nav
       ====================================================== */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      background: rgba(10, 10, 26, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text-primary);
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: -0.01em;
      cursor: pointer;
    }
    .logo svg { flex-shrink: 0; }
    .logo em {
      font-style: normal;
      color: var(--accent);
    }

    /* ======================================================
       Screens Container
       ====================================================== */
    .app {
      min-height: 100vh;
      padding-top: 60px;
      position: relative;
    }
    .screen {
      display: none;
      min-height: calc(100vh - 60px);
      animation: fadeIn 0.3s ease;
    }
    .screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ======================================================
       Background Orbs (shared)
       ====================================================== */
    .bg-orbs {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .bg-orbs .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.18;
    }
    .bg-orbs .orb-1 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, var(--secondary), transparent 70%);
      top: -120px; right: -120px;
      animation: orbFloat1 20s ease-in-out infinite;
    }
    .bg-orbs .orb-2 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, var(--accent), transparent 70%);
      bottom: -80px; left: -100px;
      animation: orbFloat2 18s ease-in-out infinite;
    }
    .bg-orbs .orb-3 {
      width: 300px; height: 300px;
      background: radial-gradient(circle, #f472b6, transparent 70%);
      top: 40%; left: 50%;
      animation: orbFloat1 22s ease-in-out infinite reverse;
    }

    /* ======================================================
       Screen 1: Search / Hero
       ====================================================== */
    .screen-search {
      padding: 0 24px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .hero-brand {
      margin-bottom: 16px;
      animation: fadeInUp 0.6s ease;
    }
    .hero-brand h1 {
      font-size: clamp(2.2rem, 5.5vw, 3.8rem);
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.1;
      margin-bottom: 12px;
    }
    .hero-brand h1 .gradient-text {
      background: linear-gradient(135deg, var(--accent), var(--secondary), #f472b6);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 5s linear infinite;
    }
    .hero-brand .tagline {
      font-size: clamp(1rem, 2vw, 1.25rem);
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Search box */
    .search-wrapper {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 640px;
      margin: 32px auto 0;
      animation: fadeInUp 0.6s ease 0.15s both;
    }
    .search-input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      display: flex;
    }
    .search-input {
      width: 100%;
      padding: 18px 20px 18px 52px;
      font-size: 1.1rem;
      font-family: var(--font);
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .search-input::placeholder {
      color: var(--text-muted);
    }
    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim), 0 0 40px var(--accent-glow);
    }
    .search-spinner {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      display: none;
    }
    .search-spinner.visible { display: block; }

    /* Dropdown */
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow-lg);
    }
    .search-dropdown.open {
      display: block;
      animation: fadeInScale 0.2s ease;
    }
    .search-result {
      padding: 14px 20px;
      cursor: pointer;
      transition: background var(--transition);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover {
      background: var(--bg-card-hover);
    }
    .search-result-icon {
      flex-shrink: 0;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2px;
    }
    .search-result-icon svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }
    .search-result-text { flex: 1; min-width: 0; }
    .search-result-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-result-address {
      font-size: 0.82rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Custom website option */
    .search-result-custom {
      background: var(--secondary-dim);
      border-top: 1px solid rgba(124, 58, 237, 0.2);
    }
    .search-result-custom:hover {
      background: rgba(124, 58, 237, 0.22);
    }
    .search-result-custom .search-result-icon {
      background: var(--secondary-dim);
    }
    .search-result-custom .search-result-icon svg {
      color: var(--secondary);
    }
    .search-result-custom .search-result-name {
      color: #c4b5fd;
    }
    .search-result-custom .search-result-address {
      color: #a78bfa;
      font-style: normal;
    }

    .search-hint {
      margin-top: 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
      animation: fadeInUp 0.6s ease 0.3s both;
    }

    /* ======================================================
       Screen 3: Sign-In Gate
       ====================================================== */
    .screen-signin {
      padding: 0 24px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .signin-card {
      width: 100%;
      max-width: 440px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 40px 32px;
      animation: fadeInScale 0.35s ease;
    }
    .signin-card h2 {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .signin-card .signin-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .signin-methods { display: flex; flex-direction: column; gap: 12px; }

    .signin-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), border-color var(--transition);
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
    }
    .signin-btn:hover {
      transform: translateY(-1px);
      border-color: var(--border-hover);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .signin-btn svg { flex-shrink: 0; }

    .signin-btn-google {
      background: #fff;
      color: #1f1f1f;
      border-color: #dadce0;
    }
    .signin-btn-google:hover {
      background: #f8f9fa;
      border-color: #c4c7cc;
    }

    .signin-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .signin-divider::before,
    .signin-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Phone / Email form panels */
    .signin-panel {
      display: none;
      animation: fadeInUp 0.3s ease;
    }
    .signin-panel.active { display: block; }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      text-align: left;
    }
    .input-group label {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .input-field {
      width: 100%;
      padding: 14px 16px;
      font-size: 1rem;
      font-family: var(--font);
      background: var(--bg-input);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .input-field::placeholder { color: var(--text-muted); }
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    textarea.input-field {
      resize: vertical;
      min-height: 120px;
      line-height: 1.6;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      margin-top: 20px;
      transition: color var(--transition);
      background: none;
      border: none;
      font-family: var(--font);
    }
    .back-link:hover { color: var(--accent); }

    /* ======================================================
       Buttons (shared)
       ====================================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      font-family: var(--font);
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), opacity var(--transition);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    .btn-accent {
      background: var(--accent);
      color: var(--bg-primary);
    }
    .btn-accent:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 40px rgba(100, 255, 218, 0.3), 0 0 80px rgba(100, 255, 218, 0.1);
    }
    .btn-secondary-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1.5px solid var(--border);
    }
    .btn-secondary-outline:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    .btn-full { width: 100%; }
    .btn-large {
      padding: 16px 32px;
      font-size: 1.05rem;
      border-radius: var(--radius-lg);
    }

    /* ======================================================
       Inline Error / Success Messages
       ====================================================== */
    .msg {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-top: 12px;
      display: none;
      text-align: left;
    }
    .msg.visible { display: block; animation: fadeIn 0.2s ease; }
    .msg-error {
      background: var(--error-dim);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .msg-success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .msg-info {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(100, 255, 218, 0.15);
    }

    /* ======================================================
       Loading dots
       ====================================================== */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.32s; }

    /* ======================================================
       Screen 3b: Details + Upload
       ====================================================== */
    .screen-details {
      padding: 24px;
      position: relative;
      z-index: 1;
      width: 100%;
    }
    .details-card {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 36px 32px;
      animation: fadeInScale 0.35s ease;
    }
    .details-card h2 {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .details-card .details-subtitle {
      font-size: 0.88rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .selected-business-badge {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent-dim);
      border: 1px solid rgba(100, 255, 218, 0.15);
      border-radius: var(--radius);
      margin-bottom: 24px;
    }
    .selected-business-badge .badge-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .selected-business-badge .badge-text { text-align: left; }
    .selected-business-badge .badge-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
    }
    .selected-business-badge .badge-addr {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .uppy-section {
      margin: 20px 0;
    }
    .uppy-section label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
      text-align: left;
    }
    #uppy-dashboard-area {
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* Uppy dark theme overrides */
    .uppy-Dashboard-inner {
      background: var(--bg-input) !important;
      border-color: var(--border) !important;
    }

    /* ======================================================
       Screen 4: Waiting
       ====================================================== */
    .screen-waiting {
      padding: 24px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .waiting-content {
      max-width: 480px;
      animation: fadeInScale 0.4s ease;
    }
    .waiting-content lottie-player {
      margin: 0 auto 24px;
      max-width: 280px;
    }
    .waiting-title {
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: -0.02em;
    }
    .waiting-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .waiting-contact {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 16px;
    }
    .waiting-status {
      margin-top: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .waiting-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }

    /* ======================================================
       Responsive
       ====================================================== */
    @media (max-width: 640px) {
      .signin-card, .details-card {
        padding: 28px 20px;
      }
      .search-input {
        font-size: 1rem;
        padding: 16px 18px 16px 48px;
      }
      .hero-brand h1 {
        font-size: 2rem;
      }
    }
    @media (max-width: 380px) {
      .header { padding: 0 16px; }
      .screen-search, .screen-signin, .screen-details, .screen-waiting {
        padding: 16px;
      }
    }
  </style>

  <!-- PostHog Tracking -->
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing startSessionRecording stopSessionRecording isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getBootstrapData setPersonProperties setPersonPropertiesForFlags".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_placeholder', { api_host: 'https://us.i.posthog.com', person_profiles: 'identified_only' });
  </script>
</head>
<body>

  <!-- Background orbs -->
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a class="logo" onclick="navigateTo('search')">
        <svg width="26" height="26" viewBox="0 0 28 28" fill="none">
          <rect width="28" height="28" rx="6" fill="#64ffda"/>
          <path d="M8 14l4 4 8-8" stroke="#0a0a1a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Project <em>Sites</em>
      </a>
    </div>
  </header>

  <!-- App Container -->
  <div class="app">

    <!-- ==========================================
         Screen 1: Hero / Search
         ========================================== -->
    <div id="screen-search" class="screen screen-search active">
      <div class="hero-brand">
        <h1>Your Website &mdash;<br><span class="gradient-text">Handled. Finally.</span></h1>
        <p class="tagline">AI-powered websites for small businesses. Search and claim yours in minutes.</p>
      </div>

      <div class="search-wrapper">
        <div class="search-input-wrap">
          <span class="search-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
          </span>
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Search for your business..."
            autocomplete="off"
            spellcheck="false"
          />
          <div id="search-spinner" class="search-spinner"></div>
        </div>

        <div id="search-dropdown" class="search-dropdown"></div>
      </div>

      <p class="search-hint">Search by business name to get started, or build a custom site from scratch.</p>

      <div id="search-error" class="msg msg-error"></div>
    </div>

    <!-- ==========================================
         Screen 3: Sign-In Gate
         ========================================== -->
    <div id="screen-signin" class="screen screen-signin">
      <div class="signin-card">
        <h2>Sign in to claim your website</h2>
        <p class="signin-subtitle">Create your account to get started.</p>

        <!-- Main sign-in options -->
        <div id="signin-methods" class="signin-methods">
          <button class="signin-btn signin-btn-google" onclick="signInWithGoogle()">
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Continue with Google
          </button>

          <div class="signin-divider">or</div>

          <button class="signin-btn" onclick="showSigninPanel('phone')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/>
            </svg>
            Sign in with Phone
          </button>

          <button class="signin-btn" onclick="showSigninPanel('email')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
            Sign in with Email
          </button>
        </div>

        <!-- Phone panel -->
        <div id="signin-phone-panel" class="signin-panel">
          <div id="phone-step-input">
            <div class="input-group">
              <label for="phone-input">Phone Number</label>
              <input type="tel" id="phone-input" class="input-field" placeholder="+1 (555) 123-4567" />
            </div>
            <button class="btn btn-accent btn-full" id="phone-send-btn" onclick="sendPhoneOtp()">
              Send Verification Code
            </button>
            <div id="phone-send-msg" class="msg"></div>
          </div>

          <div id="phone-step-otp" style="display:none;">
            <div class="input-group">
              <label for="otp-input">Verification Code</label>
              <input type="text" id="otp-input" class="input-field" placeholder="123456" maxlength="6" inputmode="numeric" pattern="[0-9]*" />
            </div>
            <button class="btn btn-accent btn-full" id="otp-verify-btn" onclick="verifyPhoneOtp()">
              Verify Code
            </button>
            <div id="phone-verify-msg" class="msg"></div>
          </div>

          <button class="back-link" onclick="showSigninPanel('main')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to sign-in options
          </button>
        </div>

        <!-- Email panel -->
        <div id="signin-email-panel" class="signin-panel">
          <div id="email-step-input">
            <div class="input-group">
              <label for="email-input">Email Address</label>
              <input type="email" id="email-input" class="input-field" placeholder="you@example.com" />
            </div>
            <button class="btn btn-accent btn-full" id="email-send-btn" onclick="sendMagicLink()">
              Send Magic Link
            </button>
            <div id="email-send-msg" class="msg"></div>
          </div>

          <div id="email-step-sent" style="display:none;">
            <div class="msg msg-success visible" style="text-align:center; margin-top:0;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block; vertical-align:middle; margin-right:6px;">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
              </svg>
              Check your email for a sign-in link. You can close this tab.
            </div>
          </div>

          <button class="back-link" onclick="showSigninPanel('main')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to sign-in options
          </button>
        </div>

        <!-- Back to search -->
        <button class="back-link" id="signin-back-to-search" onclick="navigateTo('search')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Back to search
        </button>
      </div>
    </div>

    <!-- ==========================================
         Screen 3b: Details + File Upload
         ========================================== -->
    <div id="screen-details" class="screen screen-details">
      <div class="details-card">
        <h2 id="details-title">Tell us more about your business</h2>
        <p class="details-subtitle" id="details-subtitle">Any extra info helps us build the perfect website for you.</p>

        <!-- Selected business display -->
        <div id="details-business-badge" class="selected-business-badge" style="display:none;">
          <div class="badge-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64ffda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <div class="badge-text">
            <div class="badge-name" id="badge-biz-name"></div>
            <div class="badge-addr" id="badge-biz-addr"></div>
          </div>
        </div>

        <div class="input-group">
          <label for="details-textarea">Additional Context / Instructions</label>
          <textarea
            id="details-textarea"
            class="input-field"
            placeholder="Tell us about your business, what services you offer, preferred style, brand colors, or any specific features you'd like on your website..."
          ></textarea>
        </div>

        <div class="uppy-section">
          <label>Upload Logos, Photos, Menus, or Documents</label>
          <div id="uppy-dashboard-area"></div>
        </div>

        <button class="btn btn-accent btn-large btn-full" id="build-btn" onclick="submitBuild()">
          Build My Website
        </button>

        <div id="build-msg" class="msg"></div>

        <button class="back-link" onclick="navigateTo('signin')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Back
        </button>
      </div>
    </div>

    <!-- ==========================================
         Screen 4: Waiting (Lottie Cat)
         ========================================== -->
    <div id="screen-waiting" class="screen screen-waiting">
      <div class="waiting-content">
        <lottie-player
          src="https://lottie.host/embed/54023765-9df7-415f-968c-5fff79dba43a/lottie.json"
          background="transparent"
          speed="1"
          style="width: 260px; height: 260px;"
          loop
          autoplay
        ></lottie-player>

        <h2 class="waiting-title">We're building your website...</h2>
        <p class="waiting-subtitle">Give us a few minutes. We'll notify you when it's ready.</p>
        <p class="waiting-contact" id="waiting-contact"></p>

        <div class="waiting-status">
          <span class="status-dot"></span>
          <span>Build in progress</span>
          <span class="loading-dots"><span></span><span></span><span></span></span>
        </div>
      </div>
    </div>

  </div>

  <!-- Lottie Player -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.8/dist/lottie-player.js"></script>

  <!-- Uppy -->
  <script src="https://releases.transloadit.com/uppy/v4.12.1/uppy.min.js"></script>

  <script>
    /* ===========================================================
       State Machine
       =========================================================== */
    var state = {
      screen: 'search',
      searchQuery: '',
      searchResults: [],
      preBuiltResults: [],
      selectedBusiness: null,
      mode: 'business',      // 'business' | 'custom'
      session: null,          // { token, identifier }
      siteId: null,
      slug: null,
      signinPanel: 'main'    // 'main' | 'phone' | 'email'
    };

    var searchDebounceTimer = null;
    var pollTimer = null;
    var uppyInstance = null;

    /** Redirect helper - stubbable in E2E tests */
    function redirectTo(url) {
      window.location.href = url;
    }

    /* ===========================================================
       Screen Navigation
       =========================================================== */
    function navigateTo(screen) {
      state.screen = screen;
      render();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('screen_view', { screen: screen });
      }
    }

    function render() {
      var screens = document.querySelectorAll('.screen');
      for (var i = 0; i < screens.length; i++) {
        screens[i].classList.remove('active');
      }
      var target = document.getElementById('screen-' + state.screen);
      if (target) {
        target.classList.add('active');
      }

      // Initialize Uppy when details screen is shown
      if (state.screen === 'details' && !uppyInstance) {
        initUppy();
      }

      // Start polling when on waiting screen
      if (state.screen === 'waiting') {
        startPolling();
      } else {
        stopPolling();
      }
    }

    /* ===========================================================
       Search Logic
       =========================================================== */
    var searchInput = document.getElementById('search-input');
    var searchDropdown = document.getElementById('search-dropdown');
    var searchSpinner = document.getElementById('search-spinner');

    searchInput.addEventListener('input', function() {
      var query = searchInput.value.trim();
      state.searchQuery = query;

      clearTimeout(searchDebounceTimer);
      hideMsg('search-error');

      if (query.length < 2) {
        searchSpinner.classList.remove('visible');
        closeDropdown();
        return;
      }

      searchSpinner.classList.add('visible');

      searchDebounceTimer = setTimeout(function() {
        performSearch(query);
      }, 300);
    });

    searchInput.addEventListener('focus', function() {
      if (state.searchResults.length > 0 || state.preBuiltResults.length > 0 || state.searchQuery.length >= 2) {
        renderDropdown();
      }
    });

    // Close dropdown on click outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-wrapper')) {
        closeDropdown();
      }
    });

    function performSearch(query) {
      // Search both pre-built sites and Google Places in parallel
      var sitesPromise = fetch('/api/sites/search?q=' + encodeURIComponent(query))
        .then(function(res) { return res.ok ? res.json() : { data: [] }; })
        .then(function(d) { return d.data || []; })
        .catch(function() { return []; });

      var placesPromise = fetch('/api/search/businesses?q=' + encodeURIComponent(query))
        .then(function(res) {
          if (!res.ok) throw new Error('Search failed');
          return res.json();
        })
        .then(function(d) { return d.data || d.results || d || []; })
        .catch(function() { return []; });

      Promise.all([sitesPromise, placesPromise])
        .then(function(results) {
          // Guard: if query changed while fetching, discard stale results
          if (state.searchQuery.trim().length < 2) {
            searchSpinner.classList.remove('visible');
            closeDropdown();
            return;
          }
          searchSpinner.classList.remove('visible');
          state.preBuiltResults = Array.isArray(results[0]) ? results[0] : [];
          state.searchResults = Array.isArray(results[1]) ? results[1] : [];
          renderDropdown();
        })
        .catch(function() {
          searchSpinner.classList.remove('visible');
          state.preBuiltResults = [];
          state.searchResults = [];
          renderDropdown();
        });
    }

    function renderDropdown() {
      var html = '';
      var preBuilt = state.preBuiltResults || [];

      // Pre-built sites first (already generated)
      for (var j = 0; j < preBuilt.length; j++) {
        var pb = preBuilt[j];
        html += '<div class="search-result search-result-prebuilt" onclick="selectPreBuilt(' + j + ')">'
              +   '<div class="search-result-icon" style="background:rgba(34,197,94,0.12)">'
              +     '<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
              +       '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
              +     '</svg>'
              +   '</div>'
              +   '<div class="search-result-text">'
              +     '<div class="search-result-name">' + escapeHtml(pb.business_name || pb.name || '') + ' <span style="display:inline-block;background:rgba(34,197,94,0.15);color:#22c55e;font-size:0.7rem;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;letter-spacing:0.03em">PRE-BUILT</span></div>'
              +     '<div class="search-result-address">' + escapeHtml(pb.business_address || pb.address || 'Ready to view') + '</div>'
              +   '</div>'
              + '</div>';
      }

      // Google Places results
      for (var i = 0; i < state.searchResults.length; i++) {
        var r = state.searchResults[i];
        html += '<div class="search-result" onclick="selectBusiness(' + i + ')">'
              +   '<div class="search-result-icon">'
              +     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
              +       '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>'
              +     '</svg>'
              +   '</div>'
              +   '<div class="search-result-text">'
              +     '<div class="search-result-name">' + escapeHtml(r.name || r.business_name || '') + '</div>'
              +     '<div class="search-result-address">' + escapeHtml(r.address || r.formatted_address || r.street_address || '') + '</div>'
              +   '</div>'
              + '</div>';
      }

      // Custom website option (always shown)
      html += '<div class="search-result search-result-custom" onclick="selectCustom()">'
            +   '<div class="search-result-icon">'
            +     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
            +       '<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>'
            +     '</svg>'
            +   '</div>'
            +   '<div class="search-result-text">'
            +     '<div class="search-result-name">Custom Website</div>'
            +     '<div class="search-result-address">Build a custom website from scratch</div>'
            +   '</div>'
            + '</div>';

      searchDropdown.innerHTML = html;
      searchDropdown.classList.add('open');
    }

    function closeDropdown() {
      searchDropdown.classList.remove('open');
    }

    /* ===========================================================
       Business Selection
       =========================================================== */
    function selectBusiness(index) {
      var biz = state.searchResults[index];
      state.selectedBusiness = biz;
      state.mode = 'business';
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('business_selected', { name: biz.name || biz.business_name });
      }

      // Check if a site already exists
      var placeId = biz.place_id || biz.id || '';
      if (!placeId) {
        navigateTo('signin');
        return;
      }

      showInlineLoading('search-error', 'Checking if a site exists...');

      fetch('/api/sites/lookup?place_id=' + encodeURIComponent(placeId))
        .then(function(res) {
          if (res.status === 404) return null;
          if (!res.ok) throw new Error('Lookup failed');
          return res.json();
        })
        .then(function(json) {
          hideMsg('search-error');
          var site = json && json.data ? json.data : json;
          if (!site || site.exists === false) {
            // No existing site -> sign in
            navigateTo('signin');
            return;
          }

          state.siteId = site.id || site.site_id;
          state.slug = site.slug;

          if (site.status === 'published' && site.slug) {
            // Redirect to the live site
            redirectTo('https://' + site.slug + '-sites.megabyte.space');
          } else if (site.status === 'queued' || site.status === 'building') {
            navigateTo('waiting');
          } else {
            navigateTo('signin');
          }
        })
        .catch(function(err) {
          hideMsg('search-error');
          // On error, just proceed to sign-in
          navigateTo('signin');
        });
    }

    function selectPreBuilt(index) {
      var site = state.preBuiltResults[index];
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('prebuilt_site_selected', { slug: site.slug, name: site.business_name });
      }

      // Redirect to the live site if published, or show waiting screen
      if (site.status === 'published' && site.slug) {
        redirectTo('https://' + site.slug + '-sites.megabyte.space');
      } else if (site.status === 'queued' || site.status === 'building') {
        state.siteId = site.id || site.site_id;
        state.slug = site.slug;
        navigateTo('waiting');
      } else {
        // Draft or other status - treat as new business selection
        state.selectedBusiness = {
          name: site.business_name,
          address: site.business_address || '',
          place_id: site.google_place_id || ''
        };
        state.mode = 'business';
        navigateTo('signin');
      }
    }

    function selectCustom() {
      state.selectedBusiness = null;
      state.mode = 'custom';
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('custom_website_selected');
      }

      navigateTo('signin');
    }

    /* ===========================================================
       Sign-In Logic
       =========================================================== */
    function showSigninPanel(panel) {
      state.signinPanel = panel;

      var methodsEl = document.getElementById('signin-methods');
      var phonePanel = document.getElementById('signin-phone-panel');
      var emailPanel = document.getElementById('signin-email-panel');
      var backToSearch = document.getElementById('signin-back-to-search');

      methodsEl.style.display = 'none';
      phonePanel.classList.remove('active');
      emailPanel.classList.remove('active');

      if (panel === 'main') {
        methodsEl.style.display = 'flex';
        backToSearch.style.display = '';
      } else if (panel === 'phone') {
        phonePanel.classList.add('active');
        backToSearch.style.display = 'none';
        document.getElementById('phone-input').focus();
      } else if (panel === 'email') {
        emailPanel.classList.add('active');
        backToSearch.style.display = 'none';
        document.getElementById('email-input').focus();
      }
    }

    // Reset panels whenever we navigate to signin
    var origNavigateTo = navigateTo;
    navigateTo = function(screen) {
      if (screen === 'signin') {
        setTimeout(function() { showSigninPanel('main'); }, 10);
      }
      if (screen === 'details') {
        updateDetailsScreen();
      }
      if (screen === 'waiting') {
        updateWaitingScreen();
      }
      origNavigateTo(screen);
    };

    function signInWithGoogle() {
      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('signin_google_clicked');
      }

      var redirectUrl = window.location.origin + window.location.pathname + '?auth_callback=google';
      redirectTo('/api/auth/google?redirect_url=' + encodeURIComponent(redirectUrl));
    }

    function sendPhoneOtp() {
      var phone = document.getElementById('phone-input').value.trim();
      if (!phone) {
        showMsg('phone-send-msg', 'error', 'Please enter your phone number.');
        return;
      }

      var btn = document.getElementById('phone-send-btn');
      btn.disabled = true;
      btn.innerHTML = 'Sending <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('phone-send-msg');

      fetch('/api/auth/phone/otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phone })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(d.error || 'Failed to send code'); });
          return res.json();
        })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = 'Send Verification Code';
          // Show OTP step
          document.getElementById('phone-step-input').style.display = 'none';
          document.getElementById('phone-step-otp').style.display = 'block';
          document.getElementById('otp-input').focus();
          state._phoneNumber = phone;
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Send Verification Code';
          showMsg('phone-send-msg', 'error', err.message || 'Failed to send verification code. Please try again.');
        });
    }

    function verifyPhoneOtp() {
      var code = document.getElementById('otp-input').value.trim();
      if (!code || code.length < 4) {
        showMsg('phone-verify-msg', 'error', 'Please enter the verification code.');
        return;
      }

      var btn = document.getElementById('otp-verify-btn');
      btn.disabled = true;
      btn.innerHTML = 'Verifying <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('phone-verify-msg');

      fetch('/api/auth/phone/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: state._phoneNumber, code: code })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(d.error || 'Invalid code'); });
          return res.json();
        })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = 'Verify Code';
          state.session = {
            token: data.token || data.access_token || '',
            identifier: state._phoneNumber
          };

          if (typeof posthog !== 'undefined' && posthog.capture) {
            posthog.capture('signin_phone_success');
          }

          navigateTo('details');
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Verify Code';
          showMsg('phone-verify-msg', 'error', err.message || 'Verification failed. Please try again.');
        });
    }

    function sendMagicLink() {
      var email = document.getElementById('email-input').value.trim();
      if (!email || !email.includes('@')) {
        showMsg('email-send-msg', 'error', 'Please enter a valid email address.');
        return;
      }

      var btn = document.getElementById('email-send-btn');
      btn.disabled = true;
      btn.innerHTML = 'Sending <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('email-send-msg');

      fetch('/api/auth/magic-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(d.error || 'Failed to send link'); });
          return res.json();
        })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = 'Send Magic Link';
          document.getElementById('email-step-input').style.display = 'none';
          document.getElementById('email-step-sent').style.display = 'block';

          // Store session for optimistic flow (real auth comes via redirect)
          state.session = {
            token: data.token || '',
            identifier: email
          };

          if (typeof posthog !== 'undefined' && posthog.capture) {
            posthog.capture('signin_email_sent', { email: email });
          }
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Send Magic Link';
          showMsg('email-send-msg', 'error', err.message || 'Failed to send magic link. Please try again.');
        });
    }

    /* ===========================================================
       Details Screen
       =========================================================== */
    function updateDetailsScreen() {
      var titleEl = document.getElementById('details-title');
      var subtitleEl = document.getElementById('details-subtitle');
      var badgeEl = document.getElementById('details-business-badge');

      if (state.mode === 'custom') {
        titleEl.textContent = 'Describe your custom website';
        subtitleEl.textContent = 'Tell us what you\'d like and we\'ll build it for you.';
        badgeEl.style.display = 'none';
      } else {
        titleEl.textContent = 'Tell us more about your business';
        subtitleEl.textContent = 'Any extra info helps us build the perfect website for you.';

        if (state.selectedBusiness) {
          var biz = state.selectedBusiness;
          document.getElementById('badge-biz-name').textContent = biz.name || biz.business_name || 'Selected Business';
          document.getElementById('badge-biz-addr').textContent = biz.address || biz.formatted_address || biz.street_address || '';
          badgeEl.style.display = 'flex';
        } else {
          badgeEl.style.display = 'none';
        }
      }
    }

    function initUppy() {
      if (typeof Uppy === 'undefined') {
        setTimeout(initUppy, 200);
        return;
      }

      var dashboardTarget = document.getElementById('uppy-dashboard-area');
      if (!dashboardTarget) return;

      uppyInstance = new Uppy.Uppy({
        restrictions: {
          maxFileSize: 10 * 1024 * 1024,
          maxNumberOfFiles: 5,
          allowedFileTypes: ['.jpg', '.jpeg', '.png', '.svg', '.webp', '.pdf']
        },
        autoProceed: false
      });

      uppyInstance.use(Uppy.Dashboard, {
        target: '#uppy-dashboard-area',
        inline: true,
        width: '100%',
        height: 220,
        hideUploadButton: true,
        proudlyDisplayPoweredByUppy: false,
        theme: 'dark',
        note: 'Images (JPG, PNG, SVG, WebP) and PDFs. Max 10MB each, up to 5 files.'
      });
    }

    function submitBuild() {
      var additionalContext = document.getElementById('details-textarea').value.trim();
      var btn = document.getElementById('build-btn');

      btn.disabled = true;
      btn.innerHTML = 'Building <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('build-msg');

      var payload = {
        mode: state.mode,
        additional_context: additionalContext
      };

      if (state.selectedBusiness) {
        payload.business = {
          name: state.selectedBusiness.name || state.selectedBusiness.business_name,
          address: state.selectedBusiness.address || state.selectedBusiness.formatted_address || state.selectedBusiness.street_address,
          place_id: state.selectedBusiness.place_id || state.selectedBusiness.id,
          phone: state.selectedBusiness.phone || state.selectedBusiness.phone_number,
          website: state.selectedBusiness.website,
          types: state.selectedBusiness.types
        };
      }

      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      fetch('/api/sites/create-from-search', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(d.error || 'Failed to create site'); });
          return res.json();
        })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          state.siteId = data.id || data.site_id;
          state.slug = data.slug;

          if (typeof posthog !== 'undefined' && posthog.capture) {
            posthog.capture('site_build_started', { mode: state.mode, site_id: state.siteId });
          }

          // Upload files if any
          if (uppyInstance && uppyInstance.getFiles().length > 0 && state.siteId) {
            uppyInstance.use(Uppy.XHRUpload, {
              endpoint: '/api/sites/' + state.siteId + '/uploads',
              headers: headers,
              fieldName: 'file',
              formData: true
            });
            uppyInstance.upload().then(function() {
              navigateTo('waiting');
            }).catch(function() {
              // Even if upload fails, proceed to waiting
              navigateTo('waiting');
            });
          } else {
            navigateTo('waiting');
          }
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          showMsg('build-msg', 'error', err.message || 'Something went wrong. Please try again.');
        });
    }

    /* ===========================================================
       Waiting Screen
       =========================================================== */
    function updateWaitingScreen() {
      var contactEl = document.getElementById('waiting-contact');
      if (state.session && state.session.identifier) {
        contactEl.textContent = 'Signed in as ' + state.session.identifier;
      } else {
        contactEl.textContent = '';
      }
    }

    function startPolling() {
      stopPolling();
      if (!state.siteId) return;

      pollTimer = setInterval(function() {
        var headers = {};
        if (state.session && state.session.token) {
          headers['Authorization'] = 'Bearer ' + state.session.token;
        }

        fetch('/api/sites/' + state.siteId, { headers: headers })
          .then(function(res) {
            if (!res.ok) return null;
            return res.json();
          })
          .then(function(site) {
            if (!site) return;
            if (site.status === 'published' && (site.slug || state.slug)) {
              stopPolling();
              var slug = site.slug || state.slug;
              redirectTo('https://' + slug + '-sites.megabyte.space');
            }
          })
          .catch(function() {
            // Silently continue polling
          });
      }, 10000);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    /* ===========================================================
       Message Helpers
       =========================================================== */
    function showMsg(id, type, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.className = 'msg msg-' + type + ' visible';
      el.textContent = text;
    }

    function hideMsg(id) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('visible');
    }

    function showInlineLoading(id, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.className = 'msg msg-info visible';
      el.innerHTML = text + ' <span class="loading-dots"><span></span><span></span><span></span></span>';
    }

    /* ===========================================================
       Utilities
       =========================================================== */
    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    /* ===========================================================
       Handle Auth Callback
       =========================================================== */
    (function handleAuthCallback() {
      var params = new URLSearchParams(window.location.search);

      if (params.has('auth_callback') || params.has('token') || params.has('access_token')) {
        var token = params.get('token') || params.get('access_token') || '';
        var email = params.get('email') || '';
        var phone = params.get('phone') || '';

        if (token) {
          state.session = {
            token: token,
            identifier: email || phone || 'Authenticated'
          };

          // Clean URL
          var cleanUrl = window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);

          // Restore any selected business from sessionStorage
          var savedBiz = sessionStorage.getItem('ps_selected_business');
          var savedMode = sessionStorage.getItem('ps_mode');
          if (savedBiz) {
            try {
              state.selectedBusiness = JSON.parse(savedBiz);
              state.mode = savedMode || 'business';
            } catch (e) { /* ignore */ }
            sessionStorage.removeItem('ps_selected_business');
            sessionStorage.removeItem('ps_mode');
          }

          navigateTo('details');
        }
      }
    })();

    // Save business selection before Google redirect
    var origSignInWithGoogle = signInWithGoogle;
    signInWithGoogle = function() {
      if (state.selectedBusiness) {
        sessionStorage.setItem('ps_selected_business', JSON.stringify(state.selectedBusiness));
        sessionStorage.setItem('ps_mode', state.mode);
      }
      origSignInWithGoogle();
    };

    /* ===========================================================
       Keyboard: Enter to select first result
       =========================================================== */
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDropdown();
        searchInput.blur();
      }
    });

    /* ===========================================================
       Init
       =========================================================== */
    render();
  </script>
</body>
</html>
