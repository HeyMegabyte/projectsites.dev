<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T48Z6BJJ');</script>
  <!-- End Google Tag Manager -->
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VBBRRQLDFT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VBBRRQLDFT');
  </script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>Project Sites - Your Website, Handled. Finally.</title>
  <meta name="description" content="AI-powered websites for small businesses. Search for your business and get a professional site in minutes.">
  <meta name="keywords" content="AI website builder, small business websites, professional site generator, automated web design, business website, project sites, megabyte labs">
  <meta name="author" content="Brian Zalewski">
  <meta name="copyright" content="Megabyte LLC">
  <meta name="robots" content="index, follow">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta name="format-detection" content="telephone=no">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="400">
  <meta name="contact" content="hey@megabyte.space">
  <meta property="fb:app_id" content="669135071652897">
  <meta name="x-rim-auto-match" content="none">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous">
  <meta name="geography" content="USA">
  <meta itemprop="image" content="https://sites.megabyte.space/icon-512.png">

  <!-- Favicons & App Icons -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/svg+xml" href="/logo-icon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/icon-180.png">
  <link rel="mask-icon" href="/logo-icon.svg" color="#50a5db">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Mobile Web App -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Project Sites">
  <meta name="application-name" content="Project Sites">

  <!-- Microsoft -->
  <meta name="msapplication-TileColor" content="#0a0a1a">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="msapplication-starturl" content="https://sites.megabyte.space">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="msapplication-tooltip" content="Project Sites: AI-powered websites for small businesses">
  <meta name="msapplication-task" content="name=Home;action-uri=https://sites.megabyte.space;icon-uri=https://sites.megabyte.space/favicon.ico">
  <meta name="theme-color" content="#0a0a1a">

  <!-- Open Graph -->
  <meta property="og:site_name" content="Project Sites">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Project Sites - Your Website, Handled. Finally.">
  <meta property="og:description" content="AI-powered websites for small businesses. Search for your business and get a professional site in minutes.">
  <meta property="og:image" content="https://sites.megabyte.space/icon-512.png">
  <meta property="og:url" content="https://sites.megabyte.space/">
  <meta property="al:web:url" content="https://sites.megabyte.space/">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@MegabyteLabs">
  <meta name="twitter:creator" content="@MegabyteLabs">
  <meta name="twitter:title" content="Project Sites - Your Website, Handled. Finally.">
  <meta name="twitter:description" content="AI-powered websites for small businesses. Search for your business and get a professional site in minutes.">
  <meta name="twitter:image" content="https://sites.megabyte.space/icon-512.png">

  <!-- Canonical -->
  <link rel="canonical" href="https://sites.megabyte.space/">

  <!-- JSON-LD: WebSite -->
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@id": "https://sites.megabyte.space/#schema-website",
    "@type": "WebSite",
    "encoding": "UTF-8",
    "image": {
      "@type": "ImageObject",
      "@id": "https://sites.megabyte.space/#schema-site-logo",
      "url": "https://sites.megabyte.space/icon-512.png",
      "height": 512,
      "width": 512
    },
    "name": "Project Sites",
    "publisher": "Megabyte Labs",
    "url": "https://sites.megabyte.space",
    "potentialActions": {
      "@type": "SearchAction",
      "target": "https://sites.megabyte.space/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <!-- JSON-LD: SoftwareApplication -->
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": ["SoftwareApplication", "WebApplication"],
    "browserRequirements": ["HTML5", "CSS3", "JavaScript", "Modern Browser"],
    "name": "Project Sites",
    "applicationSuite": "Megabyte Labs",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": [
      "AI-powered website generation for small businesses",
      "Search for your business and get a professional site in minutes",
      "Custom domain support with automatic SSL",
      "Built-in SEO optimization and performance tuning",
      "Stripe-powered billing and subscription management",
      "Google Places integration for business discovery"
    ],
    "softwareVersion": "1.0.0",
    "thumbnailUrl": "https://sites.megabyte.space/icon-180.png",
    "copyrightYear": 2026,
    "copyrightHolder": "Megabyte LLC",
    "creator": "Brian Zalewski"
  }
  </script>

  <!-- JSON-LD: Organization -->
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": "Megabyte Labs",
    "legalName": "Megabyte LLC",
    "email": "hey@megabyte.space",
    "url": "https://megabyte.space",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sites.megabyte.space/icon-180.png"
    },
    "image": "https://sites.megabyte.space/icon-512.png",
    "founder": "Brian Zalewski",
    "foundingDate": "2022-10-29",
    "telephone": "+1-424-373-7371",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "US",
      "addressLocality": "Morristown",
      "addressRegion": "New Jersey",
      "postalCode": "07960",
      "streetAddress": "63 James Street"
    },
    "sameAs": [
      "https://github.com/HeyMegabyte",
      "https://gitlab.com/megabyte-labs",
      "https://linkedin.com/company/megabyte-labs",
      "https://www.youtube.com/@HeyMegabyte",
      "https://x.com/HeyMegabyte",
      "https://www.instagram.com/heymegabyteofficial/",
      "https://www.facebook.com/HeyMegabyte"
    ]
  }
  </script>

  <!-- Preconnect to key CDNs -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://us.i.posthog.com">

  <!-- Stylesheets -->
  <link href="https://releases.transloadit.com/uppy/v4.12.1/uppy.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

    /* ======================================================
       CSS Custom Properties
       ====================================================== */
    :root {
      --bg-primary: #0a0a1a;
      --bg-secondary: #111128;
      --bg-card: #161635;
      --bg-card-hover: #1c1c45;
      --bg-input: #0f0f2a;
      --accent: #50a5db;
      --accent-dim: rgba(80, 165, 219, 0.12);
      --accent-glow: rgba(80, 165, 219, 0.25);
      --secondary: #7c3aed;
      --secondary-dim: rgba(124, 58, 237, 0.15);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: rgba(80, 165, 219, 0.1);
      --border-hover: rgba(80, 165, 219, 0.3);
      --error: #ef4444;
      --error-dim: rgba(239, 68, 68, 0.12);
      --success: #22c55e;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
      --shadow-accent: 0 0 30px rgba(80, 165, 219, 0.15);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    html { scroll-behavior: smooth; height: 100%; }

    /* Center-out underline hover animation for links */
    a:not(.btn):not(.logo):not(.modal-close):not(.details-modal-close):not(.back-link):not(.domain-tab):not(.header-auth-btn):not(.signin-btn):not(.site-card-btn):not(.hostname-delete-btn):not(.dc-btn):not(.hostname-chip-setprimary):not(.topbar-cta):not([class*="btn"]) {
      position: relative;
      text-decoration: none;
    }
    a:not(.btn):not(.logo):not(.modal-close):not(.details-modal-close):not(.back-link):not(.domain-tab):not(.header-auth-btn):not(.signin-btn):not(.site-card-btn):not(.hostname-delete-btn):not(.dc-btn):not(.hostname-chip-setprimary):not(.topbar-cta):not([class*="btn"])::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 1px;
      background: currentColor;
      transition: width 0.3s ease, left 0.3s ease;
    }
    a:not(.btn):not(.logo):not(.modal-close):not(.details-modal-close):not(.back-link):not(.domain-tab):not(.header-auth-btn):not(.signin-btn):not(.site-card-btn):not(.hostname-delete-btn):not(.dc-btn):not(.hostname-chip-setprimary):not(.topbar-cta):not([class*="btn"]):hover::after {
      width: 100%;
      left: 0;
    }
    @media (prefers-reduced-motion: reduce) {
      a::after { transition: none !important; }
    }

    body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ======================================================
       Scrollbar
       ====================================================== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-card); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

    /* ======================================================
       Animations
       ====================================================== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    @keyframes ripple-expand {
      0% { transform: scale(0); opacity: 0.5; }
      100% { transform: scale(4); opacity: 0; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes orbFloat1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(60px, -40px) scale(1.1); }
      66% { transform: translate(-30px, 30px) scale(0.95); }
    }
    @keyframes orbFloat2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(-50px, 50px) scale(0.9); }
      66% { transform: translate(40px, -20px) scale(1.05); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0); opacity: 0; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Respect user's reduced-motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* ======================================================
       Header / Nav
       ====================================================== */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      background: rgba(10, 10, 26, 0.88);
      backdrop-filter: blur(24px);
      border-bottom: 1px solid rgba(80, 165, 219, 0.06);
      box-shadow: 0 1px 12px rgba(0, 0, 0, 0.2);
    }
    .header-inner {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      text-decoration: none;
      cursor: pointer;
    }
    .logo img { flex-shrink: 0; }

    .header-auth {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-auth-user {
      color: rgba(255,255,255,0.7);
      font-size: 0.85rem;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .header-auth-btn {
      padding: 6px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--accent);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, opacity 0.2s, box-shadow 0.2s;
      white-space: nowrap;
    }
    .header-auth-btn:hover {
      background: rgba(100, 255, 218, 0.1);
      border-color: var(--accent);
    }
    .header-auth-btn:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-dim);
    }
    .header-auth-btn:active {
      opacity: 0.7;
    }

    /* ======================================================
       Admin Dashboard Panel
       ====================================================== */
    .admin-panel {
      display: none;
      background: linear-gradient(160deg, rgba(15, 15, 35, 0.95), rgba(10, 10, 26, 0.98));
      border-bottom: 1px solid rgba(80, 165, 219, 0.06);
      margin-top: 60px;
      padding: 28px 0;
      min-height: 500px;
      animation: fadeIn 0.3s ease;
      position: relative;
      z-index: 999;
    }
    .admin-panel.visible { display: block; }
    .admin-panel-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .admin-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .admin-panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-panel-title svg { color: var(--accent); }
    .admin-panel-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .admin-btn {
      padding: 8px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, background 0.2s, opacity 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .admin-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(80, 165, 219, 0.06);
      box-shadow: 0 2px 8px rgba(80, 165, 219, 0.1);
    }
    .admin-btn:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }
    .admin-btn:active {
      opacity: 0.7;
    }
    .admin-btn-accent {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Site Cards Grid */
    .site-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
    }
    .site-card {
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.75), rgba(15, 15, 42, 0.95));
      border: 1px solid rgba(80, 165, 219, 0.08);
      border-radius: 16px;
      padding: 18px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(6px);
    }
    .site-card:hover {
      border-color: rgba(80, 165, 219, 0.25);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 24px rgba(80, 165, 219, 0.08);
      transform: translateY(-3px);
    }
    .site-card-preview {
      width: 100%;
      height: 140px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.06), rgba(124, 58, 237, 0.08));
      overflow: hidden;
      position: relative;
    }
    .site-card-preview iframe {
      width: 1440px;
      height: 900px;
      transform-origin: top left;
      pointer-events: none;
      border: none;
      position: absolute;
      top: 0;
      left: 0;
    }
    .site-card-preview-placeholder {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .site-card-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--font);
      letter-spacing: normal;
      line-height: 1.5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Title edit wrap inherits same font as .site-card-name so input matches */
    .site-card-title-row .inline-edit-wrap {
      font-size: 0.9rem;
      font-weight: 600;
      font-family: var(--font);
      letter-spacing: normal;
      line-height: 1.5;
      color: var(--text-primary);
    }
    .site-card-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      width: fit-content;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .site-card-status.published { background: rgba(34, 197, 94, 0.12); color: #22c55e; }
    .site-card-status.building, .site-card-status.queued { background: rgba(251, 191, 36, 0.12); color: #fbbf24; }
    .site-card-status.collecting { background: rgba(80, 165, 219, 0.12); color: var(--accent); }
    .site-card-status.generating { background: rgba(124, 58, 237, 0.12); color: #a78bfa; }
    .site-card-status.uploading { background: rgba(34, 197, 94, 0.12); color: #4ade80; }
    .site-card-status.error, .site-card-status.failed { background: rgba(239, 68, 68, 0.12); color: #ef4444; }
    .site-card-status.draft { background: rgba(148, 163, 184, 0.12); color: #94a3b8; }
    /* Status + title row */
    .site-card-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }
    .site-card-domain {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .site-card-domain a {
      color: var(--accent);
      text-decoration: none;
    }
    .site-card-domain a:hover { text-decoration: underline; }
    .site-card-actions {
      display: flex;
      gap: 6px;
      margin-top: auto;
    }
    .site-card-btn {
      flex: 1;
      padding: 7px 0;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-align: center;
    }
    .site-card-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(80, 165, 219, 0.08);
      box-shadow: 0 2px 10px rgba(80, 165, 219, 0.14);
    }
    .site-card-btn:focus-visible {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim), 0 0 12px rgba(80, 165, 219, 0.1);
    }
    .site-card-btn:focus:not(:focus-visible) { outline: none; }
    .site-card-btn:active {
      background: rgba(80, 165, 219, 0.14);
      border-color: #4ecdc4;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.15);
      transition-duration: 0.08s;
    }
    .site-card-btn.danger:hover {
      border-color: var(--error);
      color: var(--error);
      background: rgba(239, 68, 68, 0.06);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.12);
    }
    .site-card-btn.danger:focus-visible {
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
    }
    .site-card-btn.danger:active {
      background: rgba(239, 68, 68, 0.14);
      border-color: #dc2626;
    }
    /* Dropdown button group */
    .site-card-dropdown-wrap {
      position: relative;
      flex: 1;
      display: flex;
    }
    .site-card-dropdown-wrap .site-card-btn {
      border-radius: 6px;
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .site-card-dropdown-wrap .site-card-btn svg.dd-chevron {
      opacity: 0.5;
      transition: transform 0.2s, opacity 0.2s;
    }
    .site-card-dropdown-wrap .site-card-btn:hover svg.dd-chevron { opacity: 1; }
    .site-card-dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0; right: 0;
      background: rgba(15, 15, 42, 0.98);
      border: 1px solid var(--border-hover);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      z-index: 200;
      overflow: hidden;
      min-width: 140px;
    }
    .site-card-dropdown-menu.open { display: block; animation: fadeInScale 0.15s ease-out; }
    .site-card:has(.site-card-dropdown-menu.open) { z-index: 201; position: relative; }
    .site-card-dropdown-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      font-size: 0.72rem;
      color: var(--text-secondary);
      cursor: pointer;
      background: none; border: none; width: 100%;
      text-align: left;
      transition: background 0.15s, color 0.15s;
    }
    .site-card-dropdown-item:hover {
      background: rgba(80,165,219,0.08);
      color: var(--accent);
    }
    .site-card-dropdown-item.danger-item:hover {
      background: rgba(239,68,68,0.08);
      color: var(--error);
    }
    .site-card-dropdown-item svg { flex-shrink: 0; opacity: 0.7; }

    /* New Site Card */
    .site-card-new {
      background: transparent;
      border: 2px dashed rgba(80, 165, 219, 0.15);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: border-color 0.25s ease, background 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 200px;
    }
    .site-card-new:hover {
      border-color: var(--accent);
      background: rgba(80, 165, 219, 0.04);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(80, 165, 219, 0.06);
    }
    .site-card-new:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }
    .site-card-new:active {
      background: rgba(100, 255, 218, 0.06);
      box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.3);
    }
    .site-card-new svg { color: var(--text-muted); transition: color 0.2s; }
    .site-card-new:hover svg { color: var(--accent); }
    .site-card-new span { color: var(--text-muted); font-size: 0.85rem; transition: color 0.2s; }
    .site-card-new:hover span { color: var(--accent); }

    /* Domain Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      isolation: isolate;
      pointer-events: auto;
      /* Prevent flicker: force GPU compositing layer for the overlay */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    .modal-overlay.visible { display: flex; animation: fadeIn 0.15s ease; }
    .modal-overlay > .modal,
    .modal-overlay > .logs-modal,
    .modal-overlay > div {
      position: relative;
      z-index: 1001;
      /* Ensure modal content is on its own compositing layer to prevent repaints */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
    .modal {
      background: linear-gradient(150deg, rgba(22, 22, 53, 0.98), rgba(12, 12, 38, 1));
      border: 1px solid rgba(80, 165, 219, 0.1);
      border-radius: 22px;
      padding: 28px;
      max-width: 720px;
      width: 95%;
      max-height: 90vh;
      min-height: 0;
      overflow-y: auto;
      animation: fadeInScale 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55), 0 0 0 1px rgba(80, 165, 219, 0.06), 0 0 80px rgba(80, 165, 219, 0.03), inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }
    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-close {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 1.2rem;
      line-height: 1;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .modal-close:hover { color: var(--text-primary); background: rgba(239, 68, 68, 0.08); border-color: rgba(239, 68, 68, 0.2); }
    .modal-close:focus { outline: none; color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); }
    .modal-close:active { opacity: 0.6; transition: opacity 0.06s; }

    /* Site Logs Modal â€” Timeline Design */
    .logs-modal { max-width: 840px; width: 95%; max-height: 90vh; padding: 24px; border-radius: 20px; }
    .logs-container {
      background: rgba(6, 6, 18, 0.85);
      border: 1px solid rgba(80, 165, 219, 0.06);
      border-radius: 12px;
      padding: 0;
      max-height: 65vh;
      overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace;
      font-size: 0.72rem;
      line-height: 1.5;
    }
    .logs-container::-webkit-scrollbar { width: 5px; }
    .logs-container::-webkit-scrollbar-track { background: transparent; }
    .logs-container::-webkit-scrollbar-thumb { background: rgba(80, 165, 219, 0.15); border-radius: 3px; }
    .logs-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    .log-entry {
      display: grid;
      grid-template-columns: 3px 28px 1fr;
      gap: 0;
      padding: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.025);
      align-items: stretch;
      transition: background 0.12s;
    }
    .log-entry:hover { background: rgba(80, 165, 219, 0.025); }
    .log-entry:last-child { border-bottom: none; }
    .log-edge {
      border-radius: 2px 0 0 2px;
    }
    .log-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 2px;
      opacity: 0.7;
    }
    .log-body {
      padding: 7px 12px 7px 6px;
      min-width: 0;
    }
    .log-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    .log-action {
      font-weight: 600;
      font-size: 0.72rem;
      white-space: nowrap;
    }
    .log-ts {
      color: rgba(148,163,184,0.5);
      font-size: 0.62rem;
      white-space: nowrap;
      margin-left: auto;
    }
    .log-meta {
      color: rgba(148,163,184,0.55);
      font-size: 0.65rem;
      margin-top: 2px;
      word-break: break-word;
      line-height: 1.4;
    }
    .log-meta code {
      background: rgba(80, 165, 219, 0.08);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 0.63rem;
    }
    /* Log colors by category */
    .log-c-green .log-edge { background: #22c55e; }
    .log-c-green .log-action { color: #22c55e; }
    .log-c-red .log-edge { background: #ef4444; }
    .log-c-red .log-action { color: #ef4444; }
    .log-c-blue .log-edge { background: #3b82f6; }
    .log-c-blue .log-action { color: #3b82f6; }
    .log-c-amber .log-edge { background: #f59e0b; }
    .log-c-amber .log-action { color: #f59e0b; }
    .log-c-purple .log-edge { background: #8b5cf6; }
    .log-c-purple .log-action { color: #8b5cf6; }
    .log-c-cyan .log-edge { background: #06b6d4; }
    .log-c-cyan .log-action { color: #06b6d4; }
    .log-c-muted .log-edge { background: rgba(148,163,184,0.3); }
    .log-c-muted .log-action { color: var(--text-secondary); }
    .logs-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }
    .logs-toolbar .logs-count {
      font-size: 0.72rem;
      color: var(--text-muted);
    }
    .logs-toolbar .logs-refresh-btn {
      background: transparent;
      border: none;
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      line-height: 0;
      transition: color 0.2s, background 0.2s;
    }
    .logs-toolbar .logs-refresh-btn:hover { color: var(--accent); background: rgba(80,165,219,0.08); }

    .hostname-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .hostname-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(80, 165, 219, 0.08);
      border-radius: 12px;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .hostname-item:hover {
      border-color: rgba(80, 165, 219, 0.18);
      background: rgba(80, 165, 219, 0.04);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.18);
    }
    .hostname-item-name {
      font-size: 0.85rem;
      color: var(--text-primary);
    }
    .hostname-item-name a { color: var(--accent); text-decoration: none; transition: color 0.2s; }
    .hostname-item-name a:hover { text-decoration: underline; color: #4ecdc4; }
    .hostname-item-type {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .hostname-delete-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: color 0.2s, background 0.2s;
    }
    .hostname-delete-btn:hover { color: var(--error); background: rgba(239, 68, 68, 0.08); }
    .hostname-add-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .hostname-add-form input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(80, 165, 219, 0.12);
      background: linear-gradient(145deg, rgba(10, 10, 26, 0.8), rgba(15, 15, 42, 0.6));
      color: var(--text-primary);
      font-size: 0.88rem;
      font-family: var(--font);
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .hostname-add-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(80, 165, 219, 0.08);
    }
    .hostname-add-form button {
      padding: 12px 22px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.25), rgba(124, 58, 237, 0.18));
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.3s, box-shadow 0.3s, transform 0.15s;
    }
    .hostname-add-form button:hover { background: linear-gradient(135deg, rgba(80, 165, 219, 0.35), rgba(124, 58, 237, 0.28)); box-shadow: 0 4px 16px rgba(80, 165, 219, 0.2); transform: translateY(-1px); }
    .hostname-add-form button:active { transform: translateY(0) scale(0.98); }

    /* Billing info row */
    /* Per-site plan badge */
    .site-card-plan-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .plan-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .plan-badge.free { background: rgba(148, 163, 184, 0.15); color: #94a3b8; cursor: pointer; transition: background 0.2s, color 0.2s; }
    .plan-badge.free:hover { background: rgba(148, 163, 184, 0.25); color: #cbd5e1; }
    .plan-badge.free:focus { outline: none; box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.3); }
    .plan-badge.free:active { opacity: 0.7; }
    .plan-badge.paid { background: rgba(100, 255, 218, 0.15); color: var(--accent); cursor: default; }
    .plan-badge.paid:hover { background: rgba(100, 255, 218, 0.22); }
    .plan-badge.paid:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-dim); }
    .site-card-upgrade-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 2px solid var(--accent);
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.15), rgba(124, 58, 237, 0.1));
      color: var(--accent);
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      animation: upgradeGlow 2s ease-in-out infinite;
    }
    .site-card-upgrade-btn:hover {
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.25), rgba(124, 58, 237, 0.2));
      box-shadow: 0 0 20px rgba(80, 165, 219, 0.35), 0 0 40px rgba(80, 165, 219, 0.15);
      transform: translateY(-1px);
    }
    .site-card-upgrade-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(80, 165, 219, 0.25);
    }
    .site-card-upgrade-btn:active {
      filter: brightness(0.9);
      box-shadow: 0 0 0 3px rgba(80, 165, 219, 0.4);
    }
    @keyframes upgradeGlow {
      0%, 100% { box-shadow: 0 0 8px rgba(80, 165, 219, 0.15); }
      50% { box-shadow: 0 0 16px rgba(80, 165, 219, 0.3), 0 0 32px rgba(124, 58, 237, 0.1); }
    }

    .admin-site-count {
      font-size: 0.7rem;
      background: rgba(100, 255, 218, 0.1);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
    }
    .admin-site-count.loaded { display: inline-block; }
    .credits-pill {
      font-size: 0.65rem;
      background: rgba(124, 58, 237, 0.15);
      color: #a78bfa;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    .admin-sites-usage {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .site-card-url-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .site-card-copy-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 2px;
      transition: color 0.2s;
      flex-shrink: 0;
    }
    .site-card-copy-btn:hover { color: var(--accent); }
    .site-card-copy-btn:focus { outline: none; color: var(--accent); }
    .site-card-copy-btn:active { color: #4ecdc4; }
    .site-card-copy-btn.copied { color: #22c55e; }
    .copy-toast {
      position: absolute;
      bottom: calc(100% + 6px);
      right: 0;
      background: rgba(34, 197, 94, 0.95);
      color: #fff;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px);
      animation: toast-pop 1.4s ease forwards;
      z-index: 10;
    }
    @keyframes toast-pop {
      0% { opacity: 0; transform: translateY(4px); }
      15% { opacity: 1; transform: translateY(0); }
      75% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-4px); }
    }
    .site-card-date {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      opacity: 0.6;
    }
    .site-card-date-modified {
      text-align: right;
    }
    .admin-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Domain Summary Bar */
    .domain-summary-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.6), rgba(15, 15, 42, 0.8));
      border: 1px solid rgba(80, 165, 219, 0.08);
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .domain-summary-bar .domain-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .domain-stat-value {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    .domain-stat-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }
    .domain-stat-dot.active { background: var(--success); }
    .domain-stat-dot.pending { background: #fbbf24; }
    .domain-stat-dot.failed { background: var(--error); }

    @media (max-width: 600px) {
      .site-grid { grid-template-columns: 1fr; gap: 10px; }
      .admin-panel-header { flex-direction: column; align-items: flex-start; }
      .admin-panel-actions { width: 100%; }
      .domain-summary-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
    }

    /* ======================================================
       Build Terminal (Waiting Screen)
       ====================================================== */
    .build-terminal {
      margin-top: 28px;
      background: #0d0d1f;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      text-align: left;
      min-width: min(500px, 100%);
      max-width: 600px;
      max-height: 270px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    .build-terminal-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(80, 165, 219, 0.06);
    }
    .build-terminal-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .build-terminal-dot.red { background: #ef4444; }
    .build-terminal-dot.yellow { background: #fbbf24; }
    .build-terminal-dot.green { background: #22c55e; }
    .build-terminal-title {
      flex: 1;
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    }
    .build-terminal-body {
      padding: 12px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 0.75rem;
      line-height: 1.8;
    }
    .build-terminal-line {
      color: var(--text-muted);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .build-terminal-line.active {
      color: var(--accent);
    }
    .build-terminal-line.done {
      color: var(--success);
    }
    .build-terminal-line.error {
      color: var(--error);
    }
    .build-terminal-line.done::before {
      content: '\2713 ';
      color: var(--success);
      margin-right: 8px;
    }
    .build-terminal-line.active::before {
      content: '\25B6 ';
      color: var(--accent);
      animation: pulse 1.5s ease-in-out infinite;
      margin-right: 8px;
    }
    .build-terminal-line.pending {
      color: var(--text-muted);
      opacity: 0.5;
    }
    .build-terminal-line.pending::before {
      content: '\25CB ';
      margin-right: 8px;
    }
    .build-terminal-line.error::before {
      content: '\2717 ';
      color: var(--error);
      margin-right: 8px;
    }
    .build-terminal-line.info {
      color: #94a3b8;
      font-size: 0.68rem;
      padding-left: 22px;
    }

    /* ======================================================
       Edit Site Modal
       ====================================================== */
    /* Inline editable fields on site cards */
    .inline-edit-wrap {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      min-height: 26px;
      max-width: 100%;
    }
    .inline-edit-wrap .inline-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: default;
    }
    /* Fixed-width action zone: same space for edit icon vs save/cancel */
    .inline-edit-actions {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      min-width: 34px;
      flex-shrink: 0;
      gap: 2px;
    }
    .inline-edit-wrap .inline-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      padding: 2px;
      flex-shrink: 0;
      opacity: 0.85;
      transition: opacity 0.2s, color 0.2s, transform 0.15s;
      line-height: 1;
    }
    .inline-edit-wrap .inline-edit-btn:hover {
      opacity: 1;
      color: #4ecdc4;
    }
    .inline-edit-wrap .inline-edit-btn:focus {
      outline: none;
      opacity: 1;
      color: var(--accent);
    }
    .inline-edit-wrap .inline-edit-btn:active {
      opacity: 0.7;
      transition-duration: 0.06s;
    }
    .inline-edit-wrap .inline-input {
      flex: 0 1 auto;
      min-width: 60px;
      max-width: 220px;
      padding: 0;
      margin: 0;
      border: none;
      border-radius: 0;
      background: transparent;
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
      font-family: inherit;
      font-style: inherit;
      letter-spacing: inherit;
      line-height: inherit;
      word-spacing: inherit;
      text-transform: inherit;
      outline: none;
      box-shadow: none;
      caret-color: var(--accent);
    }
    .inline-edit-wrap .inline-input.slug-input,
    .inline-slug-url .inline-input.slug-input {
      /* Inherit everything from parent for perfect style match */
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      font-style: inherit;
      letter-spacing: inherit;
      line-height: inherit;
      word-spacing: inherit;
      text-transform: inherit;
      text-decoration: underline;
      text-decoration-style: solid;
      text-decoration-color: currentColor;
      text-underline-offset: 2px;
      text-decoration-thickness: 1px;
      background: transparent;
      color: inherit;
      border: none;
      border-radius: 0;
      outline: none;
      box-shadow: none;
      padding: 0;
      margin: 0;
      caret-color: var(--accent);
    }
    .inline-edit-wrap .inline-save-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #22c55e;
      padding: 1px;
      margin: 0;
      flex-shrink: 0;
      transition: color 0.2s;
      line-height: 1;
    }
    .inline-edit-wrap .inline-save-btn:hover { color: #16a34a; }
    .inline-edit-wrap .inline-save-btn:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
      opacity: 0.4;
    }
    .inline-edit-wrap .inline-cancel-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #ef4444;
      padding: 1px;
      margin: 0;
      flex-shrink: 0;
      transition: color 0.2s;
      line-height: 1;
    }
    .inline-edit-wrap .inline-cancel-btn:hover { color: #dc2626; }
    .inline-edit-wrap.inline-edit-inline {
      display: inline-flex;
      gap: 1px;
      min-height: auto;
      vertical-align: baseline;
    }
    .inline-edit-wrap.inline-edit-inline .slug-editable {
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      font-style: inherit;
      letter-spacing: inherit;
      line-height: inherit;
      word-spacing: inherit;
      text-transform: inherit;
      color: inherit;
      cursor: text;
      text-decoration: underline;
      text-decoration-style: solid;
      text-decoration-color: currentColor;
      text-underline-offset: 2px;
      text-decoration-thickness: 1px;
      transition: color 0.15s, text-decoration-color 0.15s;
    }
    .inline-edit-wrap.inline-edit-inline .slug-editable:hover {
      color: #4ecdc4;
      text-decoration-color: #4ecdc4;
    }
    .inline-edit-wrap.inline-edit-inline .inline-input {
      display: inline;
      width: auto;
      min-width: 40px;
      max-width: 160px;
      padding: 0;
      margin: 0;
      font-size: inherit;
      font-family: inherit;
      font-weight: inherit;
      font-style: inherit;
      letter-spacing: inherit;
      line-height: inherit;
      word-spacing: inherit;
      text-transform: inherit;
      vertical-align: baseline;
      border: none;
      border-radius: 0;
      background: transparent;
      color: inherit;
      outline: none;
      box-shadow: none;
      text-decoration: underline;
      text-decoration-style: solid;
      text-decoration-color: currentColor;
      text-underline-offset: 2px;
      text-decoration-thickness: 1px;
      caret-color: var(--accent);
    }
    .inline-edit-wrap.inline-edit-inline .inline-save-btn,
    .inline-edit-wrap.inline-edit-inline .inline-cancel-btn {
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
      padding: 0 1px;
      background: transparent;
      border: none;
      outline: none;
      box-shadow: none;
    }
    .inline-edit-wrap.inline-edit-inline .inline-save-btn:focus,
    .inline-edit-wrap.inline-edit-inline .inline-cancel-btn:focus {
      outline: none;
      box-shadow: none;
    }
    /* Fixed-width action zone for slug edit icons */
    .inline-slug-actions {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      min-width: 34px;
      flex-shrink: 0;
      gap: 2px;
      vertical-align: middle;
    }
    .inline-slug-actions .inline-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      padding: 0 1px;
      opacity: 0.7;
      transition: opacity 0.2s, color 0.2s;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
    }
    .inline-slug-actions .inline-edit-btn:hover { opacity: 1; color: #4ecdc4; }
    .inline-slug-actions .inline-edit-btn:focus { outline: none; }
    .inline-slug-url {
      font-size: 0.78rem;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      letter-spacing: normal;
      font-weight: normal;
      transition: color 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    /* Save/cancel buttons when inside slug URL */
    .inline-slug-url .inline-save-btn,
    .inline-slug-url .inline-cancel-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 1px;
      margin: 0;
      flex-shrink: 0;
      transition: color 0.2s, opacity 0.15s;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
      text-decoration: none;
    }
    .inline-slug-url .inline-save-btn { color: #22c55e; }
    .inline-slug-url .inline-save-btn:hover { color: #16a34a; }
    .inline-slug-url .inline-cancel-btn { color: #ef4444; }
    .inline-slug-url .inline-cancel-btn:hover { color: #dc2626; }
    .inline-slug-url .inline-save-btn:focus,
    .inline-slug-url .inline-cancel-btn:focus {
      outline: none;
      box-shadow: none;
    }
    .inline-slug-url.status-default { color: var(--accent); }
    .inline-slug-url.status-available { color: #22c55e; }
    .inline-slug-url.status-taken { color: #ef4444; }
    .inline-slug-url.status-invalid { color: #ef4444; }
    .inline-slug-url.status-checking { color: #fbbf24; animation: slug-pulse 1s ease-in-out infinite; }

    /* URL link parts: make non-slug portions (https:// and -sites.megabyte.space) clickable */
    .slug-url-link {
      color: var(--text-muted);
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s, text-decoration-color 0.2s;
      text-decoration: underline;
      text-decoration-color: transparent;
      text-underline-offset: 2px;
    }
    .slug-url-link:hover {
      color: var(--accent);
      text-decoration-color: var(--accent);
    }
    .slug-url-link:active {
      color: #4ecdc4;
      text-decoration-color: #4ecdc4;
    }
    .slug-url-link:focus-visible {
      outline: 1px solid var(--accent);
      outline-offset: 1px;
      border-radius: 2px;
    }
    /* The editable slug part stands out differently */
    .slug-editable-part {
      color: var(--accent);
      font-weight: 500;
    }
    @keyframes slug-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .slug-hint {
      display: inline-block;
      font-size: 0.6rem;
      margin-left: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      opacity: 0.85;
    }
    .slug-hint.hint-error { color: #ef4444; }
    .slug-hint.hint-taken { color: #ef4444; }
    .slug-hint.hint-available { color: #22c55e; }
    .slug-hint.hint-checking { color: #fbbf24; }

    /* ======================================================
       Deploy Modal
       ====================================================== */
    .deploy-upload-zone {
      border: 2px dashed rgba(80, 165, 219, 0.15);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s, background 0.3s, box-shadow 0.3s, transform 0.15s;
      margin-bottom: 12px;
    }
    .deploy-upload-zone:hover {
      border-color: var(--accent);
      background: rgba(80,165,219,0.04);
      box-shadow: 0 4px 16px rgba(80, 165, 219, 0.06);
      transform: translateY(-1px);
    }
    .deploy-upload-zone.has-file {
      border-color: var(--success);
      background: rgba(34,197,94,0.04);
      box-shadow: 0 2px 12px rgba(34, 197, 94, 0.08);
    }
    .deploy-file-name {
      font-size: 0.85rem;
      color: var(--success);
      margin-top: 8px;
      font-weight: 600;
    }

    /* Deploy File Manager */
    .deploy-file-manager {
      display: none;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #0d0d1f;
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 16px;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 0.78rem;
    }
    .deploy-file-manager.visible { display: block; animation: fadeIn 0.2s ease; }
    .deploy-file-manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }
    .deploy-folder-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background 0.15s;
      color: var(--text-secondary);
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .deploy-folder-item:last-child { border-bottom: none; }
    .deploy-folder-item:hover { background: rgba(100, 255, 218, 0.05); }
    .deploy-folder-item.selected {
      background: rgba(100, 255, 218, 0.1);
      color: var(--accent);
      font-weight: 600;
    }
    .deploy-folder-item.selected svg { stroke: var(--accent); }
    .deploy-folder-icon { flex-shrink: 0; }
    .deploy-folder-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .deploy-folder-count { font-size: 0.68rem; color: var(--text-muted); flex-shrink: 0; }
    .deploy-selected-path {
      font-size: 0.75rem;
      color: var(--accent);
      margin-top: 8px;
      margin-bottom: 24px;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    /* ======================================================
       Domain Search Results
       ====================================================== */
    .domain-search-wrap {
      position: relative;
      margin-bottom: 12px;
    }
    .domain-search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(80, 165, 219, 0.12);
      background: linear-gradient(145deg, rgba(10, 10, 26, 0.8), rgba(15, 15, 42, 0.6));
      color: var(--text-primary);
      font-size: 0.88rem;
      font-family: var(--font);
      z-index: 99;
      position: relative;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .domain-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(80, 165, 219, 0.08);
    }
    .domain-search-results {
      position: relative;
      background: transparent;
      border: none;
      border-radius: 0;
      margin-top: 8px;
      display: none;
      box-shadow: none;
    }
    .domain-search-results.open { display: block; }
    .domain-results-table { padding: 0; }
    .domain-result-item {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid transparent;
      border-radius: 12px;
      margin-bottom: 6px;
      transition: background 0.2s, border-color 0.25s, transform 0.2s, box-shadow 0.2s;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }
    .domain-result-item:last-child { margin-bottom: 0; }
    .domain-result-item:hover { background: rgba(80, 165, 219, 0.06); border-color: rgba(80, 165, 219, 0.15); transform: translateX(3px); }
    .domain-result-item.domain-taken { opacity: 0.4; cursor: default; }
    .domain-result-item.domain-taken:hover { transform: none; }
    .domain-result-item.domain-available { border-color: rgba(34, 197, 94, 0.15); }
    .domain-result-item.domain-available:hover { border-color: rgba(34, 197, 94, 0.35); background: rgba(34, 197, 94, 0.06); box-shadow: 0 4px 16px rgba(34, 197, 94, 0.1); }
    .domain-result-status { flex-shrink: 0; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: transform 0.2s; }
    .domain-result-item:hover .domain-result-status { transform: scale(1.1); }
    .domain-result-item.domain-available .domain-result-status { background: rgba(34, 197, 94, 0.15); box-shadow: 0 0 8px rgba(34, 197, 94, 0.1); }
    .domain-result-item.domain-taken .domain-result-status { background: rgba(239, 68, 68, 0.12); }
    .domain-result-item .domain-result-name { flex: 1; }
    .domain-result-item .domain-result-price { flex-shrink: 0; min-width: 70px; text-align: right; }
    .domain-result-name {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .domain-result-tld {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .domain-result-price {
      font-size: 0.85rem;
      color: #22c55e;
      font-weight: 700;
    }
    .domain-result-unavailable {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
    }
    .domain-tabs {
      display: flex;
      gap: 3px;
      margin-bottom: 20px;
      padding: 3px;
      background: linear-gradient(145deg, rgba(10, 10, 26, 0.7), rgba(15, 15, 42, 0.5));
      border-radius: 14px;
      border: 1px solid rgba(80, 165, 219, 0.08);
      backdrop-filter: blur(8px);
    }
    .domain-tab {
      flex: 1;
      padding: 10px 14px;
      text-align: center;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-radius: 11px;
      cursor: pointer;
      transition: color 0.25s, background 0.25s, box-shadow 0.25s, transform 0.15s;
      letter-spacing: 0.01em;
    }
    .domain-tab.active {
      color: #fff;
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.22), rgba(124, 58, 237, 0.16));
      box-shadow: 0 2px 10px rgba(80, 165, 219, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }
    .domain-tab:hover:not(.active) { color: var(--text-primary); background: rgba(80, 165, 219, 0.07); }
    .domain-tab:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--accent-dim); }
    .domain-tab:active { transform: scale(0.97); }
    /* Smooth tab panel transitions */
    #domain-panel-existing, #domain-panel-connect, #domain-panel-register {
      animation: domainTabFadeIn 0.2s ease-out;
    }
    @keyframes domainTabFadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hostname status squares â€” fill parent height, square aspect ratio */
    .hostname-status-square {
      width: 36px;
      min-height: 36px;
      align-self: stretch;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      aspect-ratio: 1 / 1;
    }
    .hostname-status-square.active {
      background: #22c55e;
    }
    .hostname-status-square.inactive {
      background: #ef4444;
    }
    .hostname-status-square.pending {
      background: #fbbf24;
      animation: pulse-yellow 2s ease-in-out infinite;
    }
    @keyframes pulse-yellow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.65; }
    }
    .hostname-status-square svg { width: 16px; height: 16px; }

    /* Hostname chips below URL */
    .hostname-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .hostname-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      letter-spacing: 0.02em;
    }
    .hostname-chip.default { background: rgba(148,163,184,0.15); color: #94a3b8; position: relative; cursor: help; }
    .hostname-chip.primary { background: rgba(80,165,219,0.15); color: var(--accent); position: relative; cursor: help; }
    .hostname-chip[data-tip]::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,15,42,0.96);
      color: var(--text-secondary);
      font-size: 0.62rem;
      font-weight: 400;
      letter-spacing: 0;
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 10;
      max-width: 320px;
      min-width: 200px;
      white-space: normal;
      text-align: center;
      line-height: 1.3;
    }
    .hostname-chip[data-tip]:hover::after { opacity: 1; }
    /* DomainConnect auto-setup buttons */
    .dc-btn {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 0.62rem; font-weight: 600; text-decoration: none;
      padding: 3px 8px; border-radius: 5px; transition: all 0.2s;
    }
    .dc-btn-gd { color: #1bdbdb; background: rgba(27,219,219,0.08); border: 1px solid rgba(27,219,219,0.15); }
    .dc-btn-gd:hover { background: rgba(27,219,219,0.16); border-color: rgba(27,219,219,0.3); }
    .dc-btn-cf { color: #F6821F; background: rgba(246,130,31,0.08); border: 1px solid rgba(246,130,31,0.15); }
    .dc-btn-cf:hover { background: rgba(246,130,31,0.16); border-color: rgba(246,130,31,0.3); }
    .hostname-chip-setprimary {
      font-size: 0.62rem;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      margin-left: 4px;
      background: none;
      border: none;
      padding: 0;
      font-family: inherit;
    }
    .hostname-chip-setprimary:hover { color: #4ecdc4; }

    /* AI Validation Tooltip */
    .ai-validation-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(80, 165, 219, 0.95);
      color: #fff;
      font-size: 0.72rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 100;
      animation: tooltip-fade 0.3s ease;
    }
    .ai-validation-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(80, 165, 219, 0.95);
    }
    @keyframes tooltip-fade {
      from { opacity: 0; transform: translateX(-50%) translateY(4px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Universal tooltip system */
    [data-tooltip] { position: relative; }
    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,15,42,0.96);
      color: var(--text-secondary);
      font-size: 0.62rem;
      font-weight: 400;
      letter-spacing: 0;
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 9999;
      line-height: 1.3;
    }
    [data-tooltip]:hover::after { opacity: 1; }
    [data-tooltip].tt-right::after { left: auto; right: 0; transform: none; }
    [data-tooltip].tt-left::after { left: 0; right: auto; transform: none; }
    [data-tooltip].tt-below::after { bottom: auto; top: calc(100% + 6px); }
    [data-tooltip].tt-wide::after { white-space: normal; max-width: 220px; text-align: center; min-width: 120px; }

    /* Login page centered layout */
    .screen-signin-centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 60px);
      padding: 24px 16px;
    }
    .signin-content-centered {
      width: 100%;
      max-width: 400px;
    }
    .signin-footer-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 12px 16px;
      font-size: 0.72rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
      z-index: 10;
    }
    @media (max-height: 600px) {
      .signin-footer {
        position: static;
        margin-top: 24px;
        border-top: none;
        background: transparent;
      }
      .screen-signin {
        min-height: auto;
        padding-bottom: 0;
      }
    }

    /* Gorgeous button states - global refinements */
    .btn:focus-visible, .admin-btn:focus-visible, .header-auth-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-dim), 0 0 16px rgba(80, 165, 219, 0.15);
    }
    .btn:focus:not(:focus-visible), .admin-btn:focus:not(:focus-visible) { outline: none; }
    .hostname-delete-btn {
      transition: color 0.2s, opacity 0.2s, background 0.2s;
      border-radius: 4px;
    }
    .hostname-delete-btn:hover {
      background: rgba(255,255,255,0.06);
    }
    .hostname-delete-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-dim);
    }
    .hostname-delete-btn:active {
      opacity: 0.6;
    }

    /* ======================================================
       Details Business Name Search
       ====================================================== */
    .details-biz-search-wrap {
      position: relative;
      z-index: 99999;
    }
    .details-biz-search-wrap #business-name-input {
      position: relative;
      z-index: 99999;
    }
    .details-biz-dropdown {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      padding-top: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 280px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      box-shadow: var(--shadow-lg);
    }
    .details-biz-dropdown .search-result {
      padding: 12px 16px;
    }
    .details-biz-dropdown.open { display: block; animation: fadeInScale 0.15s ease; }

    /* ======================================================
       Screens Container
       ====================================================== */
    .app {
      min-height: 100vh;
      padding-top: 60px;
      position: relative;
    }
    .screen {
      display: none;
      min-height: calc(100vh - 60px);
      animation: fadeIn 0.3s ease;
    }
    .screen-search {
      min-height: auto;
    }
    .screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .screen-search.active {
      justify-content: flex-start;
      padding-top: 12vh;
    }

    /* ======================================================
       Background Orbs (shared)
       ====================================================== */
    .bg-orbs {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .bg-orbs .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.18;
    }
    .bg-orbs .orb-1 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, var(--secondary), transparent 70%);
      top: -120px; right: -120px;
      animation: orbFloat1 20s ease-in-out infinite;
    }
    .bg-orbs .orb-2 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, var(--accent), transparent 70%);
      bottom: -80px; left: -100px;
      animation: orbFloat2 18s ease-in-out infinite;
    }
    .bg-orbs .orb-3 {
      width: 300px; height: 300px;
      background: radial-gradient(circle, #f472b6, transparent 70%);
      top: 40%; left: 50%;
      animation: orbFloat1 22s ease-in-out infinite reverse;
    }

    /* ======================================================
       Screen 1: Search / Hero
       ====================================================== */
    .screen-search {
      padding: 0 24px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .hero-brand {
      margin-bottom: 16px;
      animation: fadeInUp 0.6s ease;
    }
    .hero-brand h1 {
      font-size: clamp(2.2rem, 5.5vw, 3.8rem);
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.1;
      margin-bottom: 12px;
    }
    .hero-brand h1 .gradient-text {
      background: linear-gradient(135deg, var(--accent), var(--secondary), #f472b6);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 5s linear infinite;
    }
    .hero-brand .tagline {
      font-size: clamp(1rem, 2vw, 1.25rem);
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Search box */
    .search-wrapper {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 640px;
      margin: 32px auto 0;
      animation: fadeInUp 0.6s ease 0.15s both;
    }
    .search-input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      display: flex;
    }
    .search-input {
      width: 100%;
      padding: 18px 20px 18px 52px;
      font-size: 1.1rem;
      font-family: var(--font);
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
      position: relative;
      z-index: 2;
    }
    .search-input::placeholder {
      color: var(--text-muted);
    }
    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim), 0 0 40px var(--accent-glow);
    }
    .search-spinner {
      position: absolute;
      right: 18px;
      top: 0;
      bottom: 0;
      margin-top: auto;
      margin-bottom: auto;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s;
      z-index: 3;
    }
    .search-spinner.visible { opacity: 1; visibility: visible; }

    /* Dropdown */
    .search-dropdown {
      position: absolute;
      top: 100%;
      margin-top: -14px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1;
      display: none;
      box-shadow: var(--shadow-lg);
    }
    .search-dropdown.open {
      display: block;
      animation: fadeInScale 0.2s ease;
    }
    .search-result {
      padding: 14px 20px;
      cursor: pointer;
      transition: background var(--transition);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }
    .search-result:first-child { padding-top: 28px; }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover {
      background: var(--bg-card-hover);
    }
    .search-result-icon {
      flex-shrink: 0;
      width: 38px;
      height: 38px;
      border-radius: 10px;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2px;
    }
    .search-result-icon svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }
    .search-result-text { flex: 1; min-width: 0; }
    .search-result-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-result-address {
      font-size: 0.82rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Custom website option */
    .search-result-custom {
      background: var(--secondary-dim);
      border-top: 1px solid rgba(124, 58, 237, 0.2);
    }
    .search-result-custom:hover {
      background: rgba(124, 58, 237, 0.22);
    }
    .search-result-custom .search-result-icon {
      background: var(--secondary-dim);
    }
    .search-result-custom .search-result-icon svg {
      color: var(--secondary);
    }
    .search-result-custom .search-result-name {
      color: #c4b5fd;
    }
    .search-result-custom .search-result-address {
      color: #a78bfa;
      font-style: normal;
    }

    .search-hint {
      margin-top: 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
      animation: fadeInUp 0.6s ease 0.3s both;
    }

    /* ======================================================
       Screen 3: Sign-In Gate
       ====================================================== */
    .screen-signin {
      padding: 0 24px 60px;
      text-align: center;
      position: relative;
      z-index: 1;
      min-height: 100vh;
      overflow: hidden;
    }
    .screen-signin.active {
      justify-content: center;
      gap: 0;
    }
    /* Animated background orbs for sign-in */
    .screen-signin::before {
      content: '';
      position: absolute;
      top: 15%;
      left: -10%;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(80, 165, 219, 0.08) 0%, transparent 70%);
      animation: orbFloat1 12s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    .screen-signin::after {
      content: '';
      position: absolute;
      bottom: 10%;
      right: -8%;
      width: 350px;
      height: 350px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.08) 0%, transparent 70%);
      animation: orbFloat2 15s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    /* Compact signin footer - fixed at bottom */
    .signin-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      opacity: 0.7;
      transition: opacity 0.3s;
      background: linear-gradient(180deg, transparent 0%, rgba(10, 10, 26, 0.95) 30%);
      border-top: 1px solid rgba(80, 165, 219, 0.06);
      z-index: 10;
      backdrop-filter: blur(12px);
    }
    .signin-footer:hover { opacity: 1; }
    .signin-footer-social {
      display: flex;
      gap: 14px;
    }
    .signin-footer-social a {
      color: var(--text-muted);
      transition: color 0.2s, transform 0.2s;
      display: flex;
    }
    .signin-footer-social a:hover { transform: scale(1.2) translateY(-1px); }
    .signin-footer-social a[aria-label="GitHub"]:hover { color: #f0f6fc; }
    .signin-footer-social a[aria-label="X"]:hover { color: #f0f6fc; }
    .signin-footer-social a[aria-label="LinkedIn"]:hover { color: #0a66c2; }
    .signin-footer-social a[aria-label="YouTube"]:hover { color: #ff0000; }
    .signin-footer-social a[aria-label="Instagram"]:hover { color: #e4405f; }
    .signin-footer-social a[aria-label="Facebook"]:hover { color: #1877f2; }
    .signin-footer-social a svg { width: 15px; height: 15px; }
    .signin-footer-legal {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .signin-footer-legal a {
      color: var(--text-muted);
      text-decoration: none;
      transition: color 0.15s;
    }
    .signin-footer-legal a:hover { color: var(--accent); }
    .signin-card {
      width: 100%;
      max-width: 440px;
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.95), rgba(15, 15, 42, 0.98));
      border: 1px solid rgba(80, 165, 219, 0.15);
      border-radius: 20px;
      padding: 44px 36px;
      animation: fadeInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(80, 165, 219, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.04);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(20px);
    }
    .signin-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 21px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.25), transparent 50%, rgba(124, 58, 237, 0.2));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .signin-card h2 {
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #e2e8f0 0%, #50a5db 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .signin-card .signin-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .signin-methods { display: flex; flex-direction: column; gap: 14px; }

    .signin-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease;
      border: 1px solid rgba(80, 165, 219, 0.12);
      background: linear-gradient(145deg, rgba(15, 15, 42, 0.8), rgba(22, 22, 53, 0.6));
      color: var(--text-primary);
      position: relative;
      overflow: hidden;
    }
    .signin-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(80, 165, 219, 0.06), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .signin-btn:hover {
      transform: translateY(-2px);
      border-color: rgba(80, 165, 219, 0.3);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(80, 165, 219, 0.08);
    }
    .signin-btn:hover::after { opacity: 1; }
    .signin-btn:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 24px rgba(80, 165, 219, 0.12);
    }
    .signin-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      transition-duration: 0.08s;
    }
    .signin-btn svg { flex-shrink: 0; position: relative; z-index: 1; }
    .signin-btn span { position: relative; z-index: 1; }

    .signin-btn-google {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      color: #1f1f1f;
      border-color: rgba(218, 220, 224, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .signin-btn-google::after { display: none; }
    .signin-btn-google:hover {
      background: linear-gradient(145deg, #ffffff, #f0f1f3);
      border-color: rgba(80, 165, 219, 0.4);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(80, 165, 219, 0.1);
    }

    .signin-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 22px 0;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 500;
    }
    .signin-divider::before,
    .signin-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(80, 165, 219, 0.15), transparent);
    }

    /* Phone / Email form panels */
    .signin-panel {
      display: none;
      animation: fadeInUp 0.3s ease;
    }
    .signin-panel.active { display: block; }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      text-align: left;
    }
    .input-group label {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .input-field {
      width: 100%;
      padding: 14px 16px;
      font-size: 1rem;
      font-family: var(--font);
      background: linear-gradient(145deg, rgba(10, 10, 26, 0.8), rgba(15, 15, 42, 0.5));
      border: 1.5px solid rgba(80, 165, 219, 0.1);
      border-radius: var(--radius);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .input-field::placeholder { color: var(--text-muted); }
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(80, 165, 219, 0.06);
    }

    textarea.input-field {
      resize: vertical;
      min-height: 120px;
      line-height: 1.6;
    }
    #details-textarea {
      min-height: 210px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      margin-top: 20px;
      transition: color var(--transition);
      background: none;
      border: none;
      font-family: var(--font);
    }
    .back-link:hover { color: var(--accent); }
    .back-link:active { opacity: 0.7; transition-duration: 0.06s; }

    /* ======================================================
       Buttons (shared)
       ====================================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      font-family: var(--font);
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: box-shadow var(--transition), background var(--transition), opacity var(--transition), filter var(--transition), border-color var(--transition);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    .btn-accent {
      background: linear-gradient(135deg, var(--accent) 0%, #4ecdc4 50%, var(--accent) 100%);
      background-size: 200% 200%;
      color: var(--bg-primary);
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, background-position 0.5s ease, filter 0.3s ease;
    }
    .btn-accent:hover:not(:disabled) {
      background-position: 100% 0;
      box-shadow:
        0 0 20px rgba(80, 165, 219, 0.4),
        0 0 60px rgba(80, 165, 219, 0.15),
        0 4px 16px rgba(0, 0, 0, 0.3);
      filter: brightness(1.1);
    }
    .btn-accent:focus:not(:disabled) {
      outline: none;
      box-shadow:
        0 0 0 3px var(--accent-dim),
        0 0 30px rgba(80, 165, 219, 0.25),
        inset 0 0 12px rgba(255, 255, 255, 0.08);
    }
    .btn-accent:active:not(:disabled) {
      box-shadow:
        0 0 0 3px rgba(80, 165, 219, 0.5),
        inset 0 2px 6px rgba(0, 0, 0, 0.2);
      filter: brightness(0.92);
      transition-duration: 0.08s;
    }
    .btn-secondary-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1.5px solid var(--border);
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease, color 0.3s ease, background 0.3s ease;
    }
    .btn-secondary-outline:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(80, 165, 219, 0.04);
      box-shadow:
        0 0 20px rgba(80, 165, 219, 0.1),
        0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .btn-secondary-outline:focus:not(:disabled) {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(80, 165, 219, 0.1);
    }
    .btn-secondary-outline:active:not(:disabled) {
      background: rgba(80, 165, 219, 0.08);
      border-color: #4ecdc4;
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.3);
      transition-duration: 0.08s;
    }
    .btn-full { width: 100%; }
    .btn-large {
      padding: 16px 32px;
      font-size: 1.05rem;
      border-radius: var(--radius-lg);
    }

    /* Universal focus-visible for accessibility */
    button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    button:focus:not(:focus-visible), a:focus:not(:focus-visible) { outline: none; }
    /* Universal hover transition for interactive elements */
    .editor-toolbar-btn:hover, .logs-refresh-btn:hover, .hostname-delete-btn:hover,
    .domain-tab:hover:not(.active), .admin-btn:hover, .modal-close:hover {
      filter: brightness(1.15);
    }
    .editor-toolbar-btn:active, .logs-refresh-btn:active, .hostname-delete-btn:active,
    .admin-btn:active, .modal-close:active {
      filter: brightness(0.9);
      transition-duration: 0.06s;
    }
    /* Material-style ripple effect */
    .btn, .site-card-btn, .admin-btn, .admin-btn-accent, .logs-refresh-btn,
    .domain-tab, .hostname-delete-btn, .signin-btn, .back-link,
    .modal-close, .details-modal-close, .header-auth-btn,
    .site-card-new, .site-card-upgrade-btn,
    .inline-edit-btn, .inline-save-btn, .inline-cancel-btn,
    .faq-question, .btn-allow, .btn-skip, .improve-ai-link,
    .plan-badge, .dc-btn, .editor-toolbar-btn {
      position: relative;
      overflow: hidden;
    }
    .ripple-circle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.35);
      pointer-events: none;
      animation: ripple-expand 0.65s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    /* Brighter ripple on accent/bright buttons for visibility */
    .btn-accent .ripple-circle,
    .btn-allow .ripple-circle,
    .site-card-upgrade-btn .ripple-circle {
      background: rgba(255, 255, 255, 0.5);
    }
    /* Tinted ripple on outlined/ghost buttons */
    .btn-secondary-outline .ripple-circle,
    .btn-ghost .ripple-circle {
      background: rgba(80, 165, 219, 0.2);
    }

    /* ======================================================
       Inline Error / Success Messages
       ====================================================== */
    .msg {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-top: 12px;
      text-align: left;
      min-height: 40px;
      visibility: hidden;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.2s ease, max-height 0.25s ease, padding 0.25s ease, margin 0.25s ease;
      padding: 0 14px;
      margin-top: 0;
    }
    .msg.visible {
      visibility: visible;
      opacity: 1;
      max-height: 120px;
      padding: 10px 14px;
      margin-top: 12px;
    }
    .msg-error {
      background: var(--error-dim);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .msg-success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .msg-info {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(80, 165, 219, 0.15);
    }

    /* ======================================================
       Location Permission Modal
       ====================================================== */
    .location-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .location-modal {
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.98), rgba(15, 15, 42, 1));
      border: 1px solid rgba(80, 165, 219, 0.12);
      border-radius: 20px;
      padding: 36px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: fadeInScale 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    .location-modal-icon {
      margin-bottom: 16px;
      color: var(--accent);
    }
    .location-modal h3 {
      color: var(--text-primary);
      font-size: 1.15rem;
      margin-bottom: 8px;
    }
    .location-modal p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .location-modal-actions {
      display: flex;
      gap: 12px;
    }
    .location-modal-actions button {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition);
    }
    .location-modal-actions .btn-allow {
      background: linear-gradient(135deg, var(--accent), var(--secondary));
      color: #fff;
    }
    .location-modal-actions .btn-allow:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-accent);
    }
    .location-modal-actions .btn-allow:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--accent-dim), var(--shadow-accent);
    }
    .location-modal-actions .btn-allow:active {
      transform: translateY(1px) scale(0.97);
      transition-duration: 0.06s;
    }
    .location-modal-actions .btn-skip {
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .location-modal-actions .btn-skip:hover {
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    .location-modal-actions .btn-skip:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }
    .location-modal-actions .btn-skip:active {
      opacity: 0.7;
      transition-duration: 0.06s;
    }

    /* ======================================================
       Loading dots
       ====================================================== */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.32s; }

    /* ======================================================
       Screen 3b: Details + Upload
       ====================================================== */
    .screen-details {
      padding: 24px;
      position: relative;
      z-index: 1;
      width: 100%;
    }
    /* Details Modal Overlay */
    .details-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: flex-start;
      justify-content: center;
      animation: fadeIn 0.15s ease;
      overflow-y: auto;
      padding: 24px;
    }
    .details-modal-overlay.visible { display: flex; }
    .details-modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 1.3rem;
      line-height: 1;
      z-index: 2;
      transition: color 0.2s, background 0.2s;
      border-radius: 8px;
    }
    .details-modal-close:hover { color: var(--text-primary); background: rgba(239, 68, 68, 0.08); }
    .details-modal-close:focus { outline: none; color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); }
    .details-modal-close:active { opacity: 0.6; transition: opacity 0.06s; }
    .details-card {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.98), rgba(15, 15, 42, 1));
      border: 1px solid rgba(80, 165, 219, 0.12);
      border-radius: 20px;
      padding: 40px 36px;
      animation: fadeInScale 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      flex-shrink: 0;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    .details-card h2 {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .details-card .details-subtitle {
      font-size: 0.88rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .selected-business-badge {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent-dim);
      border: 1px solid rgba(80, 165, 219, 0.15);
      border-radius: var(--radius);
      margin-bottom: 24px;
    }
    .selected-business-badge .badge-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .selected-business-badge .badge-text { text-align: left; }
    .selected-business-badge .badge-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
    }
    .selected-business-badge .badge-addr {
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .selected-business-badge .badge-dismiss {
      margin-left: auto;
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      background: rgba(255,255,255,0.06);
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
      padding: 0;
    }
    .selected-business-badge .badge-dismiss:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    /* â”€â”€ Address Autocomplete Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #business-address-input {
      position: relative;
      z-index: 9999;
    }
    .address-dropdown {
      position: absolute;
      padding-top: 20px;
      top: 60px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-hover);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 280px;
      overflow-y: auto;
      z-index: 999;
      display: none;
      box-shadow: var(--shadow-lg);
    }
    .address-dropdown.open { display: block; animation: fadeInScale 0.15s ease; }
    .address-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background var(--transition);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .address-item:last-child { border-bottom: none; }
    .address-item:hover { background: var(--bg-card-hover); }
    .address-item-icon {
      flex-shrink: 0;
      color: var(--accent);
      opacity: 0.7;
    }
    .address-item-text {
      flex: 1;
      min-width: 0;
    }
    .address-item-main {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .address-item-secondary {
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .uppy-section {
      margin: 20px 0;
    }
    .uppy-section label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
      text-align: left;
    }
    #uppy-dashboard-area {
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* â”€â”€ Improve with AI overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .improve-ai-link {
      position: relative;
      bottom: -2px;
      font-size: 0.78rem;
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
      transition: color 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .improve-ai-link:hover { color: #7c3aed; }
    .improve-ai-link:focus { outline: none; text-decoration: underline; }
    .improve-ai-link:active { opacity: 0.7; transition: opacity 0.06s; }
    .improve-ai-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 26, 0.85);
      border-radius: var(--radius);
      z-index: 10;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
    }
    .improve-ai-overlay.visible { display: flex; }
    .improve-ai-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .improve-ai-text {
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 600;
    }

    /* â”€â”€ Premium domain badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .premium-domain-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(80,165,219,0.15));
      border: 1px solid rgba(124,58,237,0.25);
      color: #c4b5fd;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .premium-domain-badge svg { width: 10px; height: 10px; }

    /* â”€â”€ Unsubscribe domain warning modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .domain-unsub-warning {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 0.82rem;
      color: var(--error);
      margin-top: 8px;
      line-height: 1.5;
    }

    /* â”€â”€ Responsive terminal fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 620px) {
      .build-terminal { min-width: auto; max-width: 100%; }
    }

    /* Uppy dark theme overrides */
    .uppy-Dashboard-inner {
      background: var(--bg-input) !important;
      border-color: var(--border) !important;
    }

    /* ======================================================
       Screen 4: Waiting
       ====================================================== */
    .screen-waiting {
      padding: 24px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .screen-waiting.active {
      justify-content: flex-start;
      padding-top: 40px;
    }
    .waiting-content {
      max-width: 480px;
      animation: fadeInScale 0.4s ease;
    }
    .waiting-anim {
      width: 160px;
      height: 160px;
      margin: 0 auto 32px;
      position: relative;
    }
    .waiting-anim-ring {
      position: absolute;
      border-radius: 50%;
      border: 3px solid transparent;
      animation: waitSpin 2.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
    }
    .waiting-anim-ring:nth-child(1) {
      inset: 0;
      border-top-color: var(--accent);
      border-right-color: var(--accent);
    }
    .waiting-anim-ring:nth-child(2) {
      inset: 18px;
      border-bottom-color: #7c3aed;
      border-left-color: #7c3aed;
      animation-delay: -0.4s;
      animation-direction: reverse;
    }
    .waiting-anim-ring:nth-child(3) {
      inset: 36px;
      border-top-color: #3b82f6;
      border-right-color: #3b82f6;
      animation-delay: -0.8s;
    }
    .waiting-anim-icon {
      position: absolute;
      inset: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: waitPulse 2s ease-in-out infinite;
    }
    @keyframes waitSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes waitPulse {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.15); }
    }
    .waiting-title {
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: -0.02em;
      transition: color 0.3s ease, text-shadow 0.3s ease;
      cursor: default;
    }
    .waiting-title:hover {
      color: var(--accent);
      text-shadow: 0 0 20px rgba(100, 255, 218, 0.3);
    }
    .waiting-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .waiting-contact {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 16px;
    }
    /* waiting-status removed */

    /* ======================================================
       Responsive
       ====================================================== */
    @media (max-width: 640px) {
      .signin-card, .details-card {
        padding: 28px 20px;
      }
      .search-input {
        font-size: 1rem;
        padding: 16px 18px 16px 48px;
      }
      .hero-brand h1 {
        font-size: 2rem;
      }
    }
    @media (max-width: 380px) {
      .header { padding: 0 16px; }
      .screen-search, .screen-signin, .screen-details, .screen-waiting, .screen-legal {
        padding: 16px;
      }
    }

    /* ======================================================
       Legal Pages (Privacy, Terms, Content Policy)
       ====================================================== */
    .screen-legal {
      padding: 40px 24px 80px;
      min-height: auto;
    }
    .screen-legal.active {
      justify-content: flex-start;
      align-items: flex-start;
    }
    /* When a legal/content page is active, unset .app min-height so
       the page height follows the content naturally. */
    .app:has(.screen-legal.active) {
      min-height: unset;
    }
    .legal-container {
      max-width: 760px;
      width: 100%;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    .legal-container h2 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .legal-container .legal-updated {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 32px;
    }
    .legal-container h3 {
      color: var(--accent);
      font-size: 1.15rem;
      font-weight: 700;
      margin: 28px 0 12px;
    }
    .legal-container p,
    .legal-container li {
      color: var(--text-secondary);
      font-size: 0.92rem;
      line-height: 1.7;
      margin-bottom: 12px;
    }
    .legal-container ul {
      padding-left: 20px;
      margin-bottom: 16px;
    }
    .legal-container a {
      color: var(--accent);
      text-decoration: none;
    }
    .legal-container a:hover {
      text-decoration: underline;
    }
    .legal-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      margin-bottom: 24px;
      transition: color 0.2s;
    }
    .legal-back:hover { color: var(--accent); }

    /* ======================================================
       Marketing Sections (visible on search screen)
       ====================================================== */
    .marketing-sections {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px;
      position: relative;
      z-index: 1;
    }

    .section-title {
      text-align: center;
      font-size: clamp(1.6rem, 3.5vw, 2.4rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 12px;
    }
    .section-subtitle {
      text-align: center;
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 48px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    /* â”€â”€ How It Works â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #how-it-works { padding: 80px 0 60px; }

    .steps-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 28px;
    }
    .step-card {
      text-align: center;
      padding: 36px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
      opacity: 0;
      transform: translateY(30px);
    }
    .step-card.animate-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    .step-card:nth-child(2).animate-in { animation-delay: 0.15s; }
    .step-card:nth-child(3).animate-in { animation-delay: 0.3s; }
    .step-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-accent);
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--secondary));
      color: #ffffff;
      font-weight: 800;
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    .step-card h3 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .step-card p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* â”€â”€ Features / Selling Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #features { padding: 60px 0; }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }
    .feature-card {
      padding: 32px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
      opacity: 0;
      transform: translateY(30px);
    }
    .feature-card.animate-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    .feature-card:nth-child(2).animate-in { animation-delay: 0.15s; }
    .feature-card:nth-child(3).animate-in { animation-delay: 0.3s; }
    .feature-card:hover {
      transform: translateY(-3px);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-accent);
    }
    .feature-card:last-child {
      grid-column: 2;
    }
    .feature-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }
    .feature-icon svg {
      width: 24px;
      height: 24px;
      color: var(--accent);
    }
    .feature-card h3 {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .feature-card p {
      font-size: 0.88rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* â”€â”€ Competitor Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #comparison { padding: 60px 0; }

    .comparison-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .comparison-table th,
    .comparison-table td {
      padding: 16px 18px;
      text-align: center;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }
    .comparison-table thead th {
      background: var(--bg-secondary);
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-secondary);
    }
    .comparison-table thead th:first-child {
      text-align: left;
    }
    .comparison-table thead th.highlight {
      color: var(--accent);
      background: rgba(80, 165, 219, 0.06);
    }
    .comparison-table tbody td:first-child {
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
    }
    .comparison-table tbody td.highlight {
      background: rgba(80, 165, 219, 0.04);
      color: var(--accent);
      font-weight: 600;
    }
    .comparison-table tbody tr:last-child td {
      border-bottom: none;
    }
    .check-icon { color: var(--success); font-weight: 700; }
    .cross-icon { color: var(--text-muted); }

    /* â”€â”€ Pricing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #pricing { padding: 60px 0; }

    .pricing-card {
      max-width: 420px;
      margin: 0 auto;
      text-align: center;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: 48px 36px;
      box-shadow: var(--shadow-accent);
      opacity: 0;
      transform: translateY(30px);
    }
    .pricing-card.animate-in {
      animation: fadeInUp 0.6s ease forwards;
      animation-delay: 0.15s;
    }
    .pricing-card .plan-label {
      display: inline-block;
      background: var(--accent);
      color: var(--bg-primary);
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 14px;
      border-radius: 20px;
      margin-bottom: 20px;
    }
    .pricing-card-free .plan-label {
      display: inline-block;
      padding: 5px 15px;
      margin-bottom: 15px;
      margin-top: 10px;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-radius: 20px;
    }
    .pricing-price {
      font-size: 3.5rem;
      font-weight: 900;
      letter-spacing: -0.04em;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 4px;
      min-height: 3.5rem;
    }
    .pricing-price span {
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .pricing-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 28px;
    }
    .pricing-features {
      list-style: none;
      text-align: left;
      margin-bottom: 32px;
    }
    .pricing-features li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      font-size: 0.9rem;
      color: var(--text-primary);
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .pricing-features li:last-child { border-bottom: none; }
    .pricing-features li svg {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-footer {
      border-top: 1px solid var(--border);
      padding: 48px 24px 32px;
      margin-top: 60px;
      position: relative;
      z-index: 1;
    }
    .footer-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }
    .footer-links {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .footer-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.88rem;
      transition: color var(--transition);
    }
    .footer-links a:hover { color: var(--accent); }

    .footer-social {
      display: flex;
      gap: 16px;
    }
    .footer-social a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .footer-social a:hover { transform: scale(1.15); }
    .footer-social a[aria-label="GitHub"]:hover { color: #f0f6fc; }
    .footer-social a[aria-label="X"]:hover { color: #f0f6fc; }
    .footer-social a[aria-label="LinkedIn"]:hover { color: #0a66c2; }
    .footer-social a[aria-label="YouTube"]:hover { color: #ff0000; }
    .footer-social a[aria-label="Instagram"]:hover { color: #e4405f; }
    .footer-social a[aria-label="Facebook"]:hover { color: #1877f2; }
    .footer-social a svg {
      width: 18px;
      height: 18px;
    }

    .footer-bottom {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .footer-bottom a {
      color: var(--text-muted);
      text-decoration: none;
    }
    .footer-bottom a:hover { color: var(--accent); }

    /* â”€â”€ Hero CTAs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero-ctas {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 24px;
      animation: fadeInUp 0.6s ease 0.45s both;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1.5px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      text-decoration: none;
      transition: color var(--transition), border-color var(--transition);
    }
    .btn-ghost:hover {
      color: var(--accent);
      border-color: var(--accent);
    }
    .hero-clarify {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 12px;
      animation: fadeInUp 0.6s ease 0.5s both;
    }
    .hero-clarify strong { color: var(--accent); font-weight: 600; }

    /* â”€â”€ Proof / Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #proof { padding: 80px 0 60px; }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 48px;
    }
    .site-thumb {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      aspect-ratio: 16/10;
      background: var(--bg-card);
      border: 1px solid var(--border);
      transition: transform var(--transition), box-shadow var(--transition);
      cursor: pointer;
    }
    .site-thumb:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-accent);
    }
    .site-thumb-preview {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .site-thumb-bar {
      height: 28px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 5px;
    }
    .site-thumb-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      opacity: 0.4;
    }
    .site-thumb-body {
      flex: 1;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .site-thumb-hero-block {
      height: 40%;
      border-radius: 6px;
      opacity: 0.7;
    }
    .site-thumb-line {
      height: 6px;
      border-radius: 3px;
      background: var(--border);
    }
    .site-thumb-line.short { width: 60%; }
    .site-thumb-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px 14px;
      background: linear-gradient(transparent, rgba(10,10,26,0.95));
    }
    .site-thumb-name {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .site-thumb-industry {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Testimonials */
    .testimonials-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .testimonial-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px 24px;
    }
    .testimonial-stars {
      color: #fbbf24;
      font-size: 0.9rem;
      margin-bottom: 12px;
      letter-spacing: 2px;
    }
    .testimonial-quote {
      font-size: 0.92rem;
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: 16px;
      font-style: italic;
    }
    .testimonial-author {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .testimonial-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--bg-primary);
      flex-shrink: 0;
    }
    .testimonial-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .testimonial-role {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* â”€â”€ What's Handled (value prop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #handled { padding: 60px 0; }
    .handled-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }
    .handled-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px 24px;
      text-align: center;
      transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
      opacity: 0;
      transform: translateY(30px);
    }
    .handled-card.animate-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    .handled-card:nth-child(2).animate-in { animation-delay: 0.15s; }
    .handled-card:nth-child(3).animate-in { animation-delay: 0.3s; }
    .handled-card:hover {
      transform: translateY(-3px);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-accent);
    }
    .handled-card .handled-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    .handled-card .handled-icon svg {
      width: 28px;
      height: 28px;
      color: var(--accent);
    }
    .handled-card h3 {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .handled-card p {
      font-size: 0.88rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    .handled-summary {
      text-align: center;
      margin-top: 32px;
      padding: 24px;
      background: var(--accent-dim);
      border: 1px solid rgba(80,165,219,0.15);
      border-radius: var(--radius-lg);
      font-size: 0.95rem;
      color: var(--text-primary);
      line-height: 1.7;
      transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
    }
    .handled-summary:hover {
      border-color: rgba(80,165,219,0.3);
      box-shadow: 0 4px 20px rgba(80,165,219,0.08);
      transform: translateY(-1px);
    }
    .handled-summary strong { color: var(--accent); }

    /* â”€â”€ Trust Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trust-bar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px 40px;
    }
    .trust-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* â”€â”€ Done-for-you vs DIY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #dvd { padding: 60px 0; }
    .dvd-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    .dvd-column {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      overflow: hidden;
      opacity: 0;
      transform: translateY(30px);
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .dvd-column:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--border-hover);
    }
    .dvd-column.dvd-highlight:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(80, 165, 219, 0.15);
    }
    .dvd-column.animate-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    .dvd-column:nth-child(2).animate-in { animation-delay: 0.15s; }
    .dvd-column.dvd-highlight {
      border: 2px solid var(--accent);
      box-shadow: var(--shadow-accent);
    }
    .dvd-column.dvd-other {
      border: 1px solid var(--border);
    }
    .dvd-header {
      padding: 20px 24px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .dvd-highlight .dvd-header {
      background: rgba(80,165,219,0.06);
      color: var(--accent);
    }
    .dvd-other .dvd-header {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    .dvd-list {
      padding: 16px 24px 24px;
      list-style: none;
    }
    .dvd-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      line-height: 1.5;
    }
    .dvd-list li:last-child { border-bottom: none; }
    .dvd-list li svg {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      margin-top: 2px;
    }
    .dvd-highlight .dvd-list li svg { color: var(--accent); }
    .dvd-other .dvd-list li svg { color: var(--text-muted); }
    .dvd-highlight .dvd-list li { color: var(--text-primary); }
    .dvd-other .dvd-list li { color: var(--text-secondary); }

    /* â”€â”€ FAQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #faq { padding: 60px 0; }
    .faq-list {
      max-width: 740px;
      margin: 0 auto;
    }
    .faq-item {
      border-bottom: 1px solid var(--border);
      opacity: 0;
      transform: translateY(20px);
    }
    .faq-item.animate-in {
      animation: fadeInUp 0.4s ease forwards;
    }
    .faq-question {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      text-align: left;
      line-height: 1.5;
      transition: color var(--transition);
    }
    .faq-question:hover { color: var(--accent); }
    .faq-question:focus { outline: none; color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); border-radius: 4px; }
    .faq-question:active { opacity: 0.8; transition: opacity 0.06s; }
    .faq-question svg {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      transition: transform var(--transition);
    }
    .faq-item.open .faq-question svg {
      transform: rotate(180deg);
    }
    .faq-answer {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .faq-item.open .faq-answer {
      max-height: 400px;
    }
    .faq-answer-inner {
      padding: 0 0 20px;
      text-align: left;
      font-size: 0.92rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    /* â”€â”€ Pricing (updated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pricing-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }
    .pricing-toggle-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
    }
    .pricing-toggle-label.active { color: var(--text-primary); font-weight: 700; }
    .pricing-toggle-switch {
      width: 48px;
      height: 26px;
      border-radius: 13px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      position: relative;
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
    }
    .pricing-toggle-switch.annual {
      background: var(--accent-dim);
      border-color: var(--accent);
    }
    .pricing-toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--text-secondary);
      top: 2px;
      left: 2px;
      transition: transform var(--transition), background var(--transition);
    }
    .pricing-toggle-switch.annual::after {
      transform: translateX(22px);
      background: var(--accent);
    }
    .pricing-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: start;
      gap: 24px;
      max-width: 840px;
      margin: 0 auto;
    }
    .pricing-grid > .pricing-card {
      max-width: none;
      margin: 0;
    }
    .pricing-card-free {
      background: linear-gradient(135deg, rgba(80,165,219,0.04), rgba(124,58,237,0.04));
      border: 2px dashed var(--accent);
      border-radius: var(--radius-lg);
      padding: 36px 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(30px);
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .pricing-card-free:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(80, 165, 219, 0.1);
      border-color: #4ecdc4;
    }
    .pricing-card-free.animate-in {
      animation: fadeInUp 0.6s ease forwards;
    }
    .pricing-card-free::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--secondary));
    }
    .pricing-save-badge {
      display: inline-block;
      background: var(--success);
      color: var(--bg-primary);
      font-size: 0.72rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 3px 10px;
      border-radius: 12px;
      margin-left: 8px;
    }
    .pricing-guarantee {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }
    .pricing-guarantee svg {
      width: 16px;
      height: 16px;
      color: var(--success);
      flex-shrink: 0;
    }
    .pricing-original {
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 1.2rem;
      margin-right: 4px;
    }

    /* â”€â”€ Responsive (marketing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 720px) {
      .header-auth-user { display: none !important; }
    }
    @media (max-width: 768px) {
      .steps-row { grid-template-columns: 1fr; }
      .features-grid { grid-template-columns: 1fr; }
      .feature-card:last-child { grid-column: auto; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); }
      .testimonials-grid { grid-template-columns: 1fr; }
      .handled-grid { grid-template-columns: 1fr; }
      .dvd-grid { grid-template-columns: 1fr; }
      .pricing-grid { grid-template-columns: 1fr; max-width: 440px; }
      .pricing-card { padding: 36px 24px; }
      .hero-ctas { flex-direction: column; gap: 10px; }
    }
    @media (max-width: 480px) {
      .gallery-grid { grid-template-columns: 1fr; }
    }

    /* â”€â”€ Error Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.4;
      max-width: 380px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      animation: toastSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(12px);
    }
    .toast-error {
      background: rgba(220, 38, 38, 0.9);
      color: #fff;
      border: 1px solid rgba(248, 113, 113, 0.3);
    }
    .toast-success {
      background: rgba(16, 185, 129, 0.9);
      color: #fff;
      border: 1px solid rgba(52, 211, 153, 0.3);
    }
    .toast-info {
      background: rgba(59, 130, 246, 0.9);
      color: #fff;
      border: 1px solid rgba(96, 165, 250, 0.3);
    }
    .toast-icon { font-size: 1rem; flex-shrink: 0; }
    .toast-dismiss {
      margin-left: auto;
      background: none;
      border: none;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0 0 0 8px;
    }
    .toast-dismiss:hover { color: #fff; }
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* â”€â”€ File browser file size â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .file-item-size {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: auto;
      font-family: 'JetBrains Mono', monospace;
      white-space: nowrap;
    }

    /* â”€â”€ Code editor with CodeMirror / textarea fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .code-editor-wrap {
      display: flex;
      flex: 1;
      min-height: 280px;
      border-radius: 0 0 var(--radius) var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      overflow: hidden;
      position: relative;
    }
    /* Fallback line numbers (only used when CodeMirror not loaded) */
    .code-line-numbers {
      width: 40px;
      min-width: 40px;
      padding: 12px 6px 12px 0;
      text-align: right;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.72rem;
      line-height: 1.6;
      color: rgba(100, 255, 218, 0.25);
      background: rgba(0,0,0,0.15);
      border-right: 1px solid var(--border);
      user-select: none;
      overflow: hidden;
      white-space: pre;
    }
    .code-editor-wrap textarea {
      flex: 1;
      width: 100%;
      min-height: 280px;
      padding: 12px;
      border: none;
      border-radius: 0;
      background: transparent;
      color: var(--text-primary);
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.78rem;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      tab-size: 2;
    }
    /* CodeMirror dark theme â€” matches app styling */
    .CodeMirror.cm-s-bolt-dark {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 0.78rem;
      line-height: 1.6;
      height: 100%;
      border-radius: var(--radius);
    }
    .cm-s-bolt-dark .CodeMirror-gutters {
      background: rgba(0,0,0,0.15);
      border-right: 1px solid var(--border);
      color: rgba(100, 255, 218, 0.25);
    }
    .cm-s-bolt-dark .CodeMirror-linenumber { color: rgba(80, 165, 219, 0.3); }
    .cm-s-bolt-dark .CodeMirror-cursor { border-left: 2px solid var(--accent); }
    .cm-s-bolt-dark .CodeMirror-selected { background: rgba(80, 165, 219, 0.15); }
    .cm-s-bolt-dark .CodeMirror-activeline-background { background: rgba(80, 165, 219, 0.04); }
    .cm-s-bolt-dark .cm-keyword { color: #c792ea; }
    .cm-s-bolt-dark .cm-atom { color: #f78c6c; }
    .cm-s-bolt-dark .cm-number { color: #f78c6c; }
    .cm-s-bolt-dark .cm-def { color: #82aaff; }
    .cm-s-bolt-dark .cm-variable { color: var(--text-primary); }
    .cm-s-bolt-dark .cm-variable-2 { color: #eeffff; }
    .cm-s-bolt-dark .cm-property { color: #80d8ff; }
    .cm-s-bolt-dark .cm-operator { color: #89ddff; }
    .cm-s-bolt-dark .cm-comment { color: #546e7a; font-style: italic; }
    .cm-s-bolt-dark .cm-string { color: #c3e88d; }
    .cm-s-bolt-dark .cm-string-2 { color: #f07178; }
    .cm-s-bolt-dark .cm-meta { color: #ffcb6b; }
    .cm-s-bolt-dark .cm-qualifier { color: #decb6b; }
    .cm-s-bolt-dark .cm-builtin { color: #decb6b; }
    .cm-s-bolt-dark .cm-bracket { color: #89ddff; }
    .cm-s-bolt-dark .cm-tag { color: #f07178; }
    .cm-s-bolt-dark .cm-attribute { color: #c792ea; }
    .cm-s-bolt-dark .cm-hr { color: #546e7a; }
    .cm-s-bolt-dark .cm-link { color: #c792ea; }
    .cm-s-bolt-dark .cm-error { color: #ff5370; }
    .cm-s-bolt-dark .CodeMirror-matchingbracket { color: #80d8ff !important; text-decoration: underline; }
    .code-editor-wrap .CodeMirror { flex: 1; height: auto; min-height: 280px; }
    /* Editor toolbar */
    .editor-toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin-bottom: 0;
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.95), rgba(15, 15, 42, 0.98));
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .editor-toolbar-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 5px 10px;
      font-size: 0.7rem;
      font-weight: 500;
      transition: color 0.15s, border-color 0.15s, background 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      position: relative;
    }
    .editor-toolbar-btn:hover {
      color: var(--accent);
      border-color: rgba(80, 165, 219, 0.25);
      background: rgba(80, 165, 219, 0.08);
    }
    .editor-toolbar-btn svg { flex-shrink: 0; }
    .editor-toolbar-sep {
      width: 1px;
      height: 18px;
      background: rgba(255,255,255,0.06);
      margin: 0 2px;
    }
    /* Files modal toolbar compact â€” seamlessly merged with file list */
    .files-toolbar-compact {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 7px 12px;
      margin-bottom: 0;
      background: linear-gradient(145deg, rgba(22, 22, 53, 0.95), rgba(15, 15, 42, 0.98));
      border: 1px solid var(--border);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .files-breadcrumb-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.58rem;
      font-weight: 600;
      color: rgba(148,163,184,0.45);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      flex-shrink: 0;
      padding: 2px 8px 2px 0;
      background: none;
      border: none;
      border-right: 1px solid rgba(255,255,255,0.04);
      border-radius: 0;
      margin-right: 8px;
    }
    .files-toolbar-compact .files-breadcrumb {
      font-size: 0.7rem;
      color: rgba(148,163,184,0.55);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 2px 6px;
      background: none;
      border-radius: 0;
      border: none;
    }
    .files-breadcrumb.editor-filename {
      color: var(--text-primary);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace;
      font-size: 0.72rem;
      font-weight: 500;
      flex: 0 1 auto;
      padding: 2px 8px;
      background: rgba(80,165,219,0.06);
      border-radius: 4px;
      border: 1px solid rgba(80,165,219,0.1);
    }
  </style>

  <!-- PostHog Tracking -->
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing startSessionRecording stopSessionRecording isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getBootstrapData setPersonProperties setPersonPropertiesForFlags".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    /* __POSTHOG_INIT__ - replaced at serve time by Worker with real API key */
    var __phKey = document.querySelector('meta[name="x-posthog-key"]');
    if (__phKey && __phKey.content && __phKey.content !== 'none') {
      posthog.init(__phKey.content, { api_host: 'https://us.i.posthog.com', person_profiles: 'identified_only' });
    }
  </script>
  <script src="https://js.stripe.com/v3/" async></script>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T48Z6BJJ"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Background orbs -->
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a class="logo" onclick="navigateTo('search')">
        <img src="/logo-header.svg" alt="Project Sites" style="flex-shrink:0; height:auto; max-height:48px; max-width:300px;">
      </a>
      <div id="header-auth" class="header-auth">
        <span id="header-auth-user" class="header-auth-user" style="display:none;"></span>
        <button id="header-auth-btn" class="header-auth-btn" onclick="handleHeaderAuth()" data-tooltip="Sign in to manage sites">Sign In</button>
      </div>
    </div>
  </header>

  <!-- Admin Dashboard Panel (visible when logged in) -->
  <div id="admin-panel" class="admin-panel">
    <div class="admin-panel-inner">
      <!-- Header Row -->
      <div class="admin-panel-header">
        <div class="admin-panel-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          <span>Your Websites</span>
          <span id="admin-site-count" class="admin-site-count"></span>
          <span id="admin-credits-pill" class="credits-pill" style="display:none;"></span>
        </div>
        <div class="admin-panel-actions">
          <button class="admin-btn" id="admin-refresh-btn" onclick="loadAdminDashboard()" data-tooltip="Reload all sites" aria-label="Refresh dashboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </button>
          <button class="admin-btn" id="admin-billing-btn" onclick="openBillingPortal()" data-tooltip="Manage subscription" aria-label="Billing portal">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Billing
          </button>
          <button class="admin-btn admin-btn-accent" onclick="openNewWebsiteModal()" data-tooltip="Create a new website">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Website
          </button>
        </div>
      </div>

      <!-- Domain Summary Bar -->
      <div id="domain-summary-bar" class="domain-summary-bar" style="display:none;">
        <div class="domain-stat">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Domains: <span class="domain-stat-value" id="domain-total-count">0</span>
        </div>
        <div class="domain-stat">
          <span class="domain-stat-dot active"></span>
          Active: <span class="domain-stat-value" id="domain-active-count">0</span>
        </div>
        <div class="domain-stat">
          <span class="domain-stat-dot pending"></span>
          Pending: <span class="domain-stat-value" id="domain-pending-count">0</span>
        </div>
        <div class="domain-stat">
          <span class="domain-stat-dot failed"></span>
          Failed: <span class="domain-stat-value" id="domain-failed-count">0</span>
        </div>
      </div>

      <!-- Sites Grid -->
      <div id="admin-sites-grid" class="site-grid">
        <div class="admin-empty">Loading your websites...</div>
      </div>

      <!-- Billing info moved to per-site cards -->
    </div>
  </div>

  <!-- Domain Management Modal -->
  <div id="domain-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Manage Domains" onclick="if(event.target===this)closeDomainModal()">
    <div class="modal" style="max-width:520px;min-height:440px;padding:24px 26px;">
      <div class="modal-title">
        <span id="domain-modal-title">Manage Domains</span>
        <button class="modal-close" onclick="closeDomainModal()">&times;</button>
      </div>

      <!-- Tabs -->
      <div class="domain-tabs" role="tablist" aria-label="Domain management tabs">
        <button class="domain-tab active" id="domain-tab-existing" role="tab" aria-selected="true" aria-controls="domain-panel-existing" onclick="switchDomainTab('existing')" data-tooltip="View connected domains">Your Domains</button>
        <button class="domain-tab" id="domain-tab-connect" role="tab" aria-selected="false" aria-controls="domain-panel-connect" onclick="switchDomainTab('connect')" data-tooltip="Connect a domain you own">Connect Domain</button>
        <button class="domain-tab" id="domain-tab-register" role="tab" aria-selected="false" aria-controls="domain-panel-register" onclick="switchDomainTab('register')" data-tooltip="Search and register a new domain">Register New</button>
      </div>

      <!-- Tab: Existing Domains -->
      <div id="domain-panel-existing" role="tabpanel" aria-labelledby="domain-tab-existing">
        <div id="domain-modal-hostnames" class="hostname-list"></div>
        <div style="margin-top:10px;font-size:0.68rem;color:var(--text-muted);line-height:1.4;text-align:center;">Set a primary domain to enable automatic redirects.</div>
      </div>

      <!-- Tab: Connect Domain (CNAME) -->
      <div id="domain-panel-connect" role="tabpanel" aria-labelledby="domain-tab-connect" style="display:none;">
        <div style="margin-bottom:12px;font-size:0.75rem;color:var(--text-secondary);line-height:1.5;">Point a CNAME to <code style="background:rgba(80,165,219,0.1);padding:1px 5px;border-radius:3px;font-size:0.7rem;color:var(--accent);">sites.megabyte.space</code> then add your domain below.</div>
        <div class="hostname-add-form">
          <label for="domain-add-input" class="sr-only">Domain name</label>
          <input type="text" id="domain-add-input" inputmode="url" placeholder="www.mybusiness.com" onkeydown="if(event.key==='Enter'){event.preventDefault();addHostname();}" />
          <button id="domain-add-btn" onclick="addHostname()" data-tooltip="Connect a custom domain">Add</button>
        </div>
        <div id="domain-connect-upgrade-cta" style="display:none;margin-top:14px;padding:14px 18px;background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(80,165,219,0.06));border:1px solid rgba(124,58,237,0.15);border-radius:10px;text-align:center;">
          <div style="font-size:0.82rem;font-weight:600;color:var(--text-primary);margin-bottom:4px;">Unlock Custom Domains</div>
          <div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:10px;">SSL, CDN, and DNS management included</div>
          <button class="btn btn-accent" onclick="openBillingCheckout()" style="padding:8px 22px;font-size:0.78rem;font-weight:600;border-radius:8px;">Upgrade</button>
        </div>
        <div id="domain-cname-status" style="display:none;margin-top:10px;"></div>
        <div style="margin-top:10px;font-size:0.65rem;color:var(--text-muted);text-align:center;line-height:1.4;">We'll monitor DNS until it resolves. Usually 24&ndash;72 hours.</div>
      </div>

      <!-- Tab: Register New Domain -->
      <div id="domain-panel-register" role="tabpanel" aria-labelledby="domain-tab-register" style="display:none;">
        <div style="margin-bottom:12px;font-size:0.75rem;color:var(--text-secondary);line-height:1.5;">Search for available domains. Pricing shown per year.</div>
        <div class="domain-search-wrap">
          <label for="domain-search-input" class="sr-only">Domain search</label>
          <input type="text" id="domain-search-input" class="domain-search-input" inputmode="url" placeholder="Search for a domain name..." autocomplete="off" />
          <div id="domain-search-results" class="domain-search-results"></div>
        </div>
        <div id="domain-search-spinner" style="text-align:center;padding:16px;display:none;">
          <span class="loading-dots"><span></span><span></span><span></span></span>
        </div>
      </div>

      <div id="domain-modal-msg" class="msg" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- R2 File Browser Modal -->
  <div id="files-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="File Browser" onclick="if(event.target===this)closeFilesModal()">
    <div class="modal" style="max-width:720px;min-height:500px;display:flex;flex-direction:column;">
      <div class="modal-title" style="display:flex;align-items:center;gap:8px;">
        <span id="files-modal-title" style="flex:1;">Files</span>
        <span id="files-count" style="font-size:0.68rem;color:var(--text-muted);"></span>
        <button class="editor-toolbar-btn" onclick="loadFilesForSite()" data-tooltip="Refresh file list" aria-label="Refresh file list"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Refresh</button>
        <button class="modal-close" onclick="closeFilesModal()">&times;</button>
      </div>
      <div id="files-toolbar" class="files-toolbar-compact">
        <span class="files-breadcrumb-label"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Path</span>
        <span id="files-breadcrumb" class="files-breadcrumb"></span>
      </div>
      <div id="files-list" style="flex:1;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius);background:var(--bg-primary);min-height:200px;"></div>
      <!-- Inline file editor -->
      <div id="files-editor" style="display:none;flex:1;flex-direction:column;min-height:300px;margin-top:10px;">
        <div class="editor-toolbar">
          <button class="editor-toolbar-btn" onclick="closeFileEditor()" data-tooltip="Back to file list" aria-label="Back to file list"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back</button>
          <span class="editor-toolbar-sep"></span>
          <!-- Filename display with inline rename (matches slug URL edit style) -->
          <div id="files-editor-name-wrap" style="display:flex;align-items:center;gap:4px;min-width:0;flex:1 1 auto;">
            <span id="files-editor-path-prefix" style="font-size:0.65rem;color:rgba(148,163,184,0.4);font-family:'SF Mono','Fira Code',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></span>
            <span id="files-editor-name" class="files-breadcrumb editor-filename" style="cursor:pointer;padding:2px 6px;border-radius:4px;border:1px solid transparent;transition:border-color 0.15s,background 0.15s;" onclick="startFileRename()" onmouseover="this.style.borderColor='rgba(80,165,219,0.2)';this.style.background='rgba(80,165,219,0.04)'" onmouseout="this.style.borderColor='transparent';this.style.background='transparent'" data-tooltip="Click to rename"></span>
            <div id="files-rename-wrap" style="display:none;align-items:center;gap:3px;flex:1;min-width:0;">
              <input type="text" id="files-rename-input" style="background:rgba(80,165,219,0.04);border:1px solid rgba(80,165,219,0.25);color:var(--text-primary);font-size:0.72rem;font-family:'SF Mono','Fira Code',Consolas,monospace;padding:2px 6px;border-radius:4px;outline:none;min-width:100px;max-width:260px;flex:1;transition:border-color 0.2s,box-shadow 0.2s;" onfocus="this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 0 2px rgba(80,165,219,0.12)'" onblur="this.style.borderColor='rgba(80,165,219,0.25)';this.style.boxShadow='none'" onkeydown="if(event.key==='Enter'){event.preventDefault();confirmFileRename();}if(event.key==='Escape'){cancelFileRename();}" />
              <button onclick="confirmFileRename()" data-tooltip="Save" aria-label="Confirm rename" style="background:none;border:none;padding:2px;cursor:pointer;color:#22c55e;display:flex;align-items:center;transition:opacity 0.15s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></button>
              <button onclick="cancelFileRename()" data-tooltip="Cancel" aria-label="Cancel rename" style="background:none;border:none;padding:2px;cursor:pointer;color:#ef4444;display:flex;align-items:center;transition:opacity 0.15s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
          </div>
          <span id="files-editor-size" style="font-size:0.68rem;color:var(--text-muted);"></span>
          <span class="editor-toolbar-sep"></span>
          <button class="editor-toolbar-btn" onclick="editorWordWrap()" data-tooltip="Toggle word wrap" aria-label="Toggle word wrap" id="editor-wrap-btn"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M3 12h15a3 3 0 1 1 0 6h-4"/><polyline points="16 16 14 18 16 20"/><path d="M3 18h7"/></svg>Wrap</button>
          <span style="flex:1;"></span>
          <span id="files-editor-lang" style="font-size:0.65rem;color:var(--text-muted);padding:3px 8px;background:rgba(255,255,255,0.03);border-radius:4px;font-family:monospace;"></span>
          <button class="btn btn-accent" id="files-save-btn" onclick="saveCurrentFile()" style="font-size:0.72rem;padding:5px 16px;border-radius:6px;font-weight:600;" data-tooltip="Save file (Ctrl+S)" aria-label="Save file">Save</button>
        </div>
        <div class="code-editor-wrap" id="code-editor-wrap">
          <!-- CodeMirror mounts here when available; fallback to textarea otherwise -->
          <div class="code-line-numbers" id="code-line-numbers" style="display:none;"></div>
          <textarea id="files-editor-content" spellcheck="false" onkeydown="handleEditorKeydown(event)" oninput="updateLineNumbers()" onscroll="syncLineScroll()" style="display:none;"></textarea>
        </div>
        <div id="files-editor-msg" class="msg" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Delete Site" onclick="if(event.target===this)closeDeleteModal()">
    <div class="modal" style="max-width:440px;">
      <div class="modal-title">
        <span>Delete Website?</span>
        <button class="modal-close" onclick="closeDeleteModal()" aria-label="Close">&times;</button>
      </div>
      <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">This will permanently remove <strong id="delete-modal-name"></strong> and its domains. This cannot be undone.</p>
      <div id="delete-modal-sub-option" style="display:none;margin-bottom:16px;padding:12px;background:rgba(100,255,218,0.05);border:1px solid rgba(100,255,218,0.12);border-radius:8px;">
        <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;font-size:0.82rem;color:var(--text-secondary);">
          <input type="checkbox" id="delete-cancel-sub" style="margin-top:3px;accent-color:var(--accent);" />
          <span>Also cancel my paid subscription. <span style="color:var(--text-muted);font-size:0.75rem;">Uncheck this if you plan to create a new site and want to keep your subscription credit.</span></span>
        </label>
      </div>
      <div id="delete-modal-msg" class="msg" style="margin-bottom:12px;"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button class="admin-btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="admin-btn" id="delete-confirm-btn" style="border-color:var(--error);color:var(--error);" onclick="confirmDeleteSite()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Site Logs Modal -->
  <div id="site-logs-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Site Activity Logs" onclick="if(event.target===this)closeSiteLogsModal()">
    <div class="modal logs-modal">
      <div class="modal-title">
        <span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Logs: <span id="logs-modal-site-name"></span></span>
        <button class="modal-close" onclick="closeSiteLogsModal()" aria-label="Close logs">&times;</button>
      </div>
      <div class="logs-toolbar">
        <span class="logs-count" id="logs-count-label"></span>
        <div style="display:flex;align-items:center;gap:4px;margin-left:auto;">
          <button class="logs-refresh-btn" onclick="copyLogsForAI()" data-tooltip="Copy logs for AI" aria-label="Copy logs in AI-friendly format">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
          <button class="logs-refresh-btn" onclick="refreshSiteLogs()" data-tooltip="Refresh logs" aria-label="Refresh logs">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </button>
        </div>
      </div>
      <div class="logs-container" id="logs-container">
        <div class="logs-empty">Loading logs...</div>
      </div>
    </div>
  </div>

  <!-- Deploy Modal (Upload ZIP / JSON) -->
  <div id="deploy-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Deploy Website" onclick="if(event.target===this)closeDeployModal()">
    <div class="modal" style="max-width:520px;">
      <div class="modal-title">
        <span id="deploy-modal-title">Deploy to Site</span>
        <button class="modal-close" onclick="closeDeployModal()">&times;</button>
      </div>
      <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:16px;">Upload your built site files. The ZIP will be extracted and deployed to your website.</p>

      <div class="input-group">
        <label for="deploy-zip-input">ZIP File <span style="color:var(--accent);">*</span></label>
        <div class="deploy-upload-zone" id="deploy-zip-zone" onclick="document.getElementById('deploy-zip-input').click()">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <div style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Click to select or drag & drop a ZIP file</div>
          <div id="deploy-zip-name" class="deploy-file-name" style="display:none;"></div>
        </div>
        <input type="file" id="deploy-zip-input" accept=".zip" style="display:none;" onchange="handleDeployZipSelect(this)" />
      </div>

      <div class="input-group">
        <label for="deploy-json-input">Chat / Document <span style="color:var(--text-muted);">(optional)</span></label>
        <div class="deploy-upload-zone" id="deploy-json-zone" onclick="document.getElementById('deploy-json-input').click()" style="padding:16px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">Chat export, markdown, PDF, or any document</div>
          <div id="deploy-json-name" class="deploy-file-name" style="display:none;"></div>
        </div>
        <input type="file" id="deploy-json-input" accept=".json,.md,.markdown,.txt,.csv,.tsv,.pdf,.doc,.docx,.rtf,.html,.htm,.xml,.yaml,.yml,.toml,.ini,.cfg,.log,.tex,.rst,.org,.adoc,.asciidoc" style="display:none;" onchange="handleDeployJsonSelect(this)" />
      </div>

      <!-- File Manager â€” appears after ZIP upload -->
      <div class="deploy-file-manager" id="deploy-file-manager">
        <div class="deploy-file-manager-header">
          <span>Select deploy folder</span>
          <span id="deploy-folder-count"></span>
        </div>
        <div id="deploy-folder-list"></div>
      </div>
      <input type="hidden" id="deploy-dist-path" value="dist/" />
      <div id="deploy-selected-info" class="deploy-selected-path" style="display:none;">
        Deploy from: <strong id="deploy-selected-folder">dist/</strong>
      </div>
      <div id="deploy-index-warning" style="display:none;padding:8px 12px;margin-top:8px;border-radius:6px;font-size:0.8rem;background:rgba(251,191,36,0.1);color:#fbbf24;border:1px solid rgba(251,191,36,0.2);"></div>

      <div id="deploy-msg" class="msg" style="margin-bottom:12px;"></div>
      <button class="btn btn-accent btn-full" id="deploy-submit-btn" onclick="submitDeploy()">Deploy</button>
    </div>
  </div>

  <!-- Stripe Embedded Checkout Modal -->
  <div id="checkout-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Upgrade to Pro" onclick="if(event.target===this)closeCheckoutModal()" style="display:none;">
    <div class="modal" style="max-width:520px;padding:0;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:between;padding:18px 22px 14px;border-bottom:1px solid var(--border);">
        <span style="font-size:1rem;font-weight:700;color:var(--text-primary);flex:1;">Upgrade to Pro</span>
        <button class="modal-close" onclick="closeCheckoutModal()" style="position:static;margin:0;">&times;</button>
      </div>
      <div id="checkout-mount" style="min-height:350px;"></div>
    </div>
  </div>

  <!-- Billing Portal Modal -->
  <div id="billing-portal-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Billing Portal" onclick="if(event.target===this)closeBillingPortalModal()" style="display:none;">
    <div class="modal" style="padding:0;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:between;padding:18px 22px 14px;border-bottom:1px solid var(--border);">
        <span style="font-size:1rem;font-weight:700;color:var(--text-primary);flex:1;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px;"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Billing &amp; Subscription</span>
        <button class="modal-close" onclick="closeBillingPortalModal()" style="position:static;margin:0;">&times;</button>
      </div>
      <div id="billing-portal-mount" style="min-height:400px;"></div>
    </div>
  </div>

  <!-- Details Modal (Describe your custom website) -->
  <div id="details-modal" class="details-modal-overlay" onclick="if(event.target===this)closeDetailsModal()">
    <div class="details-card">
      <button class="details-modal-close" onclick="closeDetailsModal()" data-tooltip="Close" aria-label="Close">&times;</button>
      <h2 id="details-title">Describe your custom website</h2>
      <p class="details-subtitle" id="details-subtitle">Include everything important for your website. We'll also search the web for public info about your business.</p>

      <!-- Selected business display -->
      <div id="details-business-badge" class="selected-business-badge" style="display:none;">
        <div class="badge-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#50a5db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </div>
        <div class="badge-text">
          <div class="badge-name" id="badge-biz-name"></div>
          <div class="badge-addr" id="badge-biz-addr"></div>
        </div>
        <button class="badge-dismiss" onclick="dismissBusinessBadge()" data-tooltip="Clear selection" aria-label="Remove selected business">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- Manual business info (always shown with live search) -->
      <div id="details-manual-fields" style="display:none;">
        <div class="input-group details-biz-search-wrap">
          <label for="business-name-input">Business Name <span style="color:var(--accent);">*</span></label>
          <input type="text" id="business-name-input" class="input-field" inputmode="search" placeholder="e.g. Vito's Men's Salon &mdash; search to find your business" maxlength="200" required autocomplete="off" />
          <div id="details-biz-dropdown" class="details-biz-dropdown"></div>
          <p style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">Search for your business to auto-fill, or type a custom name.</p>
        </div>
        <div class="input-group" style="position:relative;">
          <label for="business-address-input">Business Address</label>
          <input type="text" id="business-address-input" class="input-field" placeholder="Start typing an address..." maxlength="500" autocomplete="off" />
          <div id="address-dropdown" class="address-dropdown"></div>
          <p style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">Select a suggestion or enter a custom address.</p>
        </div>
        <!-- Google Place ID info (shown when a business is selected from search) -->
        <div id="details-place-id-info" style="display:none;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(100,255,218,0.05);border:1px solid rgba(100,255,218,0.15);border-radius:var(--radius);font-size:0.72rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <span style="color:var(--text-secondary);flex:1;">Google Place ID: <a id="details-place-id-text" href="#" target="_blank" rel="noopener noreferrer" style="color:var(--accent);font-size:0.68rem;font-family:monospace;text-decoration:underline;text-underline-offset:2px;"></a></span>
            <button onclick="removeGooglePlaceId()" data-tooltip="Remove Place ID" aria-label="Remove Google Place ID" style="background:none;border:none;cursor:pointer;padding:2px;line-height:1;color:var(--text-muted);font-size:1rem;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1';this.style.color='var(--accent)'" onmouseout="this.style.opacity='0.7';this.style.color='var(--text-muted)'">&times;</button>
          </div>
        </div>
      </div>

      <div class="input-group" style="position:relative;">
        <label for="details-textarea">Tell us about your business <a class="improve-ai-link" onclick="improveWithAI()" id="improve-ai-btn" data-tooltip="Let AI enhance your description"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Improve with AI</a></label>
        <div style="position:relative;">
          <textarea
            id="details-textarea"
            class="input-field"
            maxlength="5000"
            placeholder="Share details like your phone number, email address, physical address, business hours, services offered, brand colors, style preferences, or any specific features you'd like on your website. On top of the information you provide here, we'll also intelligently search the internet for public data about your business to help build the best possible site."
          ></textarea>
          <div class="improve-ai-overlay" id="improve-ai-overlay">
            <div class="improve-ai-spinner"></div>
            <div class="improve-ai-text">Improving with AI...</div>
          </div>
        </div>
      </div>

      <div class="uppy-section">
        <label id="uppy-label">Upload Logos, Photos, Menus, or Documents</label>
        <div id="uppy-dashboard-area" role="group" aria-labelledby="uppy-label"></div>
      </div>

      <button class="btn btn-accent btn-large btn-full" id="build-btn" onclick="submitBuild()">
        Build My Website
      </button>

      <div id="build-msg" class="msg"></div>
    </div>
  </div>

  <!-- App Container -->
  <div class="app">

    <!-- ==========================================
         Screen 1: Hero / Search
         ========================================== -->
    <div id="screen-search" class="screen screen-search active">
      <div class="hero-brand">
        <h1>Your Website &mdash;<br><span class="gradient-text">Handled. Finally.</span></h1>
        <p class="tagline">AI builds your business website in minutes. We handle hosting, updates, and everything else &mdash; for $50/mo.</p>
      </div>

      <div class="search-wrapper">
        <div class="search-input-wrap">
          <span class="search-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
          </span>
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Enter your business name..."
            autocomplete="off"
            spellcheck="false"
          />
          <div id="search-spinner" class="search-spinner"></div>
        </div>

        <div id="search-dropdown" class="search-dropdown"></div>
      </div>

      <p class="search-hint">Search for your business to generate a free preview &mdash; no account or credit card required.</p>

      <div class="hero-ctas">
        <button class="btn btn-accent" onclick="startBuildFlow()">Build Your Free Website</button>
        <a href="#how-it-works" class="btn-ghost">How it works &darr;</a>
      </div>
      <p class="hero-clarify"><strong>Free preview</strong> includes a full AI-generated site. Pay only when you're ready to go live.</p>

      <div id="search-error" class="msg msg-error"></div>

      <!-- ==========================================
           Marketing Sections (scroll down)
           ========================================== -->
      <div class="marketing-sections">

        <!-- Anchor for scroll targets -->
        <section id="proof"></section>

        <!-- How It Works -->
        <section id="how-it-works">
          <h2 class="section-title">How It Works</h2>
          <p class="section-subtitle">Three steps. Five minutes. Zero technical skills. <strong style="color:var(--text-primary);">No account needed until you're ready to go live.</strong></p>
          <div class="steps-row">
            <div class="step-card">
              <div class="step-number">1</div>
              <h3>Search &amp; Preview Free</h3>
              <p>Type your business name above. Our AI pulls data from Google, social profiles, and public listings &mdash; then builds a full preview site in minutes. <strong>No sign-up. No credit card.</strong></p>
            </div>
            <div class="step-card">
              <div class="step-number">2</div>
              <h3>Review &amp; Customize</h3>
              <p>Get a mobile-first site with original copy, local SEO, and legal pages. Add details, upload photos, or hit "Improve with AI" to polish it. Your preview is live and shareable immediately.</p>
            </div>
            <div class="step-card">
              <div class="step-number">3</div>
              <h3>Go Live on Your Domain</h3>
              <p>Sign in and upgrade to connect your own domain (or buy one through us at cost). We handle hosting, SSL, performance, and ongoing updates. <strong>$50/mo &mdash; everything included.</strong></p>
            </div>
          </div>

          <!-- ROI anchor + no-account microcopy -->
          <div style="text-align:center;margin-top:28px;display:flex;flex-direction:column;gap:10px;align-items:center;">
            <p style="color:var(--text-muted);font-size:0.85rem;max-width:540px;">Most small businesses spend $2,000&ndash;$5,000 on a website that takes weeks. With Project Sites, yours is live in five minutes for $50/mo &mdash; with unlimited changes included.</p>
            <button class="btn btn-accent" onclick="startBuildFlow()" style="margin-top:4px;">See My Free Preview</button>
          </div>
        </section>

        <!-- What's Handled (value prop) -->
        <section id="handled">
          <h2 class="section-title">What "Handled" Actually Means</h2>
          <p class="section-subtitle">Everything you need to run a professional web presence &mdash; without lifting a finger.</p>

          <div class="handled-grid">
            <div class="handled-card">
              <div class="handled-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                </svg>
              </div>
              <h3>Unlimited AI Edits</h3>
              <p>Change hours, add services, swap photos, rewrite copy &mdash; anytime. Use the built-in <a href="https://bolt.megabyte.space" target="_blank" rel="noopener noreferrer" style="color:var(--accent);font-weight:600;">Project Sites Editor &rarr;</a> or just tell us what you want. Changes go live instantly.</p>
            </div>
            <div class="handled-card">
              <div class="handled-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
              </div>
              <h3>Hosting, SSL &amp; Security</h3>
              <p>Cloudflare edge hosting, automatic SSL, DDoS protection, and 99.9% uptime. Your site loads in under 1 second from 300+ global locations. No server bills, no config.</p>
            </div>
            <div class="handled-card">
              <div class="handled-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                </svg>
              </div>
              <h3>SEO &amp; Local Search</h3>
              <p>Schema markup, meta tags, sitemaps, and performance tuning &mdash; baked in from day one. Built on 15+ years of engineering experience so your business ranks where customers are searching.</p>
            </div>
          </div>

          <!-- Concrete "what's included" bullets -->
          <div class="handled-summary">
            <strong>Included in every paid plan:</strong> Custom domain support (bring your own, or buy through us at registrar cost) &middot; Unlimited change requests &middot; AI-powered content editor &middot; Mobile-responsive design &middot; Legal pages (privacy &amp; terms) &middot; Analytics dashboard &middot; Priority support &middot; No contracts, cancel anytime
          </div>
        </section>

        <!-- Social Proof / Trust Signals -->
        <section id="trust" style="padding:40px 0 20px;">
          <div class="trust-bar">
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              <span>SSL &amp; DDoS Protection</span>
            </div>
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <span>99.9% Uptime Guarantee</span>
            </div>
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
              <span>No Contracts, Cancel Anytime</span>
            </div>
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              <span>Priority Support Included</span>
            </div>
          </div>
        </section>

        <!-- Done-for-you vs DIY -->
        <section id="dvd">
          <h2 class="section-title">Done-for-You vs. DIY</h2>
          <p class="section-subtitle">Other platforms give you tools. We give you a finished website &mdash; and keep it running.</p>

          <div class="dvd-grid">
            <div class="dvd-column dvd-highlight">
              <div class="dvd-header">Project Sites (Done-for-You)</div>
              <ul class="dvd-list">
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  AI writes your content from real business data
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Site designed and launched in minutes
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Unlimited change requests &mdash; we do the work
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Hosting, SSL, domain, SEO &mdash; all included
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Ongoing maintenance handled for you
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  No technical skills required &mdash; ever
                </li>
              </ul>
            </div>
            <div class="dvd-column dvd-other">
              <div class="dvd-header">DIY Builders (Squarespace, Wix, etc.)</div>
              <ul class="dvd-list">
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  You write all content yourself (AI assist available)
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  Hours to days learning the builder + designing
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  Every update is your responsibility
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  Domain, SEO plugins, and extras cost more
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  You manage updates, security, and performance
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  Requires learning a page builder interface
                </li>
              </ul>
            </div>
          </div>
        </section>

        <!-- FAQ -->
        <section id="faq">
          <h2 class="section-title">Frequently Asked Questions</h2>
          <p class="section-subtitle">Everything you need to know before getting started.</p>

          <div class="faq-list">
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                How does the AI build my website?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">When you search for your business, we pull data from Google Places, public listings, and social profiles. Our AI then runs a multi-step pipeline: it researches your business profile, analyzes your brand identity and services, generates selling points, creates a fully designed website with responsive layouts, and produces legal pages (privacy policy &amp; terms of service). The whole process takes just a few minutes and you can watch each step in real time.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                How accurate is the AI-generated content?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">Our AI researches your business using Google Places data, public listings, social media profiles, and any additional context you provide. It generates original content specific to your services, location, and industry. Every site goes through an 8-dimension quality scoring check. You can review and request changes before going live.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                What's included in the free preview?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">The free preview gives you a fully AI-generated website hosted on a subdomain (e.g. your-business-sites.megabyte.space) &mdash; no credit card required. It includes AI-generated content, responsive mobile design, privacy policy, and terms of service. The site is live and accessible immediately. Upgrade when you want a custom domain and to remove the branding bar.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                Can I use my own domain?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">Yes. On a paid plan, you can connect your own domain by pointing a CNAME record to sites.megabyte.space. SSL is automatic. You can also purchase a premium domain directly through us. Free sites are hosted on a subdomain (your-slug-sites.megabyte.space).</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                Can I edit the website after it's built?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">Yes. You can rebuild your site at any time from the admin dashboard &mdash; just click "Reset" to regenerate with updated info, or use the AI Editor to make changes directly. You can also upload your own HTML/CSS builds via the deploy feature. No page builders to learn, no code to write.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                What if my business isn't on Google?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">No problem. You can choose "Build a custom website" and manually enter your business name, address, and description. The AI will use whatever you provide, plus anything it can find from public web sources, to build your site. The more details you share, the better the result.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                Do I own the website and content?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">Yes. All content generated for your site belongs to you. If you cancel, you can export your site files. Your business data is never shared or sold. Sites are hosted on Cloudflare's global CDN for fast loading worldwide.</div></div>
            </div>
            <div class="faq-item">
              <button class="faq-question" onclick="toggleFaq(this)">
                What happens if I cancel?
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="faq-answer"><div class="faq-answer-inner">You can cancel anytime. Your site stays live through the end of your billing period. After that, it reverts to the free tier (subdomain hosting with a branding bar). We offer a 14-day money-back guarantee on your first payment.</div></div>
            </div>
          </div>
        </section>

        <!-- Pricing -->
        <section id="pricing">
          <h2 class="section-title">Simple, Transparent Pricing</h2>
          <p class="section-subtitle">Start free. Pay only when you're ready to go live.</p>

          <div id="pricing-toggle" class="pricing-toggle">
            <span class="pricing-toggle-label active" id="toggle-monthly">Monthly</span>
            <div class="pricing-toggle-switch" id="toggle-switch" onclick="togglePricing()"></div>
            <span class="pricing-toggle-label" id="toggle-annual">Annual <span class="pricing-save-badge">Save $120</span></span>
          </div>

          <div class="pricing-grid">
            <div class="pricing-card-free">
              <div class="plan-label" style="background:linear-gradient(135deg, var(--accent), var(--secondary)); color:#fff;">Free Preview</div>
              <div class="pricing-price">$0</div>
              <p class="pricing-desc">See your AI-generated site before committing.</p>
              <ul class="pricing-features">
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Full AI-generated website preview
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  No account or credit card required
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Hosted on free subdomain
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Includes "Powered by Project Sites" banner
                </li>
              </ul>
              <button class="btn btn-secondary-outline btn-large btn-full" onclick="openDetailsModal()">
                Generate Free Preview
              </button>
            </div>

            <div class="pricing-card">
              <div class="plan-label">All-Inclusive</div>
              <div class="pricing-price" id="pricing-amount">$50<span>/mo</span></div>
              <p class="pricing-desc" id="pricing-desc-text">Everything you need from a business website.</p>
              <ul class="pricing-features">
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  AI-generated content &amp; design
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Custom domain + SSL included
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Mobile-first, SEO-optimized
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Built-in analytics dashboard
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Unlimited updates &amp; maintenance
                </li>
                <li>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  No branding &mdash; 100% your brand
                </li>
              </ul>
              <button class="btn btn-accent btn-large btn-full" onclick="handleGetStartedPaid()">
                Get Started
              </button>
              <div class="pricing-guarantee">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                14-day money-back guarantee &mdash; cancel anytime
              </div>
            </div>
          </div>
        </section>

        <!-- Contact Form -->
        <section id="contact-section" style="padding:60px 0;">
          <h2 class="section-title">Get in Touch</h2>
          <p class="section-subtitle">Have a question, feedback, or need help? We'd love to hear from you.</p>

          <div style="max-width:600px;margin:0 auto;">
            <form id="contact-form" onsubmit="event.preventDefault();submitContactForm();" novalidate>
              <div class="input-group">
                <label for="contact-name">Name <span style="color:var(--accent);">*</span></label>
                <input type="text" id="contact-name" class="input-field" placeholder="Your full name" maxlength="200" required />
              </div>
              <div class="input-group">
                <label for="contact-email">Email <span style="color:var(--accent);">*</span></label>
                <input type="email" id="contact-email" class="input-field" placeholder="you@example.com" maxlength="254" required />
              </div>
              <div class="input-group">
                <label for="contact-phone">Phone <span style="color:var(--text-muted);">(optional)</span></label>
                <input type="tel" id="contact-phone" class="input-field" placeholder="+1 (555) 123-4567" maxlength="20" />
              </div>
              <div class="input-group">
                <label for="contact-message">Message <span style="color:var(--accent);">*</span></label>
                <textarea id="contact-message" class="input-field" placeholder="How can we help you?" maxlength="5000" required style="min-height:150px;"></textarea>
              </div>
              <button class="btn btn-accent btn-large btn-full" id="contact-submit-btn" type="submit">
                Send Message
              </button>
              <div id="contact-msg" class="msg"></div>
            </form>
          </div>
        </section>

      </div><!-- /.marketing-sections -->
    </div>

    <!-- ==========================================
         Screen 3: Sign-In Gate
         ========================================== -->
    <div id="screen-signin" class="screen screen-signin">
      <div class="signin-card">
        <div style="margin-bottom:24px;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="url(#signin-lock-grad)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:12px;filter:drop-shadow(0 0 8px rgba(80,165,219,0.2));"><defs><linearGradient id="signin-lock-grad" x1="0" y1="0" x2="24" y2="24"><stop offset="0%" stop-color="#50a5db"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient></defs><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <h2>Sign in to claim your website</h2>
        <p class="signin-subtitle">Create your account to get started with your AI-powered site.</p>

        <!-- Main sign-in options -->
        <div id="signin-methods" class="signin-methods">
          <button class="signin-btn signin-btn-google" onclick="signInWithGoogle()">
            <svg width="20" height="20" viewBox="0 0 48 48">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Continue with Google
          </button>

          <div class="signin-divider">or</div>

          <button class="signin-btn" onclick="showSigninPanel('email')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
            Sign in with Email
          </button>
        </div>

        <!-- Email panel -->
        <div id="signin-email-panel" class="signin-panel">
          <div id="email-step-input">
            <div class="input-group">
              <label for="email-input">Email Address</label>
              <input type="email" id="email-input" class="input-field" placeholder="you@example.com" />
            </div>
            <button class="btn btn-accent btn-full" id="email-send-btn" onclick="sendMagicLink()">
              Send Magic Link
            </button>
            <div id="email-send-msg" class="msg"></div>
          </div>

          <div id="email-step-sent" style="display:none;">
            <div class="msg msg-success visible" style="text-align:center; margin-top:12px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block; vertical-align:middle; margin-right:6px;">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
              </svg>
              Check your email for a sign-in link!
            </div>
          </div>

          <button class="back-link" onclick="showSigninPanel('main')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to sign-in options
          </button>
        </div>

        <!-- Back to search -->
        <button class="back-link" id="signin-back-to-search" onclick="navigateTo('search')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Back to search
        </button>
      </div>
      <!-- Compact signin-only footer -->
      <div class="signin-footer">
        <div class="signin-footer-social">
          <a href="https://github.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
          <a href="https://x.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="X"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
          <a href="https://www.linkedin.com/in/blzalewski" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
          <a href="https://www.youtube.com/@HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="YouTube"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
          <a href="https://www.instagram.com/heymegabyteofficial/" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg></a>
          <a href="https://www.facebook.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
        </div>
        <div class="signin-footer-legal">
          &copy; 2026 <a href="https://megabyte.space" target="_blank" rel="noopener noreferrer">Megabyte LLC</a>
          &middot; <a href="/privacy">Privacy</a>
          &middot; <a href="/terms">Terms</a>
        </div>
      </div>
    </div>

    <!-- Details screen is now a modal, kept as hidden placeholder -->
    <div id="screen-details" class="screen screen-details" style="display:none !important;"></div>

    <!-- ==========================================
         Screen 4: Waiting (Lottie Cat)
         ========================================== -->
    <div id="screen-waiting" class="screen screen-waiting">
      <div class="waiting-content">
        <div class="waiting-anim">
          <div class="waiting-anim-ring"></div>
          <div class="waiting-anim-ring"></div>
          <div class="waiting-anim-ring"></div>
          <div class="waiting-anim-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/>
              <circle cx="7.5" cy="6" r="0.8" fill="var(--accent)" stroke="none"/><circle cx="10.5" cy="6" r="0.8" fill="#7c3aed" stroke="none"/>
              <line x1="7" y1="13" x2="17" y2="13" opacity="0.5"/><line x1="7" y1="16.5" x2="14" y2="16.5" opacity="0.35"/>
            </svg>
          </div>
        </div>

        <h2 class="waiting-title">We're building your website...</h2>
        <p class="waiting-subtitle">Give us a few minutes. We'll notify you when it's ready.</p>

        <!-- Build Progress Terminal -->
        <div class="build-terminal" id="build-terminal">
          <div class="build-terminal-header">
            <div class="build-terminal-dot red"></div>
            <div class="build-terminal-dot yellow"></div>
            <div class="build-terminal-dot green"></div>
            <span class="build-terminal-title" id="build-terminal-title">build-progress</span>
          </div>
          <div class="build-terminal-body" id="build-terminal-body">
            <div class="build-terminal-line active">Initializing build pipeline...</div>
          </div>
        </div>
      </div>
    </div>

  </div>


  <!-- Location Permission Modal -->
  <div id="location-modal" class="location-modal-overlay" style="display:none;">
    <div class="location-modal">
      <div class="location-modal-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
        </svg>
      </div>
      <h3>Enable location for better results?</h3>
      <p>We can show businesses near you and sort results by distance. Your location is never stored or shared.</p>
      <div class="location-modal-actions">
        <button class="btn-skip" onclick="dismissLocationModal()">Skip</button>
        <button class="btn-allow" onclick="allowLocation()">Allow</button>
      </div>
    </div>
  </div>

  <!-- Footer CTA -->
  <div id="footer-cta" style="text-align:center;padding:48px 24px 0;position:relative;z-index:1;">
    <div style="max-width:640px;margin:0 auto;padding:36px 32px;background:linear-gradient(135deg,rgba(80,165,219,0.08),rgba(124,58,237,0.08));border:1px solid var(--border);border-radius:var(--radius-lg);animation:fadeInUp 0.6s ease both;">
      <h3 style="font-size:1.4rem;font-weight:800;margin-bottom:8px;letter-spacing:-0.02em;">Your Website Is 5 Minutes Away</h3>
      <p style="color:var(--text-secondary);font-size:1rem;margin-bottom:20px;">See your free AI-generated preview &mdash; no account, no credit card, no commitment.</p>
      <button class="btn btn-accent btn-large" onclick="startBuildFlow()">Get Started Now</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-links"></div>
      <div class="footer-social">
        <!-- GitHub -->
        <a href="https://github.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
        <!-- X / Twitter -->
        <a href="https://x.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="X">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        </a>
        <!-- LinkedIn -->
        <a href="https://www.linkedin.com/in/blzalewski" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
        </a>
        <!-- YouTube -->
        <a href="https://www.youtube.com/@HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
        </a>
        <!-- Instagram -->
        <a href="https://www.instagram.com/heymegabyteofficial/" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>
        </a>
        <!-- Facebook -->
        <a href="https://www.facebook.com/HeyMegabyte" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
        </a>
      </div>
      <div class="footer-bottom">
        <span>&copy; 2026 <a href="https://megabyte.space" target="_blank" rel="noopener noreferrer">Megabyte LLC</a></span>
        <span><a href="/privacy">Privacy Policy</a> | <a href="/terms">Terms of Service</a> | <a href="/content">Content Policy</a></span>
      </div>
    </div>
  </footer>

  <!-- Uppy -->
  <script src="https://releases.transloadit.com/uppy/v4.12.1/uppy.min.js"></script>
  <!-- JSZip for deploy file manager -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    /* ===========================================================
       Unified Analytics (GA + PostHog)
       =========================================================== */
    function trackEvent(eventName, props) {
      // Google Analytics
      if (typeof gtag === 'function') {
        gtag('event', eventName, props || {});
      }
      // PostHog
      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture(eventName, props || {});
      }
    }

    /* ===========================================================
       State Machine
       =========================================================== */
    var state = {
      screen: 'search',
      searchQuery: '',
      searchResults: [],
      preBuiltResults: [],
      selectedBusiness: null,
      mode: 'business',      // 'business' | 'custom'
      session: null,          // { token, identifier }
      siteId: null,
      slug: null,
      signinPanel: 'main',   // 'main' | 'email'
      userLat: null,
      userLng: null
    };

    /* ===========================================================
       Session Persistence + Navbar Auth
       =========================================================== */
    function saveSession() {
      if (state.session && state.session.token) {
        try { localStorage.setItem('ps_session', JSON.stringify(state.session)); } catch(e) {}
      }
    }

    function clearSession() {
      state.session = null;
      try { localStorage.removeItem('ps_session'); } catch(e) {}
    }

    function updateNavAuth() {
      var userEl = document.getElementById('header-auth-user');
      var btnEl = document.getElementById('header-auth-btn');
      if (!userEl || !btnEl) return;

      if (state.session && state.session.token) {
        userEl.textContent = state.session.identifier || 'Signed In';
        userEl.style.display = '';
        btnEl.textContent = 'Sign Out';
        loadAdminDashboard();
      } else {
        userEl.style.display = 'none';
        userEl.textContent = '';
        btnEl.textContent = 'Sign In';
        hideAdminDashboard();
      }
    }

    function handleHeaderAuth() {
      if (state.session && state.session.token) {
        logout();
      } else {
        navigateTo('signin');
      }
    }

    function logout() {
      clearSession();
      updateNavAuth();
      hideAdminDashboard();
      navigateTo('search');
    }

    /* ===========================================================
       Admin Dashboard
       =========================================================== */
    var adminSites = [];
    var adminSubscription = null;
    var adminDomainModalSiteId = null;

    function loadAdminDashboard() {
      var panel = document.getElementById('admin-panel');
      if (!panel || !state.session || !state.session.token) return;
      panel.classList.add('visible');

      var headers = { 'Authorization': 'Bearer ' + state.session.token };

      // Load sites + subscription + domain summary in parallel
      var sitesP = fetch('/api/sites', { headers: headers })
        .then(function(r) { return r.ok ? r.json() : { data: [] }; })
        .then(function(d) { return d.data || []; })
        .catch(function() { return []; });

      var subP = fetch('/api/billing/subscription', { headers: headers })
        .then(function(r) { return r.ok ? r.json() : { data: null }; })
        .then(function(d) { return d.data || null; })
        .catch(function() { return null; });

      var domainSummaryP = fetch('/api/admin/domains/summary', { headers: headers })
        .then(function(r) { return r.ok ? r.json() : { data: null }; })
        .then(function(d) { return d.data || null; })
        .catch(function() { return null; });

      Promise.all([sitesP, subP, domainSummaryP]).then(function(results) {
        adminSites = results[0];
        adminSubscription = results[1];
        state._adminSites = adminSites;
        state._adminSubscription = adminSubscription;
        renderAdminSites();
        renderAdminBilling();
        renderDomainSummary(results[2]);
        // Start real-time polling for building sites
        startSiteStatusPolling();
        // Auto-reopen domain modal if returning from Stripe
        checkPendingDomain();
      });
    }

    function renderDomainSummary(summary) {
      var bar = document.getElementById('domain-summary-bar');
      if (!bar) return;
      if (!summary || !summary.total) {
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'flex';
      var totalEl = document.getElementById('domain-total-count');
      var activeEl = document.getElementById('domain-active-count');
      var pendingEl = document.getElementById('domain-pending-count');
      var failedEl = document.getElementById('domain-failed-count');
      if (totalEl) totalEl.textContent = summary.total;
      if (activeEl) activeEl.textContent = summary.by_status ? summary.by_status.active : 0;
      if (pendingEl) pendingEl.textContent = summary.by_status ? summary.by_status.pending : 0;
      if (failedEl) failedEl.textContent = summary.by_status ? summary.by_status.verification_failed : 0;
    }

    function hideAdminDashboard() {
      var panel = document.getElementById('admin-panel');
      if (panel) panel.classList.remove('visible');
    }

    /** Map a site status to a human-readable label for the status badge. */
    function mapStatusLabel(status) {
      var labels = {
        'published': 'Live',
        'building': 'Building',
        'queued': 'Queued',
        'collecting': 'Collecting Data',
        'generating': 'Generating',
        'uploading': 'Uploading',
        'error': 'Error',
        'failed': 'Error',
        'draft': 'Draft'
      };
      return labels[status] || status.charAt(0).toUpperCase() + status.slice(1);
    }

    /** Map a site status to a tooltip description. */
    function mapStatusTooltip(status) {
      var tips = {
        'published': 'Site is live and publicly accessible',
        'building': 'Site is currently being built',
        'queued': 'Waiting in the build queue',
        'collecting': 'Gathering business data',
        'generating': 'AI is generating site content',
        'uploading': 'Uploading files to CDN',
        'error': 'Build failed \u2014 check logs for details',
        'failed': 'Build failed \u2014 check logs for details',
        'draft': 'Not yet published'
      };
      return tips[status] || '';
    }

    /** Map a site status to its CSS class. */
    function mapStatusClass(status) {
      if (status === 'failed') return 'error';
      return status;
    }

    /** Real-time status polling for building sites (lightweight, 5s interval). */
    var siteStatusPollTimer = null;
    function startSiteStatusPolling() {
      stopSiteStatusPolling();
      siteStatusPollTimer = setInterval(function() {
        if (!state.session || !state.session.token) return;
        if (!adminSites || !adminSites.length) return;
        var buildingSites = adminSites.filter(function(s) {
          return s.status === 'building' || s.status === 'queued' || s.status === 'collecting' || s.status === 'generating' || s.status === 'uploading';
        });
        if (!buildingSites.length) { stopSiteStatusPolling(); return; }
        // Fetch fresh site data
        fetch('/api/sites', { headers: { 'Authorization': 'Bearer ' + state.session.token } })
          .then(function(r) { return r.ok ? r.json() : { data: [] }; })
          .then(function(d) {
            var freshSites = d.data || [];
            var changed = false;
            for (var i = 0; i < freshSites.length; i++) {
              for (var j = 0; j < adminSites.length; j++) {
                if (freshSites[i].id === adminSites[j].id && freshSites[i].status !== adminSites[j].status) {
                  adminSites[j].status = freshSites[i].status;
                  adminSites[j].updated_at = freshSites[i].updated_at;
                  changed = true;
                }
              }
            }
            if (changed) {
              state._adminSites = adminSites;
              requestAnimationFrame(function() { renderAdminSites(); });
            }
          })
          .catch(function() {});
      }, 5000);
    }
    function stopSiteStatusPolling() {
      if (siteStatusPollTimer) { clearInterval(siteStatusPollTimer); siteStatusPollTimer = null; }
    }

    /* Scale preview iframe to fill card width */
    function scalePreviewIframe(iframe) {
      var container = iframe.parentElement;
      if (!container) return;
      var containerWidth = container.offsetWidth;
      var scale = containerWidth / 1440;
      iframe.style.transform = 'scale(' + scale + ')';
    }
    // Re-scale all preview iframes on window resize
    window.addEventListener('resize', function() {
      var iframes = document.querySelectorAll('.site-card-preview iframe');
      for (var i = 0; i < iframes.length; i++) scalePreviewIframe(iframes[i]);
    });

    function renderAdminSites() {
      var grid = document.getElementById('admin-sites-grid');
      if (!grid) return;

      // Determine org plan from subscription data
      var isPaidOrg = adminSubscription && adminSubscription.plan === 'paid' && adminSubscription.status === 'active';

      // Update site count badge â€” hidden until loaded
      var countEl = document.getElementById('admin-site-count');
      if (countEl) {
        if (adminSites.length) {
          countEl.textContent = adminSites.length + ' site' + (adminSites.length !== 1 ? 's' : '');
          countEl.classList.add('loaded');
        } else {
          countEl.textContent = '';
          countEl.classList.remove('loaded');
        }
      }

      // Credits pill: show how many paid slots are available
      var creditsPill = document.getElementById('admin-credits-pill');
      if (creditsPill) {
        if (isPaidOrg) {
          var subQty = (adminSubscription && adminSubscription.quantity) ? Number(adminSubscription.quantity) : 1;
          var paidSiteCount = 0;
          for (var ci = 0; ci < adminSites.length; ci++) {
            if (adminSites[ci].plan === 'paid') paidSiteCount++;
          }
          var availableCredits = Math.max(0, subQty - paidSiteCount);
          if (availableCredits > 0) {
            creditsPill.textContent = availableCredits + ' credit' + (availableCredits !== 1 ? 's' : '') + ' available';
            creditsPill.style.display = 'inline-block';
          } else {
            creditsPill.style.display = 'none';
          }
        } else {
          creditsPill.style.display = 'none';
        }
      }

      if (!adminSites.length) {
        grid.innerHTML = '<div class="site-card-new" tabindex="0" role="button" onclick="openNewWebsiteModal()" onkeydown="if(event.key===\'Enter\')openNewWebsiteModal()">'
          + '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'
          + '<span>Create your first website</span>'
          + '</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < adminSites.length; i++) {
        var s = adminSites[i];
        var name = s.business_name || s.slug || 'Unnamed';
        var status = s.status || 'draft';
        var slug = s.slug || '';
        var defaultUrl = slug ? 'https://' + slug + '-sites.megabyte.space' : '';
        var siteUrl = s.primary_hostname ? 'https://' + s.primary_hostname : defaultUrl;
        var created = s.created_at ? new Date(s.created_at).toLocaleDateString() : '';

        // Map status to display label
        var statusLabel = mapStatusLabel(status);
        var statusClass = mapStatusClass(status);

        html += '<div class="site-card" id="site-card-' + s.id + '" data-site-id="' + s.id + '">';

        // Preview thumbnail
        html += '<div class="site-card-preview">';
        if (status === 'published' && siteUrl) {
          html += '<iframe src="' + escapeHtml(siteUrl) + '?_t=' + (s.updated_at ? new Date(s.updated_at).getTime() : Date.now()) + '" loading="lazy" sandbox="allow-scripts allow-same-origin" tabindex="-1" data-site-id="' + escapeAttr(s.id) + '" referrerpolicy="no-referrer" onload="scalePreviewIframe(this)"></iframe>';
        } else {
          html += '<div class="site-card-preview-placeholder">';
          if (status === 'building' || status === 'queued') {
            html += '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="1.5"><path d="M12 2v4m0 12v4m-7-10H1m22 0h-4m-2.636-6.364L14.95 7.05m-5.9 9.9l-1.414 1.414m0-12.728L9.05 7.05m5.9 9.9l1.414 1.414"/></svg>';
            html += '<div style="font-size:0.65rem;margin-top:6px;color:#fbbf24;">' + escapeHtml(statusLabel) + '</div>';
          } else if (status === 'error' || status === 'failed') {
            html += '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
            html += '<div style="font-size:0.65rem;margin-top:6px;color:#ef4444;">Error</div>';
          } else {
            html += '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>';
            html += '<div style="font-size:0.65rem;margin-top:6px;">Draft</div>';
          }
          html += '</div>';
        }
        html += '</div>';

        // Plan badge row (Free / Paid per site)
        var sitePlan = s.plan || 'free';
        html += '<div class="site-card-plan-row" id="plan-row-' + s.id + '">';
        if (sitePlan === 'paid') {
          html += '<span class="plan-badge paid" data-tooltip="Custom domain enabled">Paid</span>';
        } else {
          html += '<span class="plan-badge free" data-tooltip="Upgrade for custom domains">Free</span>';
          html += '<button class="site-card-upgrade-btn" onclick="inlineCheckout(\'' + escapeAttr(s.id) + '\')" data-tooltip="Get a custom domain">Upgrade to Paid</button>';
        }
        html += '</div>';

        // Status badge + Site name row (status left of title)
        html += '<div class="site-card-title-row">';
        var statusTip = mapStatusTooltip(status);
        html += '<div class="site-card-status ' + statusClass + '"' + (statusTip ? ' data-tooltip="' + escapeAttr(statusTip) + '"' : '') + '>';
        if (status === 'published') html += '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
        if (status === 'building' || status === 'queued') html += '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';
        if (status === 'error' || status === 'failed') html += '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        html += statusLabel + '</div>';
        // Site name â€” inline editable (click title to edit)
        html += '<div class="inline-edit-wrap" id="inline-name-' + s.id + '" style="flex:1;min-width:0;">';
        html += '<span class="inline-text site-card-name" tabindex="0" role="button" title="' + escapeHtml(name) + '" onclick="startInlineEdit(\'' + escapeJsString(s.id) + '\', \'name\', \'' + escapeJsString(name) + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(s.id) + '\', \'name\', \'' + escapeJsString(name) + '\')}" style="cursor:pointer;">' + escapeHtml(name) + '</span>';
        html += '<span class="inline-edit-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(s.id) + '\', \'name\', \'' + escapeJsString(name) + '\')" data-tooltip="Edit title" aria-label="Edit title"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span>';
        html += '</div>';
        html += '</div>';

        // Slug â€” displayed as URL with copy button floating right (no edit icon)
        if (slug) {
          var cnameHost = slug + '-sites.megabyte.space';
          var cnameUrl = 'https://' + cnameHost;
          html += '<div class="site-card-url-row" id="inline-slug-wrap-' + s.id + '">';
          html += '<span class="inline-slug-url status-default" id="inline-slug-url-' + s.id + '"><a class="slug-url-link" href="' + escapeAttr(cnameUrl) + '" target="_blank" onclick="event.stopPropagation()">https://</a><span class="inline-edit-wrap inline-edit-inline" id="inline-slug-' + s.id + '"><span class="inline-text slug-editable" tabindex="0" role="button" onclick="startInlineEdit(\'' + escapeJsString(s.id) + '\', \'slug\', \'' + escapeJsString(slug) + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(s.id) + '\', \'slug\', \'' + escapeJsString(slug) + '\')}">' + escapeHtml(slug) + '</span></span><span class="inline-slug-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(s.id) + '\', \'slug\', \'' + escapeJsString(slug) + '\')" data-tooltip="Edit URL slug" aria-label="Edit URL slug" aria-label="Edit URL slug"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span><a class="slug-url-link" href="' + escapeAttr(cnameUrl) + '" target="_blank" onclick="event.stopPropagation()">-sites.megabyte.space</a></span>';
          html += '<button class="site-card-copy-btn" onclick="copyUrl(\'' + escapeAttr(cnameUrl) + '\', this)" data-tooltip="Copy URL" aria-label="Copy URL"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>';
          html += '<button class="site-card-copy-btn" onclick="window.open(\'' + escapeAttr(cnameUrl) + '\', \'_blank\')" data-tooltip="Open in new tab" aria-label="Open in new tab"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></button>';
          html += '</div>';
          // If custom primary domain, show it separately
          var hasPrimaryCustom = s.primary_hostname && s.primary_hostname !== cnameHost;
          if (hasPrimaryCustom) {
            var primaryUrl = 'https://' + s.primary_hostname;
            html += '<div class="site-card-url-row">';
            html += '<div class="site-card-domain"><a href="' + escapeHtml(primaryUrl) + '" target="_blank">' + escapeHtml(s.primary_hostname) + '</a></div>';
            if (s.has_premium_domain) {
              html += '<span class="premium-domain-badge" data-tooltip="Premium domain included"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>PREMIUM</span>';
            }
            html += '<button class="site-card-copy-btn" onclick="copyUrl(\'' + escapeAttr(primaryUrl) + '\', this)" data-tooltip="Copy URL" aria-label="Copy URL"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>';
            html += '<button class="site-card-copy-btn" onclick="window.open(\'' + escapeAttr(primaryUrl) + '\', \'_blank\')" data-tooltip="Open in new tab" aria-label="Open in new tab"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></button>';
            html += '</div>';
          }
        }

        // Created + Modified dates (modified right-aligned)
        var modified = s.updated_at ? new Date(s.updated_at).toLocaleDateString() : '';
        if (created || modified) {
          html += '<div class="site-card-date">';
          if (created) html += '<span>Created ' + created + '</span>';
          if (modified && modified !== created) html += '<span class="site-card-date-modified">Modified ' + modified + '</span>';
          else html += '<span></span>';
          html += '</div>';
        }

        // Action buttons â€” Row 1: primary actions
        html += '<div class="site-card-actions">';
        if (status === 'published' && siteUrl) {
          html += '<button class="site-card-btn btn-visit" onclick="window.open(\'' + escapeJsString(siteUrl) + '\', \'_blank\')" data-tooltip="Open live site">Visit</button>';
        }
        if (status === 'published' && slug) {
          html += '<button class="site-card-btn" onclick="editSiteInBolt(\'' + escapeJsString(slug) + '\')" data-tooltip="Edit in AI code editor">AI Edit</button>';
        }
        html += '<button class="site-card-btn" onclick="openDomainModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\', \'' + escapeJsString(slug) + '\')" data-tooltip="Manage custom domains">Domains</button>';
        html += '</div>';
        // Action buttons â€” Row 2: management dropdown
        html += '<div class="site-card-actions">';
        html += '<button class="site-card-btn" onclick="openFilesModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\', \'' + escapeJsString(slug) + '\')" data-tooltip="Browse and edit files">Files</button>';
        html += '<button class="site-card-btn" onclick="openSiteLogsModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\')" data-tooltip="View build logs">Logs</button>';
        // "More" dropdown for less-frequent actions
        html += '<div class="site-card-dropdown-wrap">';
        html += '<button class="site-card-btn" onclick="toggleCardDropdown(this.parentNode)">More <svg class="dd-chevron" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg></button>';
        html += '<div class="site-card-dropdown-menu">';
        html += '<button class="site-card-dropdown-item" onclick="openResetModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\', \'' + escapeJsString(s.business_address || '') + '\', \'' + escapeJsString(s.google_place_id || '') + '\', \'' + escapeJsString(s.additional_context || '') + '\');closeAllDropdowns()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/></svg>Reset &amp; Rebuild</button>';
        html += '<button class="site-card-dropdown-item" onclick="openDeployModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\');closeAllDropdowns()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Deploy ZIP</button>';
        html += '<div style="height:1px;background:rgba(255,255,255,0.05);margin:2px 0;"></div>';
        html += '<button class="site-card-dropdown-item danger-item" onclick="openDeleteModal(\'' + escapeJsString(s.id) + '\', \'' + escapeJsString(name) + '\');closeAllDropdowns()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Delete Site</button>';
        html += '</div></div>';
        html += '</div>';
        html += '</div>';
      }

      // "+" card for creating new site
      html += '<div class="site-card-new" tabindex="0" role="button" onclick="openNewWebsiteModal()" onkeydown="if(event.key===\'Enter\')openNewWebsiteModal()">'
        + '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'
        + '<span>New Website</span>'
        + '</div>';

      grid.innerHTML = html;
    }

    /* â”€â”€ Dropdown helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function toggleCardDropdown(wrap) {
      var menu = wrap.querySelector('.site-card-dropdown-menu');
      if (!menu) return;
      var wasOpen = menu.classList.contains('open');
      closeAllDropdowns();
      if (!wasOpen) menu.classList.add('open');
    }
    function closeAllDropdowns() {
      var menus = document.querySelectorAll('.site-card-dropdown-menu.open');
      for (var i = 0; i < menus.length; i++) menus[i].classList.remove('open');
    }
    // Close dropdowns on outside click
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.site-card-dropdown-wrap')) closeAllDropdowns();
    });

    /* â”€â”€ Settings modal (stub) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function openSettingsModal(siteId, siteName) {
      // For now, show an info message â€” this will be expanded
      showToast('Settings for ' + siteName + ' coming soon', 'info');
    }

    function copyUrl(url, btn) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(function() {
          btn.classList.add('copied');
          // Show toast
          var existing = btn.querySelector('.copy-toast');
          if (existing) existing.remove();
          var toast = document.createElement('span');
          toast.className = 'copy-toast';
          toast.textContent = 'URL copied!';
          btn.style.position = 'relative';
          btn.appendChild(toast);
          setTimeout(function() {
            btn.classList.remove('copied');
            if (toast.parentNode) toast.remove();
          }, 1500);
        });
      }
    }

    function editSiteInBolt(slug) {
      var chatApiUrl = window.location.origin + '/api/sites/by-slug/' + encodeURIComponent(slug) + '/chat';
      var boltUrl = 'https://bolt.megabyte.space/?importChatFrom=' + encodeURIComponent(chatApiUrl);
      window.open(boltUrl, '_blank');
    }

    function renderAdminBilling() {
      // Billing info is now shown per-site card â€” just toggle Billing button visibility
      var billingBtn = document.getElementById('admin-billing-btn');
      if (billingBtn) {
        billingBtn.style.display = adminSubscription && adminSubscription.stripe_customer_id ? '' : 'none';
      }
    }

    /* â”€â”€ Domain Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    var adminDomainModalSlug = null;

    function openDomainModal(siteId, siteName, siteSlug) {
      adminDomainModalSiteId = siteId;
      adminDomainModalSlug = siteSlug || null;
      document.getElementById('domain-modal-title').textContent = 'Domains: ' + siteName;
      document.getElementById('domain-modal').classList.add('visible');
      document.getElementById('domain-add-input').value = '';
      hideMsg('domain-modal-msg');
      trackEvent('domain_modal_opened', { site_id: siteId, site_name: siteName });
      loadHostnames(siteId);
      // Show upgrade CTA on Connect Domain tab if site is on free plan
      var ctaEl = document.getElementById('domain-connect-upgrade-cta');
      if (ctaEl) {
        var site = null;
        for (var si = 0; si < adminSites.length; si++) {
          if (adminSites[si].id === siteId) { site = adminSites[si]; break; }
        }
        ctaEl.style.display = (site && site.plan !== 'paid') ? 'block' : 'none';
      }
      // Focus the first input
      setTimeout(function() {
        var firstInput = document.querySelector('#domain-modal input:not([type=hidden])');
        if (firstInput) firstInput.focus();
      }, 100);
    }

    function closeDomainModal() {
      document.getElementById('domain-modal').classList.remove('visible');
      adminDomainModalSiteId = null;
    }

    function loadHostnames(siteId) {
      var container = document.getElementById('domain-modal-hostnames');
      container.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;padding:8px;">Loading...</div>';

      var hdrs = {};
      if (state.session && state.session.token) {
        hdrs['Authorization'] = 'Bearer ' + state.session.token;
      }
      fetch('/api/sites/' + siteId + '/hostnames', { headers: hdrs })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) {
            var msg = 'Failed to load domains';
            if (d && d.error) {
              msg = typeof d.error === 'string' ? d.error : (d.error.message || d.error.code || msg);
            }
            throw new Error(msg);
          });
          return r.json();
        })
        .then(function(d) {
          var hostnames = d.data || [];
          var html = '';

          // Always show the CNAME subdomain as the primary URL entry â€” matches site card URL styling
          if (adminDomainModalSlug) {
            var cnameHost = adminDomainModalSlug + '-sites.megabyte.space';
            var cnameUrl = 'https://' + cnameHost;
            var cnameIsPrimary = true; // Default is primary unless custom domain set
            for (var pi = 0; pi < hostnames.length; pi++) {
              if (hostnames[pi].is_primary === 1 || hostnames[pi].is_primary === true) { cnameIsPrimary = false; break; }
            }
            html += '<div class="hostname-item site-card-url-row" id="dm-slug-wrap" style="background:rgba(80,165,219,0.04);border:1px solid rgba(80,165,219,0.12);border-radius:8px;padding:10px 12px;margin-bottom:8px;">';
            html += '<div style="display:flex;align-items:center;gap:8px;width:100%;">';
            html += '<span class="hostname-status-square active"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>';
            html += '<div style="flex:1;min-width:0;">';
            // URL row â€” independent slug editing (uses 'dm' context to avoid touching homepage card)
            html += '<div style="display:flex;align-items:center;gap:4px;">';
            html += '<span class="inline-slug-url status-default" id="dm-slug-url" style="font-size:0.78rem;"><a class="slug-url-link" href="' + escapeAttr(cnameUrl) + '" target="_blank" onclick="event.stopPropagation()">https://</a><span class="inline-edit-wrap inline-edit-inline" id="dm-slug-edit"><span class="inline-text slug-editable" tabindex="0" role="button" onclick="startInlineEdit(\'' + escapeJsString(adminDomainModalSiteId) + '\', \'slug\', \'' + escapeJsString(adminDomainModalSlug) + '\', \'dm\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(adminDomainModalSiteId) + '\', \'slug\', \'' + escapeJsString(adminDomainModalSlug) + '\', \'dm\')}">' + escapeHtml(adminDomainModalSlug) + '</span></span><span class="inline-slug-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(adminDomainModalSiteId) + '\', \'slug\', \'' + escapeJsString(adminDomainModalSlug) + '\', \'dm\')" data-tooltip="Edit URL slug" aria-label="Edit URL slug" aria-label="Edit URL slug"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span><a class="slug-url-link" href="' + escapeAttr(cnameUrl) + '" target="_blank" onclick="event.stopPropagation()">-sites.megabyte.space</a></span>';
            html += '<button class="site-card-copy-btn" onclick="copyUrl(\'' + escapeAttr(cnameUrl) + '\', this)" data-tooltip="Copy URL" aria-label="Copy URL" style="position:relative;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>';
            html += '<button class="site-card-copy-btn" onclick="window.open(\'' + escapeAttr(cnameUrl) + '\', \'_blank\')" data-tooltip="Open in new tab" aria-label="Open in new tab"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></button>';
            html += '</div>';
            // Chips below URL
            html += '<div class="hostname-chips">';
            html += '<span class="hostname-chip default" data-tip="Default URL for this site">Default</span>';
            if (cnameIsPrimary) html += '<span class="hostname-chip primary" data-tip="Your main URL. All other domains redirect here.">Primary</span>';
            else html += '<button class="hostname-chip-setprimary" onclick="resetPrimaryToDefault(\'' + escapeAttr(adminDomainModalSiteId) + '\')" data-tooltip="Make this your default URL">Set as primary</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
          }

          // Upgrade CTA: only show if no custom domains AND plan is not paid
          var hasCustom = false;
          for (var ci = 0; ci < hostnames.length; ci++) { if (hostnames[ci].type === 'custom_cname') hasCustom = true; }
          var siteForCta = null;
          for (var csi = 0; csi < adminSites.length; csi++) { if (adminSites[csi].id === adminDomainModalSiteId) siteForCta = adminSites[csi]; }
          var isPaid = siteForCta && siteForCta.plan === 'paid';
          var hasSub = adminSubscription && adminSubscription.stripe_customer_id;
          if (!hasCustom && !isPaid && !hasSub) {
            html += '<div style="margin:8px 0 12px;padding:14px 16px;background:linear-gradient(135deg,rgba(100,255,218,0.04),rgba(124,58,237,0.04));border:1px solid rgba(100,255,218,0.12);border-radius:var(--radius);text-align:center;">';
            html += '<div style="font-size:0.85rem;color:var(--text-primary);font-weight:600;margin-bottom:4px;">Want a custom domain?</div>';
            html += '<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:10px;">Get a free domain or point your own for <strong style="color:var(--accent);">$50/mo</strong></div>';
            html += '<button class="btn btn-accent" onclick="openBillingCheckout()" style="padding:8px 20px;font-size:0.8rem;">Upgrade Now</button>';
            html += '</div>';
          }
          // Domain count limit for custom domains
          var customCount = 0;
          for (var cci = 0; cci < hostnames.length; cci++) { if (hostnames[cci].type === 'custom_cname') customCount++; }
          if (customCount >= 5) {
            html += '<div style="margin:4px 0 8px;padding:8px 12px;font-size:0.72rem;color:var(--text-muted);background:rgba(255,255,255,0.02);border-radius:8px;text-align:center;">Maximum of 5 custom domains reached.</div>';
          }

          if (!hostnames.length && !adminDomainModalSlug) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:0.85rem;padding:8px;">No domains configured yet.</div>';
            return;
          }

          for (var i = 0; i < hostnames.length; i++) {
            var h = hostnames[i];
            var url = 'https://' + h.hostname;
            var isPrimary = h.is_primary === 1 || h.is_primary === true;
            var isVerified = h.status === 'active' || h.status === 'verified';
            var isPending = h.status === 'pending' || h.status === 'verification_failed';
            var hasDomainSub = (h.type === 'custom_cname');
            html += '<div class="hostname-item">';
            // Green/yellow/red status square
            var hStatusTip = isVerified ? 'Domain verified and active' : (isPending ? 'DNS verification pending' : 'Domain inactive');
            html += '<span class="hostname-status-square ' + (isVerified ? 'active' : (isPending ? 'pending' : 'inactive')) + '" data-tooltip="' + hStatusTip + '">';
            if (isVerified) {
              html += '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
            } else if (isPending) {
              html += '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="6" r="1"/><circle cx="12" cy="18" r="1"/></svg>';
            } else {
              html += '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
            }
            html += '</span>';
            html += '<div style="flex:1;min-width:0;">';
            html += '<div class="hostname-item-name" style="display:flex;align-items:center;gap:6px;">';
            html += '<a href="' + escapeHtml(url) + '" target="_blank" style="color:var(--text-primary);text-decoration:none;">' + escapeHtml(h.hostname) + '</a>';
            if (hasDomainSub) {
              html += '<span class="premium-domain-badge" data-tooltip="Premium domain included"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>PREMIUM</span>';
            }
            html += '</div>';
            // CNAME verification status for pending custom domains
            if (hasDomainSub && isPending) {
              html += '<div style="margin-top:4px;padding:6px 8px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:6px;font-size:0.68rem;line-height:1.4;">';
              html += '<span style="color:#fbbf24;font-weight:600;">CNAME pending</span> <span style="color:var(--text-muted);">&mdash; Point your CNAME to <code style="background:rgba(80,165,219,0.1);padding:1px 5px;border-radius:3px;font-size:0.65rem;color:var(--accent);">sites.megabyte.space</code></span>';
              html += '<div style="margin-top:4px;color:var(--text-muted);">DNS propagation usually takes 24&ndash;72 hours.</div>';
              // DomainConnect auto-setup for GoDaddy
              var dcParts = h.hostname.split('.');
              var dcDomain = dcParts.slice(-2).join('.');
              var dcSubdomain = dcParts.length > 2 ? dcParts.slice(0, -2).join('.') : '';
              var dcHostParam = dcSubdomain ? '&host=' + encodeURIComponent(dcSubdomain) : '';
              var gdUrl = 'https://dcc.godaddy.com/manage/v2/domainTemplates/providers/megabyte.space/services/cname/apply?domain=' + encodeURIComponent(dcDomain) + dcHostParam;
              html += '<div style="display:flex;align-items:center;gap:6px;margin-top:6px;flex-wrap:wrap;">';
              html += '<span style="font-size:0.6rem;color:var(--text-muted);">One-click setup:</span>';
              html += '<a href="' + escapeAttr(gdUrl) + '" target="_blank" rel="noopener" class="dc-btn dc-btn-gd" data-tooltip="Auto-configure DNS via GoDaddy">';
              html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>';
              html += 'GoDaddy</a>';
              html += '</div>';
              html += '</div>';
            } else if (hasDomainSub && isVerified) {
              html += '<div style="margin-top:3px;font-size:0.65rem;color:#22c55e;font-weight:500;">CNAME verified &mdash; connected to sites.megabyte.space</div>';
            }
            // Chips below URL
            html += '<div class="hostname-chips">';
            if (isPrimary) html += '<span class="hostname-chip primary" data-tip="Your main URL. All other domains redirect here.">Primary</span>';
            else html += '<button class="hostname-chip-setprimary" onclick="setPrimaryHostname(\'' + escapeAttr(adminDomainModalSiteId) + '\', \'' + escapeAttr(h.id) + '\')" data-tooltip="Make this your default URL">Set as primary</button>';
            html += '</div>';
            html += '</div>';
            html += '<div style="display:flex;align-items:center;gap:4px;">';
            // Re-verify button for pending/failed hostnames
            if (isPending) {
              html += '<button class="hostname-delete-btn" onclick="verifyHostname(\'' + escapeAttr(h.id) + '\')" data-tooltip="Re-verify DNS" aria-label="Re-verify domain" style="color:#22c55e;">';
              html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>';
              html += '</button>';
            }
            if (hasDomainSub) {
              html += '<button class="hostname-delete-btn" onclick="unsubscribeDomain(\'' + escapeAttr(adminDomainModalSiteId) + '\', \'' + escapeAttr(h.id) + '\', \'' + escapeAttr(h.hostname) + '\')" data-tooltip="Unsubscribe domain" aria-label="Unsubscribe and remove domain" style="color:#fbbf24;">';
              html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>';
              html += '</button>';
            }
            html += '<button class="hostname-delete-btn" onclick="deleteHostnameWithWarning(\'' + escapeAttr(adminDomainModalSiteId) + '\', \'' + escapeAttr(h.id) + '\', \'' + escapeAttr(h.hostname) + '\', ' + (hasDomainSub ? 'true' : 'false') + ')" data-tooltip="Remove domain" aria-label="Remove domain">';
            html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
            html += '</button>';
            html += '</div>';
            html += '</div>';
          }
          container.innerHTML = html;
        })
        .catch(function(err) {
          container.innerHTML = '<div style="color:var(--error);font-size:0.85rem;padding:8px;">' + escapeHtml(err.message || 'Failed to load domains.') + '</div>';
        });
    }

    function setPrimaryHostname(siteId, hostnameId) {
      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      fetch('/api/sites/' + siteId + '/hostnames/' + hostnameId + '/primary', {
        method: 'PUT',
        headers: headers
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) {
            var msg = 'Failed to set primary domain';
            if (d && d.error) {
              msg = typeof d.error === 'string' ? d.error : (d.error.message || d.error.code || msg);
            }
            throw new Error(msg);
          });
          loadHostnames(siteId);
        })
        .catch(function(err) {
          showMsg('domain-modal-msg', 'error', err.message || 'Failed to set primary domain');
        });
    }

    function addHostname() {
      var input = document.getElementById('domain-add-input');
      var hostname = input.value.trim().toLowerCase();
      if (!hostname) return;

      var siteId = adminDomainModalSiteId;
      if (!siteId) return;

      // Determine type: if it ends with sites.megabyte.space, it's free_subdomain
      var type = hostname.endsWith('sites.megabyte.space') || hostname.endsWith('-sites.megabyte.space')
        ? 'free_subdomain' : 'custom_cname';

      // If custom domain and site is not paid, store pending domain and redirect to Stripe
      if (type === 'custom_cname') {
        var site = null;
        for (var si = 0; si < adminSites.length; si++) {
          if (adminSites[si].id === siteId) { site = adminSites[si]; break; }
        }
        if (site && site.plan !== 'paid') {
          // Store the pending domain so we can add it after Stripe return
          localStorage.setItem('ps_pending_domain', JSON.stringify({
            hostname: hostname, siteId: siteId, siteName: site.business_name || '', siteSlug: site.slug || ''
          }));
          showMsg('domain-modal-msg', 'info', 'Redirecting to billing to unlock custom domains\u2026');
          // Redirect to Stripe checkout (don't close modal â€” the page navigates away)
          openSiteCheckout(siteId);
          return;
        }
      }

      _postHostname(siteId, hostname, type);
    }

    function _postHostname(siteId, hostname, type) {
      var input = document.getElementById('domain-add-input');
      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      // Show loading state on button
      var addBtn = document.getElementById('domain-add-btn');
      var addBtnText = addBtn ? addBtn.textContent : '';
      if (addBtn) { addBtn.disabled = true; addBtn.textContent = 'Adding\u2026'; }

      // Hide previous upgrade CTA
      var ctaEl = document.getElementById('domain-connect-upgrade-cta');
      if (ctaEl) ctaEl.style.display = 'none';

      fetch('/api/sites/' + siteId + '/hostnames', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ hostname: hostname, type: type })
      })
        .then(function(res) {
          if (!res.ok) {
            return res.json().catch(function() { return {}; }).then(function(d) {
              var msg = 'Unable to connect this domain. Please check your plan and try again.';
              if (d && d.error) {
                msg = typeof d.error === 'string' ? d.error : (d.error.message || d.error.code || msg);
              }
              if (res.status === 403 && msg.toLowerCase().indexOf('paid') !== -1) {
                // Store and redirect to Stripe
                localStorage.setItem('ps_pending_domain', JSON.stringify({
                  hostname: hostname, siteId: siteId, siteName: '', siteSlug: ''
                }));
                showMsg('domain-modal-msg', 'info', 'Redirecting to billing to unlock custom domains\u2026');
                openSiteCheckout(siteId);
                return null;
              }
              throw new Error(msg);
            });
          }
          return res.json();
        })
        .then(function(d) {
          if (addBtn) { addBtn.disabled = false; addBtn.textContent = addBtnText; }
          if (!d) return;
          if (input) input.value = '';
          hideMsg('domain-modal-msg');
          loadHostnames(siteId);

          // Show CNAME verification status inline
          var hostnameData = d.data || d;
          if (hostnameData && (hostnameData.status === 'active' || hostnameData.status === 'verified')) {
            showMsg('domain-modal-msg', 'info', 'Domain added! CNAME verified \u2714');
          } else if (hostnameData && hostnameData.status === 'pending' && hostname) {
            showCnameMonitor(hostname);
            startCnamePolling(siteId);
          }
        })
        .catch(function(err) {
          if (addBtn) { addBtn.disabled = false; addBtn.textContent = addBtnText; }
          var msg = err.message || 'Failed to add domain';
          if (msg.indexOf('CNAME') !== -1 || msg.indexOf('cname') !== -1) {
            showCnameDiagnostics(hostname, msg);
          } else {
            showMsg('domain-modal-msg', 'error', msg);
          }
          showToast(msg, 'error');
        });
    }

    // Auto-reopen domain modal ONLY if returning from Stripe billing (not on every page load)
    function checkPendingDomain() {
      var params = new URLSearchParams(window.location.search);
      // Only process pending domain if we just returned from Stripe billing
      if (params.get('billing') !== 'success') {
        // Not a billing return â€” clean up stale pending domain data
        try { localStorage.removeItem('ps_pending_domain'); } catch(e) {}
        return;
      }
      var pending = localStorage.getItem('ps_pending_domain');
      if (!pending) return;
      try {
        var pd = JSON.parse(pending);
        localStorage.removeItem('ps_pending_domain');
        if (pd.siteId) {
          // Wait for session/data to load, then open the domain modal
          setTimeout(function() {
            openDomainModal(pd.siteId, pd.siteName || '', pd.siteSlug || '');
            // Switch to connect tab
            switchDomainTab('connect');
            // If subscription is now active, auto-add the pending hostname
            setTimeout(function() {
              _postHostname(pd.siteId, pd.hostname, 'custom_cname');
            }, 500);
          }, 1500);
        }
      } catch(e) { /* ignore */ }
    }

    // CNAME polling â€” keep checking pending hostnames while modal is open
    var _cnamePollingInterval = null;
    function startCnamePolling(siteId) {
      if (_cnamePollingInterval) return;
      _cnamePollingInterval = setInterval(function() {
        if (!adminDomainModalSiteId || adminDomainModalSiteId !== siteId) {
          clearInterval(_cnamePollingInterval);
          _cnamePollingInterval = null;
          return;
        }
        // Re-fetch hostnames to check for status changes
        loadHostnames(siteId);
      }, 15000); // Check every 15 seconds
    }

    function toggleHostnameUrl(el) {
      var expanded = el.getAttribute('data-expanded') === 'true';
      if (expanded) {
        el.style.maxWidth = '240px';
        el.style.color = 'var(--accent)';
        el.setAttribute('data-expanded', 'false');
      } else {
        el.style.maxWidth = '500px';
        el.style.color = '#22c55e';
        el.setAttribute('data-expanded', 'true');
      }
    }

    function showCnameMonitor(hostname) {
      var el = document.getElementById('domain-cname-status');
      if (!el) return;
      el.style.display = 'block';
      el.innerHTML = '<div style="padding:10px 14px;background:rgba(80,165,219,0.06);border:1px solid rgba(80,165,219,0.15);border-radius:var(--radius);font-size:0.8rem;">'
        + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">'
        + '<span class="loading-dots"><span></span><span></span><span></span></span>'
        + '<span style="color:var(--text-secondary);">Monitoring CNAME for <strong style="color:var(--accent);">' + escapeHtml(hostname) + '</strong></span>'
        + '</div>'
        + '<div style="color:var(--text-muted);font-size:0.72rem;">Point your CNAME to <code>sites.megabyte.space</code>. We\'ll verify automatically.</div>'
        + '</div>';
    }

    function showCnameDiagnostics(hostname, errorMsg) {
      var el = document.getElementById('domain-cname-status');
      if (!el) return;
      el.style.display = 'block';
      el.innerHTML = '<div style="padding:12px 14px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.25);border-radius:var(--radius);font-size:0.8rem;">'
        + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">'
        + '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
        + '<strong style="color:#fbbf24;">CNAME Not Configured</strong>'
        + '</div>'
        + '<div style="color:var(--text-secondary);margin-bottom:8px;">' + escapeHtml(errorMsg) + '</div>'
        + '<div style="color:var(--text-muted);font-size:0.72rem;line-height:1.5;">'
        + '<strong>To fix:</strong> Go to your DNS provider and add a CNAME record:<br>'
        + '<code style="background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:3px;">' + escapeHtml(hostname) + '</code> &rarr; <code style="background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:3px;">sites.megabyte.space</code><br>'
        + 'Or you can <a href="javascript:void(0)" onclick="switchDomainTab(\'register\')" style="color:var(--accent);text-decoration:underline;">register a new domain</a> instead.'
        + '</div></div>';
    }

    function deleteHostname(siteId, hostnameId) {
      var headers = {};
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      fetch('/api/sites/' + siteId + '/hostnames/' + hostnameId, {
        method: 'DELETE',
        headers: headers
      })
        .then(function(res) {
          if (!res.ok) throw new Error('Failed to delete');
          loadHostnames(siteId);
        })
        .catch(function() {
          showMsg('domain-modal-msg', 'error', 'Failed to delete domain');
        });
    }

    function verifyHostname(hostnameId) {
      if (!state.session || !state.session.token) return;
      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };

      showMsg('domain-modal-msg', 'info', 'Verifying domain...');

      fetch('/api/admin/domains/' + hostnameId + '/verify', {
        method: 'POST',
        headers: headers
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) {
            var msg = 'Verification failed';
            if (d && d.error) {
              msg = typeof d.error === 'string' ? d.error : (d.error.message || msg);
            }
            throw new Error(msg);
          });
          return res.json();
        })
        .then(function(d) {
          var data = d.data;
          if (data.status === 'active') {
            showMsg('domain-modal-msg', 'success', 'Domain verified successfully! SSL: ' + data.ssl_status);
          } else if (data.verification_errors && data.verification_errors.length > 0) {
            showMsg('domain-modal-msg', 'error', 'Verification issues: ' + data.verification_errors.join(', '));
          } else {
            showMsg('domain-modal-msg', 'info', 'Domain status: ' + data.status + '. SSL: ' + data.ssl_status);
          }
          if (adminDomainModalSiteId) {
            loadHostnames(adminDomainModalSiteId);
          }
        })
        .catch(function(err) {
          showMsg('domain-modal-msg', 'error', err.message || 'Verification failed');
        });
    }

    /* â”€â”€ Delete Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    var deleteModalSiteId = null;
    var deleteModalSitePlan = null;

    function openDeleteModal(siteId, siteName) {
      deleteModalSiteId = siteId;
      document.getElementById('delete-modal-name').textContent = siteName;
      hideMsg('delete-modal-msg');

      // Check if this site has a paid plan â€” show subscription option
      var subOption = document.getElementById('delete-modal-sub-option');
      var cancelCheck = document.getElementById('delete-cancel-sub');
      deleteModalSitePlan = null;

      // Look up the site's plan from cached admin data
      if (state._adminSites) {
        for (var i = 0; i < state._adminSites.length; i++) {
          if (state._adminSites[i].id === siteId) {
            deleteModalSitePlan = state._adminSites[i].plan || 'free';
            break;
          }
        }
      }

      if (deleteModalSitePlan === 'paid') {
        subOption.style.display = 'block';
        cancelCheck.checked = false; // Default: keep subscription (credit remains)
      } else {
        subOption.style.display = 'none';
      }

      document.body.style.overflow = 'hidden';
      document.getElementById('delete-modal').classList.add('visible');
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.remove('visible');
      deleteModalSiteId = null;
      deleteModalSitePlan = null;
      document.body.style.overflow = '';
    }

    function confirmDeleteSite() {
      if (!deleteModalSiteId) return;

      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      var btn = document.getElementById('delete-confirm-btn');
      btn.disabled = true;
      btn.textContent = 'Deleting...';

      var cancelSub = false;
      if (deleteModalSitePlan === 'paid') {
        cancelSub = document.getElementById('delete-cancel-sub').checked;
      }

      fetch('/api/sites/' + deleteModalSiteId, {
        method: 'DELETE',
        headers: headers,
        body: JSON.stringify({ cancel_subscription: cancelSub })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Delete failed')); });
          btn.disabled = false;
          btn.textContent = 'Delete';
          closeDeleteModal();
          loadAdminDashboard();
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Delete';
          showMsg('delete-modal-msg', 'error', err.message || 'Delete failed. Please try again.');
        });
    }

    /* â”€â”€ New Website Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function openNewWebsiteModal() {
      // Reset the details modal fields
      var badge = document.getElementById('details-business-badge');
      if (badge) badge.style.display = 'none';
      var manualFields = document.getElementById('details-manual-fields');
      if (manualFields) manualFields.style.display = '';
      var textarea = document.getElementById('details-textarea');
      if (textarea) textarea.value = '';
      var nameInput = document.getElementById('business-name-input');
      if (nameInput) nameInput.value = '';
      var addrInput = document.getElementById('business-address-input');
      if (addrInput) addrInput.value = '';
      // Clear selected business from state
      state.selectedBusiness = null;
      openDetailsModal();
    }

    /* â”€â”€ Stripe Embedded Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    var _stripeInstance = null;
    var _embeddedCheckout = null;

    function getStripe() {
      if (_stripeInstance) return Promise.resolve(_stripeInstance);
      var pkMeta = document.querySelector('meta[name="x-stripe-pk"]');
      var pk = pkMeta ? pkMeta.getAttribute('content') : null;
      if (!pk || typeof Stripe === 'undefined') return Promise.reject(new Error('Stripe not loaded'));
      _stripeInstance = Stripe(pk);
      return Promise.resolve(_stripeInstance);
    }

    function openCheckoutModal(siteId) {
      if (!state.session || !state.session.token) return;

      var modal = document.getElementById('checkout-modal');
      var mountEl = document.getElementById('checkout-mount');
      if (!modal || !mountEl) return;

      // Show modal with loading state
      modal.style.display = '';
      modal.classList.add('visible');
      mountEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:350px;color:var(--text-muted);font-size:0.85rem;">Loading checkout\u2026</div>';

      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };

      fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + state.session.token } })
        .then(function(res) { return res.ok ? res.json() : null; })
        .then(function(d) {
          if (!d || !d.data || !d.data.org_id) throw new Error('Not authenticated');
          var body = {
            org_id: d.data.org_id,
            return_url: window.location.origin + '/?billing=success'
          };
          if (siteId) body.site_id = siteId;
          return fetch('/api/billing/embedded-checkout', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
          });
        })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(e) { throw new Error(e.error || 'Checkout failed'); });
          return res.json();
        })
        .then(function(d) {
          if (!d || !d.data || !d.data.client_secret) throw new Error('No checkout session');
          return getStripe().then(function(stripe) {
            return stripe.initEmbeddedCheckout({ clientSecret: d.data.client_secret });
          });
        })
        .then(function(checkout) {
          _embeddedCheckout = checkout;
          mountEl.innerHTML = '';
          checkout.mount('#checkout-mount');
        })
        .catch(function(err) {
          // Fallback to redirect checkout if embedded fails
          closeCheckoutModal();
          _openRedirectCheckout(siteId);
        });
    }

    function closeCheckoutModal() {
      var modal = document.getElementById('checkout-modal');
      if (modal) {
        modal.classList.remove('visible');
        setTimeout(function() { modal.style.display = 'none'; }, 300);
      }
      if (_embeddedCheckout) {
        try { _embeddedCheckout.destroy(); } catch(e) {}
        _embeddedCheckout = null;
      }
    }

    function openSiteCheckout(siteId) {
      openCheckoutModal(siteId);
    }

    /** Inline checkout: expand Stripe embedded checkout inside the site card */
    var _inlineCheckouts = {};
    function inlineCheckout(siteId) {
      if (!state.session || !state.session.token) return;
      var planRow = document.getElementById('plan-row-' + siteId);
      if (!planRow) { openCheckoutModal(siteId); return; }

      // Replace row with inline checkout mount
      var mountId = 'inline-checkout-' + siteId;
      planRow.innerHTML = '<div id="' + mountId + '" style="min-height:320px;border-radius:12px;overflow:hidden;border:1px solid var(--border);"><div style="display:flex;align-items:center;justify-content:center;min-height:320px;color:var(--text-muted);font-size:0.8rem;">Loading checkout\u2026</div></div>';

      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };
      fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + state.session.token } })
        .then(function(res) { return res.ok ? res.json() : null; })
        .then(function(d) {
          if (!d || !d.data || !d.data.org_id) throw new Error('Not authenticated');
          return fetch('/api/billing/embedded-checkout', {
            method: 'POST', headers: headers,
            body: JSON.stringify({ org_id: d.data.org_id, site_id: siteId, return_url: window.location.origin + '/?billing=success' })
          });
        })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(e) { throw new Error(e.error || 'Checkout failed'); });
          return res.json();
        })
        .then(function(d) {
          if (!d || !d.data || !d.data.client_secret) throw new Error('No checkout session');
          return getStripe().then(function(stripe) {
            return stripe.initEmbeddedCheckout({ clientSecret: d.data.client_secret });
          });
        })
        .then(function(checkout) {
          _inlineCheckouts[siteId] = checkout;
          var el = document.getElementById(mountId);
          if (el) { el.innerHTML = ''; checkout.mount('#' + mountId); }
        })
        .catch(function() {
          // Fallback to modal
          if (planRow) planRow.innerHTML = '<span class="plan-badge free">Free</span><button class="site-card-upgrade-btn" onclick="openCheckoutModal(\'' + siteId + '\')">Upgrade to Paid</button>';
        });
    }

    /* â”€â”€ Billing Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function openBillingPortal() {
      if (!state.session || !state.session.token) return;

      var modal = document.getElementById('billing-portal-modal');
      var mountEl = document.getElementById('billing-portal-mount');
      if (!modal || !mountEl) return;

      modal.style.display = '';
      modal.classList.add('visible');
      mountEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:400px;color:var(--text-muted);font-size:0.85rem;">Loading billing portal\u2026</div>';

      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };

      fetch('/api/billing/portal', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ return_url: window.location.origin + '/?billing=portal' })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) {
            var msg = 'Failed';
            if (d && d.error) {
              msg = typeof d.error === 'string' ? d.error : (d.error.message || d.error.code || msg);
            }
            throw new Error(msg);
          });
          return res.json();
        })
        .then(function(d) {
          if (d.data && d.data.portal_url) {
            mountEl.innerHTML = '<iframe src="' + d.data.portal_url + '" style="width:100%;min-height:70vh;border:none;border-radius:0 0 22px 22px;"></iframe>';
          }
        })
        .catch(function(err) {
          closeBillingPortalModal();
          openBillingCheckout();
        });
    }

    function closeBillingPortalModal() {
      var modal = document.getElementById('billing-portal-modal');
      if (modal) {
        modal.classList.remove('visible');
        setTimeout(function() { modal.style.display = 'none'; }, 300);
      }
    }

    function openBillingCheckout() {
      openCheckoutModal(null);
    }

    /** Fallback: redirect to Stripe hosted checkout if embedded fails */
    function _openRedirectCheckout(siteId) {
      if (!state.session || !state.session.token) return;

      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };

      fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + state.session.token } })
        .then(function(res) { return res.ok ? res.json() : null; })
        .then(function(d) {
          if (!d || !d.data || !d.data.org_id) return;
          var body = {
            org_id: d.data.org_id,
            success_url: window.location.origin + '/?billing=success',
            cancel_url: window.location.origin + '/?billing=cancel'
          };
          if (siteId) body.site_id = siteId;
          return fetch('/api/billing/checkout', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
          });
        })
        .then(function(res) {
          if (!res || !res.ok) return;
          return res.json();
        })
        .then(function(d) {
          if (d && d.data && d.data.checkout_url) {
            window.location.href = d.data.checkout_url;
          }
        })
        .catch(function() {
          /* silently fail - billing may not be configured */
        });
    }

    /* â”€â”€ Get Started (Paid) â€” pricing CTA â”€â”€â”€â”€â”€â”€â”€ */

    function handleGetStartedPaid() {
      // 1. If not logged in, save intent and show sign-in
      if (!state.session || !state.session.token) {
        try {
          localStorage.setItem('ps_paid_intent', '1');
        } catch(e) {}
        // Scroll to top and prompt search / sign-in flow
        navigateTo('signin');
        return;
      }
      // 2. Logged in â€” check if user already has an active subscription
      var headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.session.token
      };
      fetch('/api/billing/subscription', { headers: headers })
        .then(function(res) { return res.ok ? res.json() : null; })
        .then(function(d) {
          var sub = d && d.data ? d.data : null;
          if (sub && (sub.status === 'active' || sub.status === 'trialing')) {
            // Already subscribed â€” open build modal directly
            try { localStorage.removeItem('ps_paid_intent'); } catch(e) {}
            openDetailsModal();
          } else {
            // Not subscribed â€” redirect to checkout
            try {
              localStorage.setItem('ps_paid_intent', '1');
            } catch(e) {}
            openBillingCheckout();
          }
        })
        .catch(function() {
          // On error, try checkout anyway
          try {
            localStorage.setItem('ps_paid_intent', '1');
          } catch(e) {}
          openBillingCheckout();
        });
    }

    // Restore session from localStorage on page load
    (function restoreSession() {
      var saved;
      try { saved = localStorage.getItem('ps_session'); } catch(e) { return; }
      if (!saved) return;
      try {
        var parsed = JSON.parse(saved);
        if (parsed && parsed.token) {
          state.session = parsed;
          updateNavAuth();
          // Validate token with server
          fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + parsed.token }
          }).then(function(res) {
            if (!res.ok) { clearSession(); updateNavAuth(); return; }
            return res.json();
          }).then(function(data) {
            if (data && data.data) {
              state.session.identifier = data.data.email || data.data.display_name || state.session.identifier;
              saveSession();
              updateNavAuth();
            }
          }).catch(function() {
            clearSession();
            updateNavAuth();
          });
        }
      } catch(e) {
        clearSession();
      }
    })();

    // Request browser geolocation with custom modal
    // Only show if: (1) geolocation is supported, (2) user hasn't declined before,
    // (3) location isn't already available, (4) we're on the homepage with search input visible,
    // (5) no modal/overlay is open, (6) permission hasn't already been granted
    function dismissLocationModal() {
      document.getElementById('location-modal').style.display = 'none';
      try { localStorage.setItem('ps_location_declined', '1'); } catch(e) { /* private browsing */ }
    }
    function allowLocation() {
      document.getElementById('location-modal').style.display = 'none';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(pos) {
            state.userLat = pos.coords.latitude;
            state.userLng = pos.coords.longitude;
          },
          function() { /* user denied or unavailable - that's fine */ },
          { timeout: 5000, maximumAge: 300000 }
        );
      }
    }

    /** Check whether geolocation prompt should be shown. */
    function shouldShowLocationPrompt() {
      // Must be on homepage search screen and input visible (no modal overlay)
      if (state.screen !== 'search') return false;
      var searchScreen = document.getElementById('screen-search');
      if (!searchScreen || !searchScreen.classList.contains('active')) return false;
      var searchEl = document.getElementById('search-input');
      if (!searchEl || searchEl.offsetParent === null) return false;
      // Don't show if dropdown is open (user is actively searching)
      var dropdown = document.getElementById('search-dropdown');
      if (dropdown && dropdown.classList.contains('open')) return false;
      return true;
    }

    if (navigator.geolocation && !state.userLat) {
      var declined = false;
      try { declined = localStorage.getItem('ps_location_declined') === '1'; } catch(e) { /* private browsing */ }
      if (!declined) {
        // First check if permission was already granted (skip prompt entirely)
        var permChecked = false;
        if (navigator.permissions && navigator.permissions.query) {
          navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
            permChecked = true;
            if (result.state === 'granted') {
              // Already granted - silently get location without prompt
              navigator.geolocation.getCurrentPosition(
                function(pos) {
                  state.userLat = pos.coords.latitude;
                  state.userLng = pos.coords.longitude;
                },
                function() {},
                { timeout: 5000, maximumAge: 300000 }
              );
            } else if (result.state === 'prompt') {
              // Permission not yet decided - show our custom modal after delay
              setTimeout(function() {
                if (!state.userLat && shouldShowLocationPrompt()) {
                  document.getElementById('location-modal').style.display = 'flex';
                }
              }, 5000);
            }
            // If 'denied', do nothing
          }).catch(function() {
            // Permissions API not available - fall back to timer
            setTimeout(function() {
              if (!state.userLat && shouldShowLocationPrompt()) {
                document.getElementById('location-modal').style.display = 'flex';
              }
            }, 5000);
          });
        }
        // Fallback for browsers without Permissions API
        if (!navigator.permissions || !navigator.permissions.query) {
          setTimeout(function() {
            if (!state.userLat && shouldShowLocationPrompt()) {
              document.getElementById('location-modal').style.display = 'flex';
            }
          }, 5000);
        }
      }
    }

    var searchDebounceTimer = null;
    var pollTimer = null;
    var uppyInstance = null;
    var resetSiteId = null;

    /** Redirect helper - stubbable in E2E tests */
    function redirectTo(url) {
      window.location.href = url;
    }

    /* ===========================================================
       Screen Navigation
       =========================================================== */
    function navigateTo(screen) {
      // Intercept details navigation to open modal instead
      if (screen === 'details') {
        openDetailsModal();
        return;
      }
      // Close details modal when navigating to any other screen
      closeDetailsModal();
      state.screen = screen;
      render();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('screen_view', { screen: screen });
      }
    }

    function openDetailsModal() {
      var modal = document.getElementById('details-modal');
      if (modal) modal.classList.add('visible');
      // Initialize Uppy if not already done
      if (!uppyInstance) {
        initUppy();
      }
      // Update the details screen fields and title
      updateDetailsScreen();
      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('screen_view', { screen: 'details' });
      }
    }

    function closeDetailsModal() {
      var modal = document.getElementById('details-modal');
      if (modal) modal.classList.remove('visible');
      // Reset the build button text and reset mode
      var buildBtn = document.getElementById('build-btn');
      if (buildBtn) { buildBtn.textContent = 'Build My Website'; buildBtn.disabled = false; }
      resetSiteId = null;
      // Clear any validation errors
      hideMsg('details-error');
      hideMsg('details-msg');
      // Remove red outlines from inputs
      var inputs = modal ? modal.querySelectorAll('.input-field, textarea') : [];
      for (var i = 0; i < inputs.length; i++) inputs[i].style.boxShadow = '';
    }

    /** CTA entry point: if logged in open the build modal; otherwise go to sign-in first. */
    function startBuildFlow() {
      if (state.session && state.session.token) {
        // Already logged in â€” go to search screen and open the details modal
        navigateTo('search');
        openDetailsModal();
      } else {
        // Not logged in â€” remember that we want to open the modal after auth
        try { sessionStorage.setItem('ps_open_modal_after_auth', '1'); } catch(e) {}
        try { localStorage.setItem('ps_open_modal_after_auth', '1'); } catch(e) {}
        navigateTo('signin');
      }
    }

    function render() {
      var screens = document.querySelectorAll('.screen');
      for (var i = 0; i < screens.length; i++) {
        screens[i].classList.remove('active');
      }
      var target = document.getElementById('screen-' + state.screen);
      if (target) {
        target.classList.add('active');
      }

      // Start polling and build terminal when on waiting screen
      if (state.screen === 'waiting') {
        updateWaitingScreen();
        startPolling();
      } else {
        stopPolling();
        stopBuildTerminal();
      }

      // Hide global footer + CTA on signin/waiting screens (they have their own)
      // Also hide footer CTA when logged in (admin dashboard replaces it)
      var globalFooter = document.querySelector('.site-footer');
      var footerCta = document.getElementById('footer-cta');
      var hideGlobal = (state.screen === 'signin' || state.screen === 'waiting');
      var hideCta = hideGlobal || (state.session && state.session.token);
      if (globalFooter) globalFooter.style.display = hideGlobal ? 'none' : '';
      if (footerCta) footerCta.style.display = hideCta ? 'none' : '';
    }

    /* ===========================================================
       Legal Page Navigation (SPA routing)
       =========================================================== */
    var _prevScreen = 'search';
    function navigateToLegal(page) {
      if (page) {
        _prevScreen = state.screen;
        navigateTo(page);
        window.history.pushState({ legal: page }, '', '/' + page);
        window.scrollTo(0, 0);
      } else {
        navigateTo(_prevScreen || 'search');
        window.history.pushState({}, '', '/');
        window.scrollTo(0, 0);
      }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', function(e) {
      if (e.state && e.state.legal) {
        state.screen = e.state.legal;
        render();
      } else {
        state.screen = _prevScreen || 'search';
        render();
      }
    });

    /* ===========================================================
       Search Logic
       =========================================================== */
    var searchInput = document.getElementById('search-input');
    var searchDropdown = document.getElementById('search-dropdown');
    var searchSpinner = document.getElementById('search-spinner');

    searchInput.addEventListener('input', function() {
      var query = searchInput.value.trim();
      state.searchQuery = query;

      clearTimeout(searchDebounceTimer);
      hideMsg('search-error');

      if (query.length < 2) {
        searchSpinner.classList.remove('visible');
        closeDropdown();
        return;
      }

      searchSpinner.classList.add('visible');

      searchDebounceTimer = setTimeout(function() {
        performSearch(query);
      }, 300);
    });

    searchInput.addEventListener('focus', function() {
      if (state.searchResults.length > 0 || state.preBuiltResults.length > 0 || state.searchQuery.length >= 2) {
        renderDropdown();
      }
    });

    // Close dropdown on click outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-wrapper')) {
        closeDropdown();
      }
    });

    function performSearch(query) {
      // Build search URL with optional geolocation for local-biased results
      var searchUrl = '/api/search/businesses?q=' + encodeURIComponent(query);
      if (state.userLat !== null && state.userLng !== null) {
        searchUrl += '&lat=' + state.userLat + '&lng=' + state.userLng;
      }

      // Search both pre-built sites and Google Places in parallel
      var sitesPromise = fetch('/api/sites/search?q=' + encodeURIComponent(query))
        .then(function(res) { return res.ok ? res.json() : { data: [] }; })
        .then(function(d) { return d.data || []; })
        .catch(function() { return []; });

      var placesPromise = fetch(searchUrl)
        .then(function(res) { return res.json(); })
        .then(function(d) {
          // Surface API errors to the user
          if (d._error) {
            console.warn('Search API error:', d._error);
          }
          return d.data || [];
        })
        .catch(function() { return []; });

      Promise.all([sitesPromise, placesPromise])
        .then(function(results) {
          // Guard: if query changed while fetching, discard stale results
          if (state.searchQuery.trim().length < 2) {
            searchSpinner.classList.remove('visible');
            closeDropdown();
            return;
          }
          searchSpinner.classList.remove('visible');
          state.preBuiltResults = Array.isArray(results[0]) ? results[0] : [];
          state.searchResults = Array.isArray(results[1]) ? results[1] : [];
          renderDropdown();
        })
        .catch(function() {
          searchSpinner.classList.remove('visible');
          state.preBuiltResults = [];
          state.searchResults = [];
          renderDropdown();
        });
    }

    /** Calculate distance in km between two lat/lng points using Haversine formula. */
    function haversineKm(lat1, lng1, lat2, lng2) {
      var R = 6371;
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLng = (lng2 - lng1) * Math.PI / 180;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    /** Format distance for display. */
    function formatDistance(km) {
      var miles = km * 0.621371;
      if (miles < 0.1) return '< 0.1 mi';
      if (miles < 10) return miles.toFixed(1) + ' mi';
      return Math.round(miles) + ' mi';
    }

    function renderDropdown() {
      var html = '';
      var preBuilt = state.preBuiltResults || [];

      // Deduplicate pre-built sites by name + address
      var preBuiltSeen = {};
      preBuilt = preBuilt.filter(function(pb) {
        var key = ((pb.business_name || pb.name || '') + '|' + (pb.business_address || pb.address || '')).toLowerCase().trim();
        if (preBuiltSeen[key]) return false;
        preBuiltSeen[key] = true;
        return true;
      });

      // Sort Google Places results by distance when location is available
      var results = state.searchResults || [];
      if (state.userLat !== null && state.userLng !== null && results.length > 0) {
        results = results.slice().sort(function(a, b) {
          var distA = (a.lat != null && a.lng != null)
            ? haversineKm(state.userLat, state.userLng, a.lat, a.lng)
            : Infinity;
          var distB = (b.lat != null && b.lng != null)
            ? haversineKm(state.userLat, state.userLng, b.lat, b.lng)
            : Infinity;
          return distA - distB;
        });
        // Attach distance for display
        for (var k = 0; k < results.length; k++) {
          if (results[k].lat != null && results[k].lng != null) {
            results[k]._distance = haversineKm(state.userLat, state.userLng, results[k].lat, results[k].lng);
          }
        }
      }

      // Pre-built sites first (already generated)
      for (var j = 0; j < preBuilt.length; j++) {
        var pb = preBuilt[j];
        html += '<div class="search-result search-result-prebuilt" onclick="selectPreBuilt(' + j + ')">'
              +   '<div class="search-result-icon" style="background:rgba(34,197,94,0.12)">'
              +     '<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
              +       '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
              +     '</svg>'
              +   '</div>'
              +   '<div class="search-result-text">'
              +     '<div class="search-result-name">' + escapeHtml(pb.business_name || pb.name || '') + ' <span style="display:inline-block;background:rgba(34,197,94,0.15);color:#22c55e;font-size:0.7rem;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;letter-spacing:0.03em">PRE-BUILT</span></div>'
              +     '<div class="search-result-address">' + escapeHtml(pb.business_address || pb.address || 'Ready to view') + '</div>'
              +   '</div>'
              + '</div>';
      }

      // Filter out Google Places results that already appear as pre-built sites
      // Match by google_place_id first, then by normalized business name as fallback
      var preBuiltPlaceIds = {};
      var preBuiltNames = {};
      for (var p = 0; p < preBuilt.length; p++) {
        if (preBuilt[p].google_place_id) {
          preBuiltPlaceIds[preBuilt[p].google_place_id] = true;
        }
        var pbName = (preBuilt[p].business_name || '').toLowerCase().trim();
        if (pbName) preBuiltNames[pbName] = true;
      }
      results = results.filter(function(r) {
        var pid = r.place_id || r.id || '';
        if (pid && preBuiltPlaceIds[pid]) return false;
        var rName = (r.name || r.business_name || '').toLowerCase().trim();
        if (rName && preBuiltNames[rName]) return false;
        return true;
      });

      // Deduplicate by name + address (same business appearing multiple times)
      var seen = {};
      results = results.filter(function(r) {
        var key = ((r.name || r.business_name || '') + '|' + (r.address || r.formatted_address || '')).toLowerCase().trim();
        if (seen[key]) return false;
        seen[key] = true;
        return true;
      });

      // Google Places results (sorted by distance when location available)
      // Update state.searchResults to match sorted order so selectBusiness(index) works
      state.searchResults = results;
      for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var distLabel = (r._distance != null) ? ' <span style="color:var(--text-muted);font-size:0.75rem;margin-left:6px">' + formatDistance(r._distance) + '</span>' : '';
        html += '<div class="search-result" onclick="selectBusiness(' + i + ')">'
              +   '<div class="search-result-icon">'
              +     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
              +       '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>'
              +     '</svg>'
              +   '</div>'
              +   '<div class="search-result-text">'
              +     '<div class="search-result-name">' + escapeHtml(r.name || r.business_name || '') + distLabel + '</div>'
              +     '<div class="search-result-address">' + escapeHtml(r.address || r.formatted_address || r.street_address || '') + '</div>'
              +   '</div>'
              + '</div>';
      }

      // Custom website option (always shown)
      html += '<div class="search-result search-result-custom" onclick="selectCustom()">'
            +   '<div class="search-result-icon">'
            +     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
            +       '<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>'
            +     '</svg>'
            +   '</div>'
            +   '<div class="search-result-text">'
            +     '<div class="search-result-name">Custom Website</div>'
            +     '<div class="search-result-address">Build a custom website from scratch</div>'
            +   '</div>'
            + '</div>';

      searchDropdown.innerHTML = html;
      searchDropdown.classList.add('open');
    }

    function closeDropdown() {
      searchDropdown.classList.remove('open');
    }

    /* ===========================================================
       Business Selection
       =========================================================== */
    function selectBusiness(index) {
      var biz = state.searchResults[index];
      state.selectedBusiness = biz;
      state.mode = 'business';
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('business_selected', { name: biz.name || biz.business_name });
      }

      // Check if a site already exists
      var placeId = biz.place_id || biz.id || '';
      if (!placeId) {
        // No place_id - go directly to details (sign-in deferred to build)
        navigateTo('details');
        return;
      }

      showInlineLoading('search-error', 'Checking if a site exists...');

      fetch('/api/sites/lookup?place_id=' + encodeURIComponent(placeId))
        .then(function(res) {
          if (res.status === 404) return null;
          if (!res.ok) throw new Error('Lookup failed');
          return res.json();
        })
        .then(function(json) {
          hideMsg('search-error');
          var site = json && json.data ? json.data : json;
          if (!site || site.exists === false) {
            // No existing site -> go to details (sign-in deferred)
            navigateTo('details');
            return;
          }

          // A site already exists for this business.
          // If the user is signed in and owns the site, use it. Otherwise,
          // proceed to details to create a new one (backend ensures unique slug).
          if (site.status === 'published' && site.slug) {
            // Show the published site but also allow creating a new one
            redirectTo('https://' + site.slug + '-sites.megabyte.space');
          } else if (site.status === 'queued' || site.status === 'building') {
            // Check if the user owns this building site
            if (state.session && state.session.token) {
              state.siteId = site.id || site.site_id;
              state.slug = site.slug;
              navigateTo('waiting');
            } else {
              // Not signed in - let them create their own version
              navigateTo('details');
            }
          } else {
            // Draft or other - go to details
            navigateTo('details');
          }
        })
        .catch(function(err) {
          hideMsg('search-error');
          // On error, just proceed to details
          navigateTo('details');
        });
    }

    function selectPreBuilt(index) {
      var site = state.preBuiltResults[index];
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('prebuilt_site_selected', { slug: site.slug, name: site.business_name });
      }

      if (site.status === 'published' && site.slug) {
        // Published - redirect to the live site
        redirectTo('https://' + site.slug + '-sites.megabyte.space');
      } else if (site.status === 'queued' || site.status === 'building') {
        // Still building - show waiting screen with the slug (not UUID)
        state.siteId = site.site_id || site.id;
        state.slug = site.slug;
        state.selectedBusiness = { name: site.business_name, address: site.business_address || '' };
        navigateTo('waiting');
      } else {
        // Draft or other - go to details to configure and trigger build
        state.selectedBusiness = {
          name: site.business_name,
          address: site.business_address || '',
          place_id: site.google_place_id || ''
        };
        state.mode = 'business';
        navigateTo('details');
      }
    }

    function selectCustom() {
      state.selectedBusiness = null;
      state.mode = 'custom';
      closeDropdown();

      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('custom_website_selected');
      }

      // Go directly to details - sign-in deferred to build
      navigateTo('details');
    }

    /* ===========================================================
       Sign-In Logic
       =========================================================== */
    function showSigninPanel(panel) {
      state.signinPanel = panel;

      var methodsEl = document.getElementById('signin-methods');
      var emailPanel = document.getElementById('signin-email-panel');
      var backToSearch = document.getElementById('signin-back-to-search');

      methodsEl.style.display = 'none';
      emailPanel.classList.remove('active');

      if (panel === 'main') {
        methodsEl.style.display = 'flex';
        backToSearch.style.display = '';
      } else if (panel === 'email') {
        emailPanel.classList.add('active');
        backToSearch.style.display = 'none';
        // Reset to fresh input state so "Check your email" message is cleared
        document.getElementById('email-step-input').style.display = '';
        document.getElementById('email-step-sent').style.display = 'none';
        hideMsg('email-send-msg');
        document.getElementById('email-input').focus();
      }
    }

    // Reset panels whenever we navigate to signin
    var origNavigateTo = navigateTo;
    navigateTo = function(screen) {
      if (screen === 'signin') {
        setTimeout(function() { showSigninPanel('main'); }, 10);
        window.scrollTo(0, 0);
      }
      if (screen === 'details') {
        updateDetailsScreen();
        // Clear pending build flag - always let user review details before building
        state._pendingBuild = false;
      }
      if (screen === 'waiting') {
        // Instead of showing waiting screen, go to admin dashboard and open logs
        stopBuildTerminal();
        origNavigateTo('admin');
        loadAdminDashboard();
        setTimeout(function() {
          var siteName = state.businessName || state.slug || 'Building site';
          if (state.siteId) openSiteLogsModal(state.siteId, siteName);
        }, 600);
        return;
      } else {
        stopBuildTerminal();
      }
      origNavigateTo(screen);
    };

    function signInWithGoogle() {
      if (typeof posthog !== 'undefined' && posthog.capture) {
        posthog.capture('signin_google_clicked');
      }

      var redirectUrl = window.location.origin + window.location.pathname + '?auth_callback=google';
      redirectTo('/api/auth/google?redirect_url=' + encodeURIComponent(redirectUrl));
    }

    /** Extract a human-readable error message from an API error response. */
    function extractErrorMsg(d, fallback) {
      if (!d) return fallback;
      if (typeof d === 'string') return d;
      if (typeof d.message === 'string') return d.message;
      if (d.error && typeof d.error === 'string') return d.error;
      if (d.error && typeof d.error.message === 'string') return d.error.message;
      return fallback;
    }

    function sendMagicLink() {
      var email = document.getElementById('email-input').value.trim().toLowerCase();
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        showMsg('email-send-msg', 'error', 'Please enter a valid email address.');
        return;
      }
      if (email.length > 254) {
        showMsg('email-send-msg', 'error', 'Email address is too long.');
        return;
      }

      var btn = document.getElementById('email-send-btn');
      btn.disabled = true;
      btn.innerHTML = 'Sending <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('email-send-msg');

      // Save business selection to localStorage before sending magic link
      // so when the user clicks the link (possibly in a new tab), we can restore it
      if (state.selectedBusiness) {
        try {
          localStorage.setItem('ps_selected_business', JSON.stringify(state.selectedBusiness));
          localStorage.setItem('ps_mode', state.mode);
        } catch(e) { /* private browsing */ }
      }
      if (state._pendingBuild) {
        try { localStorage.setItem('ps_pending_build', '1'); } catch(e) {}
      }

      // Build a redirect_url that carries business info so the magic link
      // callback can restore the badge even in a new browser tab
      var redirectParams = new URLSearchParams();
      if (state.selectedBusiness) {
        var biz = state.selectedBusiness;
        var bn = biz.name || biz.business_name || '';
        var ba = biz.address || biz.formatted_address || biz.street_address || '';
        var bp = biz.place_id || biz.id || '';
        if (bn) redirectParams.set('biz_name', bn);
        if (ba) redirectParams.set('biz_address', ba);
        if (bp) redirectParams.set('biz_place_id', bp);
        redirectParams.set('mode', state.mode || 'business');
      }
      var redirectUrl = window.location.origin + window.location.pathname;
      var rp = redirectParams.toString();
      if (rp) redirectUrl += '?' + rp;

      fetch('/api/auth/magic-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, redirect_url: redirectUrl })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to send link')); });
          return res.json();
        })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = 'Send Magic Link';
          // Clear the email input and hide the form, show success message
          document.getElementById('email-input').value = '';
          document.getElementById('email-step-input').style.display = 'none';
          document.getElementById('email-step-sent').style.display = 'block';

          // Store session for optimistic flow (real auth comes via redirect)
          state.session = {
            token: data.token || '',
            identifier: email
          };
          saveSession();
          updateNavAuth();

          if (typeof posthog !== 'undefined' && posthog.capture) {
            posthog.capture('signin_email_sent', { email: email });
          }
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Send Magic Link';
          showMsg('email-send-msg', 'error', err.message || 'Failed to send magic link. Please try again.');
        });
    }

    /* ===========================================================
       Details Screen
       =========================================================== */
    function updateDetailsScreen() {
      var titleEl = document.getElementById('details-title');
      var subtitleEl = document.getElementById('details-subtitle');
      var badgeEl = document.getElementById('details-business-badge');
      var manualFields = document.getElementById('details-manual-fields');

      if (state.mode === 'custom') {
        titleEl.textContent = 'Describe your custom website';
        subtitleEl.textContent = 'Search for your business or enter details manually. We\'ll also search the web for public info.';
        badgeEl.style.display = 'none';
        // Always show the business name/address live search fields
        manualFields.style.display = 'block';
      } else {
        titleEl.textContent = 'Tell us more about your business';
        subtitleEl.textContent = 'Include everything important for your website. We\'ll also search the web for public info about your business.';

        if (state.selectedBusiness) {
          var biz = state.selectedBusiness;
          document.getElementById('badge-biz-name').textContent = biz.name || biz.business_name || 'Selected Business';
          document.getElementById('badge-biz-addr').textContent = biz.address || biz.formatted_address || biz.street_address || '';
          badgeEl.style.display = 'flex';
          // Show manual fields below the badge so users can still see/edit
          manualFields.style.display = 'none';
        } else {
          badgeEl.style.display = 'none';
          // Always show business name/address fields with live search
          manualFields.style.display = 'block';
        }
      }

      // Show/hide Google Place ID info if available
      var placeId = state.selectedBusiness ? (state.selectedBusiness.place_id || state.selectedBusiness.id || '') : '';
      var placeIdEl = document.getElementById('details-place-id-info');
      if (placeIdEl) {
        if (placeId) {
          placeIdEl.style.display = 'block';
          var placeIdText = document.getElementById('details-place-id-text');
          if (placeIdText) {
            placeIdText.textContent = placeId;
            placeIdText.href = 'https://www.google.com/maps/place/?q=place_id:' + encodeURIComponent(placeId);
          }
        } else {
          placeIdEl.style.display = 'none';
        }
      }
    }

    /** Dismiss the business badge: transfer data to manual fields. */
    function dismissBusinessBadge() {
      // Preserve business data to pre-populate the manual input fields
      var prevName = '';
      var prevAddr = '';
      if (state.selectedBusiness) {
        prevName = state.selectedBusiness.name || state.selectedBusiness.business_name || '';
        prevAddr = state.selectedBusiness.address || state.selectedBusiness.formatted_address || state.selectedBusiness.street_address || '';
      }

      state.selectedBusiness = null;
      state.mode = 'custom';
      var badgeEl = document.getElementById('details-business-badge');
      var manualFields = document.getElementById('details-manual-fields');
      var titleEl = document.getElementById('details-title');
      var subtitleEl = document.getElementById('details-subtitle');
      if (badgeEl) badgeEl.style.display = 'none';
      if (manualFields) manualFields.style.display = 'block';
      if (titleEl) titleEl.textContent = 'Tell us about your business';
      if (subtitleEl) subtitleEl.textContent = 'Enter your business details and we\'ll build your website.';

      // Pre-populate manual fields with the dismissed badge data
      var nameInput = document.getElementById('business-name-input');
      var addressInput = document.getElementById('business-address-input');
      if (nameInput && prevName) nameInput.value = prevName;
      if (addressInput && prevAddr) addressInput.value = prevAddr;
    }

    /** Remove the Google Place ID from the selected business without dismissing the entire badge. */
    function removeGooglePlaceId() {
      if (state.selectedBusiness) {
        delete state.selectedBusiness.place_id;
        delete state.selectedBusiness.id;
      }
      var placeIdEl = document.getElementById('details-place-id-info');
      if (placeIdEl) placeIdEl.style.display = 'none';
    }

    /* ===========================================================
       Address Autocomplete (Google Places)
       =========================================================== */
    var addressDebounceTimer = null;
    var addressDropdown = document.getElementById('address-dropdown');
    var addressInput = document.getElementById('business-address-input');

    if (addressInput) {
      addressInput.addEventListener('input', function() {
        var q = addressInput.value.trim();
        clearTimeout(addressDebounceTimer);
        if (q.length < 3) {
          closeAddressDropdown();
          return;
        }
        addressDebounceTimer = setTimeout(function() {
          fetchAddressSuggestions(q);
        }, 250);
      });

      addressInput.addEventListener('focus', function() {
        if (addressInput.value.trim().length >= 3 && addressDropdown.children.length > 0) {
          addressDropdown.classList.add('open');
        }
      });

      // Close on click outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#business-address-input') && !e.target.closest('#address-dropdown')) {
          closeAddressDropdown();
        }
      });
    }

    function fetchAddressSuggestions(query) {
      var url = '/api/search/address?q=' + encodeURIComponent(query);
      if (state.userLat !== null && state.userLng !== null) {
        url += '&lat=' + state.userLat + '&lng=' + state.userLng;
      }
      fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(d) {
          var items = d.data || [];
          renderAddressDropdown(items);
        })
        .catch(function() {
          closeAddressDropdown();
        });
    }

    function renderAddressDropdown(items) {
      if (!items.length) {
        closeAddressDropdown();
        return;
      }
      var html = '';
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        html += '<div class="address-item" onclick="selectAddress(' + i + ')" data-description="' + escapeHtml(item.description) + '">'
              +   '<div class="address-item-icon">'
              +     '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
              +       '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>'
              +     '</svg>'
              +   '</div>'
              +   '<div class="address-item-text">'
              +     '<div class="address-item-main">' + escapeHtml(item.main_text || item.description) + '</div>'
              +     (item.secondary_text ? '<div class="address-item-secondary">' + escapeHtml(item.secondary_text) + '</div>' : '')
              +   '</div>'
              + '</div>';
      }
      addressDropdown.innerHTML = html;
      addressDropdown.classList.add('open');
      // Store items for selection
      addressDropdown._items = items;
    }

    function selectAddress(index) {
      var items = addressDropdown._items || [];
      if (items[index]) {
        addressInput.value = items[index].description || items[index].main_text;
      }
      closeAddressDropdown();
    }

    function closeAddressDropdown() {
      if (addressDropdown) addressDropdown.classList.remove('open');
    }

    function initUppy() {
      if (typeof Uppy === 'undefined') {
        setTimeout(initUppy, 200);
        return;
      }

      var dashboardTarget = document.getElementById('uppy-dashboard-area');
      if (!dashboardTarget) return;

      uppyInstance = new Uppy.Uppy({
        restrictions: {
          maxFileSize: 100 * 1024 * 1024,
          maxNumberOfFiles: 5,
          allowedFileTypes: ['.jpg', '.jpeg', '.png', '.svg', '.webp', '.pdf']
        },
        autoProceed: false
      });

      uppyInstance.use(Uppy.Dashboard, {
        target: '#uppy-dashboard-area',
        inline: true,
        width: '100%',
        height: 220,
        hideUploadButton: true,
        proudlyDisplayPoweredByUppy: false,
        theme: 'dark',
        note: 'Images (JPG, PNG, SVG, WebP) and PDFs. Max 100MB each, up to 5 files.'
      });
    }

    function showAiValidationTooltip(btn) {
      hideAiValidationTooltip(btn);
      if (!btn || !btn.parentElement) return;
      btn.parentElement.style.position = 'relative';
      var tip = document.createElement('div');
      tip.className = 'ai-validation-tooltip';
      tip.textContent = 'Validating with AI\u2026';
      tip.id = 'ai-tooltip-' + (btn.id || 'build');
      btn.parentElement.appendChild(tip);
    }
    function hideAiValidationTooltip(btn) {
      if (!btn || !btn.parentElement) return;
      var existing = btn.parentElement.querySelector('.ai-validation-tooltip');
      if (existing) existing.remove();
    }

    function submitBuild() {
      // If not signed in, require sign-in first, then auto-build after callback
      if (!state.session || !state.session.token) {
        state._pendingBuild = true;
        navigateTo('signin');
        return;
      }

      var rawContext = document.getElementById('details-textarea').value.trim();
      // Save to localStorage for re-use on Reset
      try { localStorage.setItem('ps_business_context', rawContext); } catch(e) { /* private browsing */ }
      // Client-side sanitization: strip HTML tags and limit length
      var additionalContext = rawContext.replace(/<[^>]*>/g, '').slice(0, 5000);
      var btn = document.getElementById('build-btn');

      // Validate additional context doesn't contain script injection
      if (/<script/i.test(rawContext) || /javascript:/i.test(rawContext)) {
        showMsg('build-msg', 'error', 'Invalid characters detected in your input. Please remove any HTML or script tags.');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = 'Building <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('build-msg');

      var payload = {
        mode: state.mode,
        additional_context: additionalContext
      };

      if (state.selectedBusiness) {
        payload.business = {
          name: state.selectedBusiness.name || state.selectedBusiness.business_name,
          address: state.selectedBusiness.address || state.selectedBusiness.formatted_address || state.selectedBusiness.street_address,
          place_id: state.selectedBusiness.place_id || state.selectedBusiness.id,
          phone: state.selectedBusiness.phone || state.selectedBusiness.phone_number,
          website: state.selectedBusiness.website,
          types: state.selectedBusiness.types
        };
      } else {
        var manualNameEl = document.getElementById('business-name-input');
        var manualAddrEl = document.getElementById('business-address-input');
        var manualName = manualNameEl.value.trim();
        var manualAddr = manualAddrEl.value.trim();
        // Clear previous red outlines
        manualNameEl.style.boxShadow = '';
        manualAddrEl.style.boxShadow = '';
        if (!manualName) {
          showMsg('build-msg', 'error', 'Please enter your business name.');
          manualNameEl.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.3)';
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          return;
        }
        if (!manualAddr) {
          showMsg('build-msg', 'error', 'Please enter your business address.');
          manualAddrEl.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.3)';
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          return;
        }
        payload.business = { name: manualName, address: manualAddr };
      }

      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      // Show AI validation tooltip
      showAiValidationTooltip(btn);

      // AI validation check before submitting
      fetch('/api/validate-business', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          name: payload.business ? payload.business.name : '',
          address: payload.business ? payload.business.address : '',
          context: additionalContext
        })
      })
        .then(function(res) { return res.ok ? res.json() : null; })
        .then(function(d) {
          hideAiValidationTooltip(btn);
          if (d && d.data && !d.data.valid) {
            showMsg('build-msg', 'error', d.data.reason || 'Business data does not appear to be legitimate.');
            btn.disabled = false;
            btn.textContent = 'Build My Website';
            return;
          }
          // Validation passed - proceed with build
          createSiteFromSearch(payload, headers, btn);
        })
        .catch(function() {
          hideAiValidationTooltip(btn);
          // If AI validation fails, proceed anyway
          createSiteFromSearch(payload, headers, btn);
        });
    }

    function createSiteFromSearch(payload, headers, btn) {
      fetch('/api/sites/create-from-search', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error((d.error && d.error.message) || d.error || 'Failed to create site'); });
          return res.json();
        })
        .then(function(resp) {
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          var data = resp.data || resp;
          state.siteId = data.site_id || data.id;
          state.slug = data.slug;

          if (typeof posthog !== 'undefined' && posthog.capture) {
            posthog.capture('site_build_started', { mode: state.mode, site_id: state.siteId });
          }

          // Upload files if any
          if (uppyInstance && uppyInstance.getFiles().length > 0 && state.siteId) {
            uppyInstance.use(Uppy.XHRUpload, {
              endpoint: '/api/sites/' + state.siteId + '/uploads',
              headers: headers,
              fieldName: 'file',
              formData: true
            });
            uppyInstance.upload().then(function() {
              navigateTo('waiting');
            }).catch(function() {
              // Even if upload fails, proceed to waiting
              navigateTo('waiting');
            });
          } else {
            navigateTo('waiting');
          }
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Build My Website';
          showMsg('build-msg', 'error', err.message || 'Something went wrong. Please try again.');
        });
    }

    /* ===========================================================
       Waiting Screen
       =========================================================== */
    function updateWaitingScreen() {
      // Put slug/name in the terminal title bar
      var termTitle = document.getElementById('build-terminal-title');
      if (termTitle) {
        var refLabel = state.slug || (state.selectedBusiness && (state.selectedBusiness.name || state.selectedBusiness.business_name)) || '';
        termTitle.textContent = refLabel ? 'build: ' + refLabel : 'build-progress';
      }
    }

    function startPolling() {
      stopPolling();
      if (!state.siteId) return;

      // Start the real build terminal
      startBuildTerminal();

      pollTimer = setInterval(function() {
        var headers = {};
        if (state.session && state.session.token) {
          headers['Authorization'] = 'Bearer ' + state.session.token;
        }

        fetch('/api/sites/' + state.siteId, { headers: headers })
          .then(function(res) {
            if (!res.ok) return null;
            return res.json();
          })
          .then(function(resp) {
            if (!resp) return;
            var site = resp.data || resp;
            if (site.status === 'published' && (site.slug || state.slug)) {
              stopPolling();
              stopBuildTerminal();
              var slug = site.slug || state.slug;
              // Let the terminal show completion for a moment before redirect
              setTimeout(function() {
                redirectTo('https://' + slug + '-sites.megabyte.space');
              }, 3000);
            }
          })
          .catch(function() {
            // Silently continue polling
          });
      }, 10000);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    /* ===========================================================
       Message Helpers
       =========================================================== */
    function showMsg(id, type, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.className = 'msg msg-' + type + ' visible';
      el.textContent = text;
    }

    function hideMsg(id) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('visible');
    }

    function showInlineLoading(id, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.className = 'msg msg-info visible';
      el.innerHTML = text + ' <span class="loading-dots"><span></span><span></span><span></span></span>';
    }

    /* ===========================================================
       Utilities
       =========================================================== */
    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    /** Escape a string for safe embedding in inline onclick='' attributes (escapes single quotes too). */
    function escapeAttr(str) {
      if (!str) return '';
      return escapeHtml(str).replace(/'/g, '&#39;');
    }

    /** Escape a string for safe use inside JavaScript string literals within HTML attributes.
     *  Handles apostrophes, backslashes, and other JS-breaking characters. */
    function escapeJsString(str) {
      if (!str) return '';
      return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/</g, '\\x3C').replace(/>/g, '\\x3E');
    }

    /** Show a toast notification (type: 'error' | 'success' | 'info') */
    function showToast(message, type, duration) {
      type = type || 'info';
      duration = duration || 5000;
      var container = document.getElementById('toast-container');
      if (!container) return;
      var icons = { error: 'âœ•', success: 'âœ“', info: 'â„¹' };
      var toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      toast.innerHTML = '<span class="toast-icon">' + (icons[type] || '') + '</span>' +
        '<span>' + escapeHtml(message) + '</span>' +
        '<button class="toast-dismiss" onclick="this.parentElement.remove()">&times;</button>';
      container.appendChild(toast);
      setTimeout(function() { if (toast.parentElement) toast.remove(); }, duration);
    }

    /** Format file size in human-readable format */
    function formatFileSize(bytes) {
      if (bytes == null || bytes === 0) return '0 B';
      var units = ['B', 'KB', 'MB', 'GB'];
      var i = 0;
      var size = bytes;
      while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
      return (i === 0 ? size : size.toFixed(1)) + ' ' + units[i];
    }

    /* Material-style ripple effect on button clicks */
    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.btn, .site-card-btn, .admin-btn, .admin-btn-accent, .logs-refresh-btn, .domain-tab, .hostname-delete-btn, .signin-btn, .back-link, .modal-close, .details-modal-close, .header-auth-btn, .site-card-new, .site-card-upgrade-btn, .inline-edit-btn, .inline-save-btn, .inline-cancel-btn, .faq-question, .btn-allow, .btn-skip, .improve-ai-link, .plan-badge, .dc-btn, .editor-toolbar-btn');
      if (!btn) return;
      var circle = document.createElement('span');
      circle.className = 'ripple-circle';
      var rect = btn.getBoundingClientRect();
      // Size ripple to max(width, height) so it fills the button
      var size = Math.max(rect.width, rect.height);
      // Ensure minimum 40px so tiny buttons still get a visible ripple
      size = Math.max(size, 40);
      circle.style.width = size + 'px';
      circle.style.height = size + 'px';
      circle.style.marginTop = -(size / 2) + 'px';
      circle.style.marginLeft = -(size / 2) + 'px';
      circle.style.left = (e.clientX - rect.left) + 'px';
      circle.style.top = (e.clientY - rect.top) + 'px';
      btn.appendChild(circle);
      setTimeout(function() { circle.remove(); }, 650);
    });

    /* Global Escape key handler for all modals */
    document.addEventListener('keydown', function(e) {
      if (e.key !== 'Escape') return;
      var modals = [
        { id: 'details-modal', close: typeof closeDetailsModal === 'function' ? closeDetailsModal : null },
        { id: 'domain-modal', close: typeof closeDomainModal === 'function' ? closeDomainModal : null },
        { id: 'delete-modal', close: typeof closeDeleteModal === 'function' ? closeDeleteModal : null },
        { id: 'site-logs-modal', close: typeof closeSiteLogsModal === 'function' ? closeSiteLogsModal : null },
        { id: 'deploy-modal', close: typeof closeDeployModal === 'function' ? closeDeployModal : null },
        { id: 'new-website-modal', close: typeof closeNewWebsiteModal === 'function' ? closeNewWebsiteModal : null },
        { id: 'files-modal', close: typeof closeFilesModal === 'function' ? closeFilesModal : null },
      ];
      for (var i = 0; i < modals.length; i++) {
        var el = document.getElementById(modals[i].id);
        if (el && el.classList.contains('visible') && modals[i].close) {
          modals[i].close();
          return;
        }
      }
    });

    /* ===========================================================
       Handle Auth Callback
       =========================================================== */
    (function handleAuthCallback() {
      var params = new URLSearchParams(window.location.search);

      if (params.has('auth_callback') || params.has('token') || params.has('access_token')) {
        var token = params.get('token') || params.get('access_token') || '';
        var email = params.get('email') || '';
        var phone = params.get('phone') || '';

        if (token) {
          state.session = {
            token: token,
            identifier: email || phone || 'Authenticated'
          };
          saveSession();
          updateNavAuth();

          // Read business info from URL params (carried through magic link redirect_url)
          var bizName = params.get('biz_name') || '';
          var bizAddr = params.get('biz_address') || '';
          var bizPlaceId = params.get('biz_place_id') || '';
          var bizMode = params.get('mode') || '';

          // Clean URL
          var cleanUrl = window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);

          // Restore any selected business from sessionStorage (Google OAuth)
          // or localStorage (magic link - may open in new tab)
          var savedBiz = sessionStorage.getItem('ps_selected_business') || localStorage.getItem('ps_selected_business');
          var savedMode = sessionStorage.getItem('ps_mode') || localStorage.getItem('ps_mode');
          var savedPendingBuild = sessionStorage.getItem('ps_pending_build') || localStorage.getItem('ps_pending_build');
          if (savedBiz) {
            try {
              state.selectedBusiness = JSON.parse(savedBiz);
              state.mode = savedMode || 'business';
            } catch (e) { /* ignore */ }
            sessionStorage.removeItem('ps_selected_business');
            sessionStorage.removeItem('ps_mode');
            try {
              localStorage.removeItem('ps_selected_business');
              localStorage.removeItem('ps_mode');
            } catch(e) {}
          }

          // Fallback: restore business from URL params if not found in storage
          if (!state.selectedBusiness && bizName) {
            state.selectedBusiness = { name: bizName, address: bizAddr, place_id: bizPlaceId };
            state.mode = bizMode || 'business';
          }

          if (savedPendingBuild) {
            state._pendingBuild = true;
            sessionStorage.removeItem('ps_pending_build');
            try { localStorage.removeItem('ps_pending_build'); } catch(e) {}
          }

          // Clean up CTA open-modal flag
          sessionStorage.removeItem('ps_open_modal_after_auth');
          try { localStorage.removeItem('ps_open_modal_after_auth'); } catch(e) {}

          navigateTo('details');
        }
      }
    })();

    // Save business selection + pending build + open-modal flag before Google redirect
    var origSignInWithGoogle = signInWithGoogle;
    signInWithGoogle = function() {
      if (state.selectedBusiness) {
        sessionStorage.setItem('ps_selected_business', JSON.stringify(state.selectedBusiness));
        sessionStorage.setItem('ps_mode', state.mode);
      }
      if (state._pendingBuild) {
        sessionStorage.setItem('ps_pending_build', '1');
      }
      // Preserve CTA open-modal flag across the OAuth redirect
      try {
        var openModal = localStorage.getItem('ps_open_modal_after_auth');
        if (openModal) sessionStorage.setItem('ps_open_modal_after_auth', '1');
      } catch(e) {}
      origSignInWithGoogle();
    };

    /* ===========================================================
       Billing Success: handle ?billing=success return
       =========================================================== */
    (function handleBillingReturn() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('billing') === 'success') {
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        // Check if user had a paid intent (came from Get Started button)
        var paidIntent;
        try { paidIntent = localStorage.getItem('ps_paid_intent'); } catch(e) {}
        if (paidIntent) {
          try { localStorage.removeItem('ps_paid_intent'); } catch(e) {}
          // Payment succeeded â€” open the build modal so user can build their site
          setTimeout(function() { openDetailsModal(); }, 300);
        }
      }
    })();

    /* ===========================================================
       Keyboard: Enter to select first result
       =========================================================== */
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDropdown();
        searchInput.blur();
      }
    });

    /* ===========================================================
       FAQ Accordion
       =========================================================== */
    function toggleFaq(btn) {
      var item = btn.parentElement;
      var wasOpen = item.classList.contains('open');
      // Close all
      var allItems = document.querySelectorAll('.faq-item');
      for (var i = 0; i < allItems.length; i++) {
        allItems[i].classList.remove('open');
      }
      // Toggle clicked
      if (!wasOpen) {
        item.classList.add('open');
      }
    }

    /* ===========================================================
       Pricing Toggle (monthly/annual)
       =========================================================== */
    var pricingIsAnnual = false;

    function togglePricing() {
      pricingIsAnnual = !pricingIsAnnual;
      var sw = document.getElementById('toggle-switch');
      var monthlyLabel = document.getElementById('toggle-monthly');
      var annualLabel = document.getElementById('toggle-annual');
      var amount = document.getElementById('pricing-amount');
      var desc = document.getElementById('pricing-desc-text');

      if (pricingIsAnnual) {
        sw.classList.add('annual');
        monthlyLabel.classList.remove('active');
        annualLabel.classList.add('active');
        amount.innerHTML = '<span class="pricing-original">$600</span>$480<span>/yr</span>';
        desc.textContent = 'Save $120/year (2 months free). Billed annually.';
      } else {
        sw.classList.remove('annual');
        monthlyLabel.classList.add('active');
        annualLabel.classList.remove('active');
        amount.innerHTML = '$50<span>/mo</span>';
        desc.textContent = 'Everything you need from a business website.';
      }
    }

    /* ===========================================================
       Contact Form
       =========================================================== */
    function submitContactForm() {
      var name = document.getElementById('contact-name').value.trim();
      var email = document.getElementById('contact-email').value.trim().toLowerCase();
      var phone = document.getElementById('contact-phone').value.trim();
      var message = document.getElementById('contact-message').value.trim();

      // Client-side validation
      if (!name || name.length < 1) {
        showMsg('contact-msg', 'error', 'Please enter your name.');
        return;
      }
      if (name.length > 200) {
        showMsg('contact-msg', 'error', 'Name is too long (max 200 characters).');
        return;
      }
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        showMsg('contact-msg', 'error', 'Please enter a valid email address.');
        return;
      }
      if (email.length > 254) {
        showMsg('contact-msg', 'error', 'Email address is too long.');
        return;
      }
      if (phone && phone.length > 20) {
        showMsg('contact-msg', 'error', 'Phone number is too long (max 20 characters).');
        return;
      }
      if (!message || message.length < 10) {
        showMsg('contact-msg', 'error', 'Please enter a message (at least 10 characters).');
        return;
      }
      if (message.length > 5000) {
        showMsg('contact-msg', 'error', 'Message is too long (max 5000 characters).');
        return;
      }
      if (/<script/i.test(name) || /<script/i.test(message) || /javascript:/i.test(message)) {
        showMsg('contact-msg', 'error', 'Invalid characters detected. Please remove any HTML or script tags.');
        return;
      }

      var btn = document.getElementById('contact-submit-btn');
      btn.disabled = true;
      btn.innerHTML = 'Sending <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('contact-msg');

      var payload = { name: name, email: email, message: message };
      if (phone) payload.phone = phone;

      fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to send message')); });
          return res.json();
        })
        .then(function() {
          btn.disabled = false;
          btn.textContent = 'Send Message';
          showMsg('contact-msg', 'success', 'Message sent successfully! We\'ll get back to you soon.');
          document.getElementById('contact-form').reset();
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Send Message';
          showMsg('contact-msg', 'error', err.message || 'Failed to send message. Please try again.');
        });
    }

    /* ===========================================================
       Inline Editing (Title / Slug) on Site Cards
       =========================================================== */
    var inlineSlugCheckTimer = null;
    var inlineSlugCheckCounter = 0; // monotonic counter to ignore stale responses

    /** Validate a slug string â€” returns { valid: boolean, reason?: string, normalized: string } */
    function validateSlugLocal(raw) {
      if (!raw || !raw.trim()) return { valid: false, reason: 'Slug is required', normalized: '' };
      var n = raw.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/--+/g, '-').replace(/^-|-$/g, '').slice(0, 100);
      if (!n || n.length < 3) return { valid: false, reason: 'At least 3 characters', normalized: n };
      if (!/^[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/.test(n)) return { valid: false, reason: 'Must start/end with letter or number', normalized: n };
      return { valid: true, normalized: n };
    }

    /** Validate a title string â€” returns { valid: boolean, reason?: string } */
    function validateTitle(raw) {
      if (!raw || !raw.trim()) return { valid: false, reason: 'Title is required' };
      var t = raw.trim();
      if (t.length < 1) return { valid: false, reason: 'Title is required' };
      if (t.length > 200) return { valid: false, reason: 'Max 200 characters' };
      if (/<script/i.test(t) || /javascript:/i.test(t)) return { valid: false, reason: 'Invalid characters' };
      return { valid: true };
    }

    /** Resolve slug-related element IDs based on context ('' = homepage card, 'dm' = domain modal) */
    function getSlugElId(type, siteId, ctx) {
      if (ctx === 'dm') {
        switch(type) {
          case 'url': return 'dm-slug-url';
          case 'wrap': return 'dm-slug-wrap';
          case 'input': return 'dm-input-slug';
          case 'save': return 'dm-save-slug';
          case 'edit': return 'dm-slug-edit';
        }
      }
      switch(type) {
        case 'url': return 'inline-slug-url-' + siteId;
        case 'wrap': return 'inline-slug-wrap-' + siteId;
        case 'input': return 'inline-input-slug-' + siteId;
        case 'save': return 'inline-save-slug-' + siteId;
        case 'edit': return 'inline-slug-' + siteId;
      }
    }

    function startInlineEdit(siteId, field, currentValue, ctx) {
      var isSlug = (field === 'slug');
      var ctxArg = ctx ? ", '" + ctx + "'" : '';

      if (isSlug) {
        // For slug: replace the URL line content with https://[input]-sites.megabyte.space
        var urlEl = document.getElementById(getSlugElId('url', siteId, ctx));
        if (!urlEl) return;
        urlEl.className = 'inline-slug-url status-default';
        urlEl.innerHTML = 'https://<input type="text" class="inline-input slug-input" id="' + getSlugElId('input', siteId, ctx) + '" value="' + escapeHtml(currentValue) + '" maxlength="100" />'
          + '<span class="inline-slug-actions">'
          + '<button class="inline-save-btn" id="' + getSlugElId('save', siteId, ctx) + '" onclick="saveInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(currentValue) + '\'' + ctxArg + ')" data-tooltip="Save" aria-label="Save"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></button>'
          + '<button class="inline-cancel-btn" onclick="cancelInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(currentValue) + '\'' + ctxArg + ')" data-tooltip="Cancel" aria-label="Cancel"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'
          + '</span>-sites.megabyte.space';
      } else {
        // For name: replace the wrap content with input + save/cancel in fixed action zone
        var wrap = document.getElementById('inline-name-' + siteId);
        if (!wrap) return;
        wrap.innerHTML = '<input type="text" class="inline-input" id="inline-input-name-' + siteId + '" value="' + escapeHtml(currentValue) + '" maxlength="200" />'
          + '<span class="inline-edit-actions">'
          + '<button class="inline-save-btn" id="inline-save-name-' + siteId + '" onclick="saveInlineEdit(\'' + escapeJsString(siteId) + '\', \'name\', \'' + escapeJsString(currentValue) + '\')" data-tooltip="Save" aria-label="Save"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></button>'
          + '<button class="inline-cancel-btn" onclick="cancelInlineEdit(\'' + escapeJsString(siteId) + '\', \'name\', \'' + escapeJsString(currentValue) + '\')" data-tooltip="Cancel" aria-label="Cancel"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'
          + '</span>';
      }

      var input = document.getElementById(isSlug ? getSlugElId('input', siteId, ctx) : ('inline-input-' + field + '-' + siteId));
      if (input) {
        input.focus();
        input.select();

        if (isSlug) {
          input.addEventListener('input', function() {
            onSlugInput(siteId, currentValue, ctx);
          });
          // Size input to content width using ch units (1ch = exact monospace char width)
          input.style.width = Math.max(3, currentValue.length) + 'ch';
          input.addEventListener('input', function() {
            this.style.width = Math.max(3, this.value.length) + 'ch';
          });
        } else {
          // Size name input to content width using ch (stay inline, don't stretch)
          input.style.width = Math.max(4, currentValue.length) + 'ch';
          input.addEventListener('input', function() {
            this.style.width = Math.max(4, this.value.length) + 'ch';
          });
        }

        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveInlineEdit(siteId, field, currentValue, ctx);
          } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelInlineEdit(siteId, field, currentValue, ctx);
          }
        });
      }
    }

    function showSaveToast(siteId, field, ctx) {
      var anchor = (field === 'slug')
        ? document.getElementById(getSlugElId('wrap', siteId, ctx))
        : document.getElementById('inline-name-' + siteId);
      if (!anchor) return;
      anchor.style.position = 'relative';
      var existing = anchor.querySelector('.copy-toast');
      if (existing) existing.remove();
      var toast = document.createElement('span');
      toast.className = 'copy-toast';
      toast.textContent = 'Saved!';
      anchor.appendChild(toast);
      setTimeout(function() { if (toast.parentNode) toast.remove(); }, 1500);
    }

    function showSlugHint(siteId, message, cls, ctx) {
      var wrap = document.getElementById(getSlugElId('wrap', siteId, ctx));
      if (!wrap) return;
      var existing = wrap.querySelector('.slug-hint');
      if (existing) existing.remove();
      var hint = document.createElement('span');
      hint.className = 'slug-hint ' + cls;
      hint.textContent = message;
      // Place hint next to hostname-chips (Primary/Default pills) for inline display
      var chips = wrap.querySelector('.hostname-chips');
      if (chips) {
        chips.appendChild(hint);
      } else {
        wrap.appendChild(hint);
      }
    }

    function clearSlugHint(siteId, ctx) {
      var wrap = document.getElementById(getSlugElId('wrap', siteId, ctx));
      if (!wrap) return;
      var existing = wrap.querySelector('.slug-hint') || (wrap.querySelector('.hostname-chips') && wrap.querySelector('.hostname-chips .slug-hint'));
      if (existing) existing.remove();
    }

    function onSlugInput(siteId, originalSlug, ctx) {
      var input = document.getElementById(getSlugElId('input', siteId, ctx));
      var urlEl = document.getElementById(getSlugElId('url', siteId, ctx));
      var saveBtn = document.getElementById(getSlugElId('save', siteId, ctx));
      if (!input || !urlEl) return;

      var raw = input.value;
      var result = validateSlugLocal(raw);

      if (!result.valid) {
        urlEl.className = 'inline-slug-url status-invalid';
        if (saveBtn) saveBtn.disabled = true;
        showSlugHint(siteId, result.reason || 'Invalid slug', 'hint-error', ctx);
        return;
      }

      var normalized = result.normalized;

      // If same as original, show default blue
      if (normalized === originalSlug) {
        urlEl.className = 'inline-slug-url status-default';
        if (saveBtn) saveBtn.disabled = false;
        clearSlugHint(siteId, ctx);
        return;
      }

      // Changed â€” check availability with debounce
      urlEl.className = 'inline-slug-url status-checking';
      if (saveBtn) saveBtn.disabled = true;
      showSlugHint(siteId, 'Checking availability\u2026', 'hint-checking', ctx);

      if (inlineSlugCheckTimer) clearTimeout(inlineSlugCheckTimer);
      inlineSlugCheckTimer = setTimeout(function() {
        checkSlugAvailability(siteId, normalized, originalSlug, ctx);
      }, 400);
    }

    function checkSlugAvailability(siteId, slug, originalSlug, ctx) {
      if (!state.session || !state.session.token) return;
      var urlEl = document.getElementById(getSlugElId('url', siteId, ctx));
      var saveBtn = document.getElementById(getSlugElId('save', siteId, ctx));

      var excludeId = siteId;
      var requestId = ++inlineSlugCheckCounter; // track this request

      fetch('/api/slug/check?slug=' + encodeURIComponent(slug) + '&exclude_id=' + encodeURIComponent(excludeId), {
        headers: { 'Authorization': 'Bearer ' + state.session.token }
      })
        .then(function(res) { return res.json(); })
        .then(function(d) {
          // Ignore stale responses (newer request already in flight)
          if (requestId !== inlineSlugCheckCounter) return;
          if (!urlEl) return;
          var input = document.getElementById(getSlugElId('input', siteId, ctx));
          if (!input) return;
          var currentNormalized = validateSlugLocal(input.value).normalized;
          if (currentNormalized !== slug) return;

          if (d.data && d.data.available) {
            urlEl.className = 'inline-slug-url status-available';
            if (saveBtn) saveBtn.disabled = false;
            showSlugHint(siteId, 'Available!', 'hint-available', ctx);
          } else {
            urlEl.className = 'inline-slug-url status-taken';
            if (saveBtn) saveBtn.disabled = true;
            showSlugHint(siteId, 'Already taken', 'hint-taken', ctx);
          }
        })
        .catch(function() {
          if (requestId !== inlineSlugCheckCounter) return;
          if (urlEl) {
            urlEl.className = 'inline-slug-url status-invalid';
          }
        });
    }

    function cancelInlineEdit(siteId, field, originalValue, ctx) {
      // Clear any pending slug check timer
      if (inlineSlugCheckTimer) { clearTimeout(inlineSlugCheckTimer); inlineSlugCheckTimer = null; }

      var isSlug = (field === 'slug');
      var ctxArg = ctx ? ", '" + ctx + "'" : '';
      if (isSlug) {
        clearSlugHint(siteId, ctx);
        // Restore the combined URL line with edit icon in fixed action zone
        var urlEl = document.getElementById(getSlugElId('url', siteId, ctx));
        if (urlEl) {
          urlEl.className = 'inline-slug-url status-default';
          urlEl.innerHTML = 'https://<span class="inline-edit-wrap inline-edit-inline" id="' + getSlugElId('edit', siteId, ctx) + '"><span class="inline-text slug-editable" tabindex="0" role="button" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\'' + ctxArg + ')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\'' + ctxArg + ')}">' + escapeHtml(originalValue) + '</span></span><span class="inline-slug-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\'' + ctxArg + ')" data-tooltip="Edit URL slug" aria-label="Edit URL slug" aria-label="Edit URL slug"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span>-sites.megabyte.space';
        }
        // If editing from domain modal, also refresh homepage card slug display
        if (ctx === 'dm') {
          var homeUrlEl = document.getElementById('inline-slug-url-' + siteId);
          if (homeUrlEl) {
            homeUrlEl.className = 'inline-slug-url status-default';
            homeUrlEl.innerHTML = 'https://<span class="inline-edit-wrap inline-edit-inline" id="inline-slug-' + siteId + '"><span class="inline-text slug-editable" tabindex="0" role="button" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\')}">' + escapeHtml(originalValue) + '</span></span><span class="inline-slug-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'slug\', \'' + escapeJsString(originalValue) + '\')" data-tooltip="Edit URL slug" aria-label="Edit URL slug" aria-label="Edit URL slug"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span>-sites.megabyte.space';
          }
        }
      } else {
        var wrap = document.getElementById('inline-name-' + siteId);
        if (!wrap) return;
        wrap.innerHTML = '<span class="inline-text site-card-name" tabindex="0" role="button" title="' + escapeHtml(originalValue) + '" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'name\', \'' + escapeJsString(originalValue) + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();startInlineEdit(\'' + escapeJsString(siteId) + '\', \'name\', \'' + escapeJsString(originalValue) + '\')}" style="cursor:pointer;">' + escapeHtml(originalValue) + '</span>'
          + '<span class="inline-edit-actions"><button class="inline-edit-btn" onclick="startInlineEdit(\'' + escapeJsString(siteId) + '\', \'name\', \'' + escapeJsString(originalValue) + '\')" data-tooltip="Edit title" aria-label="Edit title"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button></span>';
      }
    }

    var _slugSaving = {}; // Per-site slug save lock
    function saveInlineEdit(siteId, field, originalValue, ctx) {
      if (!state.session || !state.session.token) return;

      var isSlug = (field === 'slug');
      // Prevent concurrent slug saves
      if (isSlug && _slugSaving[siteId]) {
        showToast('Slug change in progress\u2026 please wait.', 'info');
        return;
      }
      var input = document.getElementById(isSlug ? getSlugElId('input', siteId, ctx) : ('inline-input-' + field + '-' + siteId));
      if (!input) return;

      var value = input.value.trim();

      // Validate
      if (isSlug) {
        var slugResult = validateSlugLocal(value);
        if (!slugResult.valid) {
          var slugUrlEl = document.getElementById(getSlugElId('url', siteId, ctx));
          if (slugUrlEl) { slugUrlEl.className = 'inline-slug-url status-invalid'; }
          return;
        }
        value = slugResult.normalized;
        if (value === originalValue) {
          cancelInlineEdit(siteId, field, originalValue, ctx);
          return;
        }
      } else {
        var titleResult = validateTitle(value);
        if (!titleResult.valid) {
          input.style.borderColor = '#ef4444';
          input.title = titleResult.reason;
          return;
        }
        if (value === originalValue) {
          cancelInlineEdit(siteId, field, originalValue);
          return;
        }
      }

      // Show saving feedback
      var saveBtn = document.getElementById(isSlug ? getSlugElId('save', siteId, ctx) : ('inline-save-' + field + '-' + siteId));
      if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = '<span style="font-size:10px;">...</span>'; }
      input.disabled = true;
      input.style.opacity = '0.6';
      if (isSlug) _slugSaving[siteId] = true;

      var payload = {};
      if (isSlug) {
        payload.slug = value;
      } else {
        payload.business_name = value;
      }

      fetch('/api/sites/' + siteId, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + state.session.token
        },
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to update')); });
          return res.json();
        })
        .then(function() {
          // Update the adminSites data locally
          for (var i = 0; i < adminSites.length; i++) {
            if (adminSites[i].id === siteId) {
              if (isSlug) {
                adminSites[i].slug = value;
                // Also update domain modal slug reference
                if (adminDomainModalSiteId === siteId) adminDomainModalSlug = value;
              } else {
                adminSites[i].business_name = value;
              }
              break;
            }
          }
          // Targeted update â€” restore display mode with new value (no full re-render)
          cancelInlineEdit(siteId, field, value, ctx);
          // Show save success toast
          showSaveToast(siteId, isSlug ? 'slug' : 'name', ctx);
          // Update site card preview URL if slug changed
          if (isSlug) {
            var previewLink = document.querySelector('#site-card-' + siteId + ' .site-card-preview a');
            if (previewLink) previewLink.href = 'https://' + value + '-sites.megabyte.space';
            var visitBtn = document.querySelector('#site-card-' + siteId + ' .btn-visit');
            if (visitBtn) visitBtn.setAttribute('onclick', "window.open('https://" + escapeJsString(value) + "-sites.megabyte.space','_blank')");
            // Re-render domain modal hostnames if open (reflects new slug everywhere)
            if (adminDomainModalSiteId === siteId) {
              loadHostnames(siteId);
            }
            // Update copy/open buttons on homepage card
            var wrapRow = document.getElementById('inline-slug-wrap-' + siteId);
            if (wrapRow) {
              var copyBtns = wrapRow.querySelectorAll('.site-card-copy-btn');
              if (copyBtns.length >= 1) copyBtns[0].setAttribute('onclick', "copyUrl('https://" + escapeJsString(value) + "-sites.megabyte.space', this)");
              if (copyBtns.length >= 2) copyBtns[1].setAttribute('onclick', "window.open('https://" + escapeJsString(value) + "-sites.megabyte.space', '_blank')");
            }
            delete _slugSaving[siteId];
          }
        })
        .catch(function(err) {
          if (isSlug) delete _slugSaving[siteId];
          if (input) { input.disabled = false; input.style.opacity = '1'; }
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
          }
          if (isSlug) {
            var urlEl = document.getElementById(getSlugElId('url', siteId, ctx));
            if (urlEl) {
              urlEl.className = 'inline-slug-url status-taken';
            }
          } else {
            input.style.borderColor = '#ef4444';
            input.title = err.message || 'Failed to save';
          }
        });
    }

    /* ===========================================================
       Site Logs Modal
       =========================================================== */
    var siteLogsModalId = null;
    var _logsAutoRefreshTimer = null;

    function openSiteLogsModal(siteId, siteName) {
      siteLogsModalId = siteId;
      trackEvent('logs_modal_opened', { site_id: siteId });
      var nameEl = document.getElementById('logs-modal-site-name');
      if (nameEl) nameEl.textContent = siteName || siteId;
      document.getElementById('site-logs-modal').classList.add('visible');
      fetchSiteLogs(siteId);
      document.body.style.overflow = 'hidden';
      // Auto-refresh every 5s while modal is open (catches new workflow logs)
      clearInterval(_logsAutoRefreshTimer);
      _logsAutoRefreshTimer = setInterval(function() {
        if (siteLogsModalId) fetchSiteLogs(siteLogsModalId);
      }, 5000);
      // Start real-time timestamp updater (every 10s)
      startTimestampUpdater();
    }

    function closeSiteLogsModal() {
      document.getElementById('site-logs-modal').classList.remove('visible');
      siteLogsModalId = null;
      document.body.style.overflow = '';
      clearInterval(_logsAutoRefreshTimer);
      _logsAutoRefreshTimer = null;
      clearInterval(_timestampTimer);
      _timestampTimer = null;
    }

    function refreshSiteLogs() {
      if (siteLogsModalId) fetchSiteLogs(siteLogsModalId);
    }

    var _rawLogsData = [];

    function copyLogsForAI() {
      if (!_rawLogsData || _rawLogsData.length === 0) {
        showToast('No logs to copy', 'warn');
        return;
      }
      var siteName = document.getElementById('logs-modal-site-name').textContent || 'unknown';
      var lines = [];
      lines.push('# Site Logs: ' + siteName);
      lines.push('Exported: ' + new Date().toISOString());
      lines.push('Total entries: ' + _rawLogsData.length);
      lines.push('');
      lines.push('| # | Timestamp (UTC) | Action | Label | Message | Metadata |');
      lines.push('|---|----------------|--------|-------|---------|----------|');
      for (var i = 0; i < _rawLogsData.length; i++) {
        var log = _rawLogsData[i];
        var action = log.action || 'unknown';
        var label = formatActionLabel(action);
        var meta = {};
        try { meta = typeof log.metadata_json === 'string' ? JSON.parse(log.metadata_json) : (log.metadata_json || {}); } catch(e) {}
        var msg = meta.message || '';
        var metaStr = '';
        var metaKeys = Object.keys(meta).filter(function(k) { return k !== 'message'; });
        metaStr = metaKeys.map(function(k) { return k + '=' + JSON.stringify(meta[k]); }).join(', ');
        lines.push('| ' + (i + 1) + ' | ' + (log.created_at || '') + ' | `' + action + '` | ' + label + ' | ' + msg.replace(/\|/g, '/') + ' | ' + metaStr.replace(/\|/g, '/').substring(0, 200) + ' |');
      }
      lines.push('');
      lines.push('## Raw JSON');
      lines.push('```json');
      lines.push(JSON.stringify(_rawLogsData.map(function(l) {
        var m = {};
        try { m = typeof l.metadata_json === 'string' ? JSON.parse(l.metadata_json) : (l.metadata_json || {}); } catch(e) {}
        return { time: l.created_at, action: l.action, label: formatActionLabel(l.action || ''), metadata: m };
      }), null, 2));
      lines.push('```');

      var text = lines.join('\n');
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          showToast('Logs copied to clipboard (' + _rawLogsData.length + ' entries)', 'ok');
        }).catch(function() {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('Logs copied to clipboard', 'ok');
    }

    var _lastLogIds = [];
    var _logsInitialLoad = true;

    function renderLogEntry(log) {
      var ts = log.created_at ? formatLogTimestamp(log.created_at) : 'â€”';
      var action = log.action || 'unknown';
      var actionLabel = formatActionLabel(action);
      var meta = formatLogMeta(log.metadata_json, action);
      var colorClass = getLogColorClass(action);
      var iconSvg = getLogIcon(action);
      var html = '<div class="log-entry ' + colorClass + '" data-log-id="' + escapeAttr(log.id || '') + '">';
      html += '<div class="log-edge"></div>';
      html += '<div class="log-icon">' + iconSvg + '</div>';
      html += '<div class="log-body">';
      html += '<div class="log-header"><span class="log-action">' + escapeHtml(actionLabel) + '</span><span class="log-ts" data-iso="' + escapeAttr(log.created_at || '') + '">' + escapeHtml(ts) + '</span></div>';
      if (meta) html += '<div class="log-meta">' + meta + '</div>';
      html += '</div>';
      html += '</div>';
      return html;
    }

    function fetchSiteLogs(siteId) {
      var container = document.getElementById('logs-container');
      var countLabel = document.getElementById('logs-count-label');

      // Only show loading on first load (not on polls)
      if (_logsInitialLoad) {
        container.innerHTML = '<div class="logs-empty">Loading logs...</div>';
        if (countLabel) countLabel.textContent = '';
      }

      if (!state.session || !state.session.token) {
        container.innerHTML = '<div class="logs-empty">Sign in to view logs.</div>';
        return;
      }

      fetch('/api/sites/' + encodeURIComponent(siteId) + '/logs?limit=200', {
        headers: { 'Authorization': 'Bearer ' + state.session.token }
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to load logs')); });
          return res.json();
        })
        .then(function(d) {
          var logs = d.data || [];
          _rawLogsData = logs;
          if (countLabel) countLabel.textContent = logs.length + ' log entr' + (logs.length === 1 ? 'y' : 'ies');
          if (!logs.length) {
            container.innerHTML = '<div class="logs-empty">No logs yet for this site.</div>';
            _lastLogIds = [];
            _logsInitialLoad = false;
            return;
          }

          // Build new ID list (logs come newest-first)
          var newIds = logs.map(function(l) { return l.id || l.created_at; });

          // If same count and same first + last IDs, only update timestamps
          if (!_logsInitialLoad && newIds.length === _lastLogIds.length && newIds[0] === _lastLogIds[0]) {
            // Just update relative timestamps without full re-render
            var entries = container.querySelectorAll('.log-entry');
            for (var t = 0; t < entries.length && t < logs.length; t++) {
              var tsEl = entries[t].querySelector('.log-ts');
              if (tsEl && logs[t].created_at) {
                tsEl.textContent = formatLogTimestamp(logs[t].created_at);
              }
            }
            _logsInitialLoad = false;
            return;
          }

          // New logs arrived â€” find which are new and prepend them
          if (!_logsInitialLoad && _lastLogIds.length > 0) {
            var existingSet = {};
            for (var e = 0; e < _lastLogIds.length; e++) existingSet[_lastLogIds[e]] = true;
            var newEntries = [];
            for (var n = 0; n < logs.length; n++) {
              var lid = logs[n].id || logs[n].created_at;
              if (!existingSet[lid]) newEntries.push(logs[n]);
            }
            if (newEntries.length > 0) {
              // Prepend new entries at the top
              var frag = '';
              for (var p = 0; p < newEntries.length; p++) {
                frag += renderLogEntry(newEntries[p]);
              }
              container.insertAdjacentHTML('afterbegin', frag);
              // Also update existing timestamps
              var allEntries = container.querySelectorAll('.log-entry');
              for (var u = newEntries.length; u < allEntries.length && (u - newEntries.length) < logs.length; u++) {
                var uTsEl = allEntries[u].querySelector('.log-ts');
                if (uTsEl && logs[u].created_at) {
                  uTsEl.textContent = formatLogTimestamp(logs[u].created_at);
                }
              }
            }
          } else {
            // Initial load or reset â€” full render
            var html = '';
            for (var i = 0; i < logs.length; i++) {
              html += renderLogEntry(logs[i]);
            }
            container.innerHTML = html;
          }

          _lastLogIds = newIds;
          _logsInitialLoad = false;
        })
        .catch(function(err) {
          if (_logsInitialLoad) {
            container.innerHTML = '<div class="logs-empty" style="color:var(--error);">' + escapeHtml(err.message) + '</div>';
          }
          _logsInitialLoad = false;
        });
    }

    function formatLogTimestamp(iso) {
      try {
        // D1 stores dates as "YYYY-MM-DD HH:MM:SS" without timezone â€” treat as UTC
        var normalized = iso;
        if (iso && iso.indexOf('T') === -1 && iso.indexOf('Z') === -1) {
          normalized = iso.replace(' ', 'T') + 'Z';
        } else if (iso && iso.indexOf('Z') === -1 && iso.indexOf('+') === -1) {
          normalized = iso + 'Z';
        }
        var d = new Date(normalized);
        var now = new Date();
        var diff = now - d;
        var secs = Math.floor(diff / 1000);
        var mins = Math.floor(secs / 60);
        var hrs = Math.floor(mins / 60);
        var days = Math.floor(hrs / 24);
        var weeks = Math.floor(days / 7);
        var months = Math.floor(days / 30);
        var years = Math.floor(days / 365);
        if (isNaN(secs) || secs < 0) return iso;
        if (secs < 10) return 'just now';
        if (secs < 45) return secs + 's ago';
        if (secs < 90) return '1 min ago';
        if (mins < 45) return mins + ' min ago';
        if (mins < 90) return '1 hr ago';
        if (hrs < 24) return hrs + ' hr ago';
        if (hrs < 42) return '1 day ago';
        if (days < 7) return days + ' days ago';
        if (days < 11) return '1 week ago';
        if (weeks < 4) return weeks + ' weeks ago';
        if (days < 45) return '1 month ago';
        if (months < 12) return months + ' months ago';
        if (months < 18) return '1 year ago';
        return years + ' years ago';
      } catch (e) { return iso; }
    }

    // Continuous timestamp updater â€” updates every 10s for all visible log entries
    var _timestampTimer = null;
    function startTimestampUpdater() {
      if (_timestampTimer) clearInterval(_timestampTimer);
      _timestampTimer = setInterval(function() {
        var entries = document.querySelectorAll('#logs-container .log-entry');
        entries.forEach(function(entry) {
          var tsEl = entry.querySelector('.log-ts');
          if (tsEl && tsEl.dataset.iso) {
            tsEl.textContent = formatLogTimestamp(tsEl.dataset.iso);
          }
        });
      }, 10000);
    }

    function getLogColorClass(action) {
      if (action.includes('created') || action.includes('verified') || action.includes('completed') || action.includes('published') || action.includes('complete')) return 'log-c-green';
      if (action.includes('deleted') || action.includes('failed') || action.includes('error') || action.includes('canceled')) return 'log-c-red';
      if (action.includes('reset') || action.includes('queued') || action.includes('warning') || action.includes('migration')) return 'log-c-amber';
      if (action.includes('generation') || action.includes('deployed') || action.includes('upload') || action.includes('checkout') || action.includes('billing')) return 'log-c-purple';
      if (action.includes('research') || action.includes('auth') || action.includes('hostname') || action.includes('dns') || action.includes('domain') || action.includes('notification')) return 'log-c-cyan';
      if (action.includes('updated') || action.includes('changed') || action.includes('renamed') || action.includes('cache') || action.includes('file')) return 'log-c-blue';
      if (action.includes('webhook') || action.includes('contact')) return 'log-c-muted';
      return 'log-c-muted';
    }

    function getLogIcon(action) {
      var s = 'width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      if (action.includes('created')) return '<svg ' + s + '><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';
      if (action.includes('deleted')) return '<svg ' + s + '><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      if (action.includes('reset')) return '<svg ' + s + '><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>';
      if (action.includes('generation') || action.includes('html')) return '<svg ' + s + '><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';
      if (action.includes('research') || action.includes('profile')) return '<svg ' + s + '><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
      if (action.includes('upload') || action.includes('deploy')) return '<svg ' + s + '><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>';
      if (action.includes('auth')) return '<svg ' + s + '><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
      if (action.includes('hostname') || action.includes('dns') || action.includes('domain')) return '<svg ' + s + '><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>';
      if (action.includes('slug') || action.includes('renamed') || action.includes('changed')) return '<svg ' + s + '><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>';
      if (action.includes('billing') || action.includes('checkout') || action.includes('payment') || action.includes('subscription')) return '<svg ' + s + '><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>';
      if (action.includes('notification')) return '<svg ' + s + '><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3z"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
      if (action.includes('file')) return '<svg ' + s + '><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
      if (action.includes('cache') || action.includes('migration')) return '<svg ' + s + '><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>';
      if (action.includes('workflow') || action.includes('step')) return '<svg ' + s + '><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
      if (action.includes('contact')) return '<svg ' + s + '><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22 6 12 13 2 6"/></svg>';
      return '<svg ' + s + '><circle cx="12" cy="12" r="3"/></svg>';
    }

    function formatActionLabel(action) {
      var map = {
        'site.created': 'Site Created',
        'site.created_from_search': 'Site Created',
        'site.deleted': 'Site Deleted',
        'site.updated': 'Site Updated',
        'site.reset': 'Site Reset',
        'site.deployed': 'Site Deployed',
        'site.deploy_started': 'Deploy Started',
        'site.slug_changed': 'URL Changed',
        'site.name_changed': 'Name Changed',
        'file.updated': 'File Saved',
        'hostname.provisioned': 'Domain Added',
        'hostname.unsubscribed': 'Domain Removed',
        'hostname.verified': 'Domain Verified',
        'hostname.deprovisioned': 'Domain Removed',
        'hostname.deleted': 'Domain Deleted',
        'hostname.set_primary': 'Primary Domain Set',
        'workflow.queued': 'Build Queued',
        'workflow.started': 'Build Started',
        'workflow.phase.research': 'Research Phase',
        'workflow.phase.generation': 'Generation Phase',
        'workflow.phase.deployment': 'Deployment Phase',
        'workflow.status_update': 'Status Update',
        'workflow.step.started': 'Step Started',
        'workflow.step.complete': 'Step Complete',
        'workflow.step.profile_research_started': 'Researching Business',
        'workflow.step.profile_research_complete': 'Profile Research Done',
        'workflow.step.parallel_research_started': 'Researching Details',
        'workflow.step.parallel_research_complete': 'Research Complete',
        'workflow.step.html_generation_started': 'Generating Website',
        'workflow.step.html_generation_complete': 'Website Generated',
        'workflow.step.legal_scoring_started': 'Creating Legal Pages',
        'workflow.step.legal_and_scoring_complete': 'Legal Pages Ready',
        'workflow.step.upload_started': 'Uploading Files',
        'workflow.step.upload_to_r2_complete': 'Files Uploaded',
        'workflow.step.publishing_started': 'Publishing Site',
        'workflow.step.failed': 'Step Failed',
        'workflow.completed': 'Build Completed',
        'workflow.failed': 'Build Failed',
        'auth.magic_link_requested': 'Sign-In Link Sent',
        'auth.magic_link_verified': 'Signed In (Email)',
        'auth.google_oauth_started': 'Google Sign-In Started',
        'auth.google_oauth_verified': 'Signed In (Google)',
        'billing.checkout_created': 'Checkout Started',
        'billing.portal_opened': 'Billing Portal Opened',
        'contact.form_submitted': 'Contact Form Sent',
        'domain.purchase_initiated': 'Domain Purchase Started',
        'site.published_from_bolt': 'Published from Bolt',
        'site.r2_migration_started': 'File Migration Started',
        'site.r2_migration_complete': 'File Migration Complete',
        'site.r2_migration_failed': 'File Migration Failed',
        'site.cache_invalidated': 'Cache Cleared',
        'file.deleted': 'File Deleted',
        'file.created': 'File Created',
        'hostname.reset_primary': 'Primary Domain Reset',
        'notification.domain_verified_sent': 'Domain Notification Sent',
        'notification.build_complete_sent': 'Build Notification Sent',
        'notification.email_failed': 'Email Notification Failed',
        'webhook.processing_failed': 'Webhook Processing Failed',
        'workflow.retry_created': 'Workflow Retried',
        'workflow.creation_failed': 'Workflow Failed to Start',
        'workflow.debug.llm_output': 'AI Response Received',
        'workflow.debug.json_extraction_failed': 'JSON Parse Failed',
        'workflow.debug.validation_failed': 'Schema Validation Failed',
        'workflow.debug.score_text_fallback': 'Score Parsed from Text',
        'workflow.debug.score_fallback': 'Score Defaulted',
        'webhook.stripe.checkout.session.completed': 'Payment Received',
        'webhook.stripe.customer.subscription.updated': 'Subscription Updated',
        'webhook.stripe.customer.subscription.deleted': 'Subscription Canceled',
        'webhook.stripe.invoice.payment_failed': 'Payment Failed',
        'webhook.stripe.charge.refunded': 'Payment Refunded',
        'webhook.stripe.invoice.paid': 'Invoice Paid'
      };
      return map[action] || action.replace(/\./g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    }

    function formatLogMeta(metaJson, action) {
      if (!metaJson) return '';
      var meta;
      try {
        meta = typeof metaJson === 'string' ? JSON.parse(metaJson) : metaJson;
      } catch (e) { return ''; }
      var parts = [];

      // Show the human-readable message first (most important)
      if (meta.message) {
        parts.push(escapeHtml(meta.message));
      }

      // Timing info
      if (meta.elapsed_ms) {
        parts.push('<span style="color:var(--accent);font-size:0.72rem;">' + (meta.elapsed_ms / 1000).toFixed(1) + 's</span>');
      }
      if (meta.total_seconds) {
        parts.push('<span style="color:var(--accent);font-size:0.72rem;">total: ' + meta.total_seconds + 's</span>');
      }

      // Structured data fields
      if (meta.step && !meta.message) parts.push('step: <code>' + escapeHtml(meta.step) + '</code>');
      if (meta.slug && !meta.message) parts.push('slug: <code>' + escapeHtml(meta.slug) + '</code>');
      if (meta.hostname) parts.push('domain: <code>' + escapeHtml(meta.hostname) + '</code>');
      if (meta.old_slug && meta.new_slug) parts.push('slug: <code>' + escapeHtml(meta.old_slug) + '</code> &rarr; <code>' + escapeHtml(meta.new_slug) + '</code>');
      if (meta.old_name && meta.new_name) parts.push('name: ' + escapeHtml(meta.old_name) + ' &rarr; ' + escapeHtml(meta.new_name));
      if (meta.version && !meta.message) parts.push('v' + escapeHtml(meta.version));
      if (meta.business_name && !meta.message) parts.push(escapeHtml(meta.business_name));
      if (meta.quality_score !== undefined && !meta.message) parts.push('quality: ' + escapeHtml(String(meta.quality_score)) + '/100');
      if (meta.html_size_kb && !meta.message) parts.push(escapeHtml(String(meta.html_size_kb)) + ' KB');
      if (meta.services_count !== undefined && !meta.message) parts.push(escapeHtml(String(meta.services_count)) + ' services');
      if (meta.file_count && !meta.message) parts.push(meta.file_count + ' files');
      if (meta.url && !meta.message) parts.push('<code>' + escapeHtml(meta.url) + '</code>');
      if (meta.workflow_instance_id) parts.push('wf: ' + escapeHtml(meta.workflow_instance_id.substring(0, 8)));
      // Show ZodError field-level details if available
      if (meta.zod_details) {
        parts.push('<span style="color:var(--error);font-size:0.72rem;">Fields: ' + escapeHtml(String(meta.zod_details).slice(0, 200)) + '</span>');
      }
      if (meta.error) {
        var errStr = String(meta.error);
        if (meta.zod_details) {
          errStr = 'Validation error';
        } else if (errStr.indexOf('ZodError') !== -1 || errStr.indexOf('Validation') !== -1) {
          errStr = 'Validation error';
        } else if (errStr.length > 120) {
          errStr = errStr.slice(0, 120) + 'â€¦';
        }
        parts.push('<span style="color:var(--error);">' + escapeHtml(errStr) + '</span>');
      }
      // Show retry info
      if (meta.first_error && !meta.error) {
        parts.push('<span style="color:var(--text-secondary);font-size:0.72rem;">prev: ' + escapeHtml(String(meta.first_error).slice(0, 80)) + '</span>');
      }
      return parts.join(' &middot; ');
    }

    /* ===========================================================
       Reset Modal (Re-crawl & Rebuild)
       =========================================================== */

    function openResetModal(siteId, name, address, placeId, context) {
      resetSiteId = siteId;

      // Pre-populate the details modal with existing data
      state.mode = name ? 'business' : 'custom';

      if (name && placeId) {
        state.selectedBusiness = { name: name, address: address || '', place_id: placeId };
      } else if (name) {
        state.selectedBusiness = null;
        state.mode = 'custom';
      }

      // Pre-populate manual fields
      var nameInput = document.getElementById('business-name-input');
      var addrInput = document.getElementById('business-address-input');
      if (nameInput) nameInput.value = name || '';
      if (addrInput) addrInput.value = address || '';

      var textarea = document.getElementById('details-textarea');
      if (textarea) {
        if (context) {
          textarea.value = context;
        } else {
          // Restore from localStorage if no context from server
          try { var saved = localStorage.getItem('ps_business_context'); if (saved) textarea.value = saved; } catch(e) { /* private browsing */ }
        }
      }

      // Update the details modal title and button
      updateDetailsScreen();
      var titleEl = document.getElementById('details-title');
      if (titleEl) titleEl.textContent = 'Reset & Rebuild Website';
      var subtitleEl = document.getElementById('details-subtitle');
      if (subtitleEl) subtitleEl.textContent = 'Review and update the business information. The current site files will be replaced with a fresh build.';
      var buildBtn = document.getElementById('build-btn');
      if (buildBtn) buildBtn.textContent = 'Reset & Rebuild';

      openDetailsModal();
    }

    // Override submitBuild to handle reset mode
    var origSubmitBuild = submitBuild;
    submitBuild = function() {
      if (resetSiteId) {
        submitReset();
        return;
      }
      origSubmitBuild();
    };

    function submitReset() {
      if (!state.session || !state.session.token || !resetSiteId) return;

      var rawContext = document.getElementById('details-textarea').value.trim();
      try { localStorage.setItem('ps_business_context', rawContext); } catch(e) { /* private browsing */ }
      var additionalContext = rawContext.replace(/<[^>]*>/g, '').slice(0, 5000);
      var btn = document.getElementById('build-btn');

      btn.disabled = true;
      btn.innerHTML = 'Resetting <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('build-msg');

      var payload = { additional_context: additionalContext };

      if (state.selectedBusiness) {
        payload.business = {
          name: state.selectedBusiness.name || state.selectedBusiness.business_name,
          address: state.selectedBusiness.address || state.selectedBusiness.formatted_address || '',
          place_id: state.selectedBusiness.place_id || ''
        };
      } else {
        var manualName = document.getElementById('business-name-input').value.trim();
        var manualAddr = document.getElementById('business-address-input').value.trim();
        if (!manualName) {
          showMsg('build-msg', 'error', 'Please enter your business name.');
          btn.disabled = false;
          btn.textContent = 'Reset & Rebuild';
          return;
        }
        payload.business = { name: manualName, address: manualAddr };
      }

      fetch('/api/sites/' + resetSiteId + '/reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + state.session.token
        },
        body: JSON.stringify(payload)
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to reset')); });
          return res.json();
        })
        .then(function(resp) {
          btn.disabled = false;
          btn.textContent = 'Reset & Rebuild';
          var data = resp.data || resp;
          var rSiteId = data.site_id || data.id || resetSiteId;
          var rSiteName = payload.business ? payload.business.name : '';
          state.siteId = rSiteId;
          state.slug = data.slug || '';
          resetSiteId = null;
          closeDetailsModal();
          showToast('Reset triggered â€” rebuilding site...', 'success');
          navigateTo('waiting');
          loadAdminDashboard();
          // Auto-open Logs after a short delay so the user can see the reset logs
          setTimeout(function() { openSiteLogsModal(rSiteId, rSiteName); }, 1500);
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Reset & Rebuild';
          showMsg('build-msg', 'error', err.message || 'Failed to reset site.');
        });
    }

    /* ===========================================================
       Deploy Modal (ZIP / JSON Upload)
       =========================================================== */
    var deploySiteId = null;
    var deployZipFile = null;
    var deployJsonFile = null;

    function openDeployModal(siteId, siteName) {
      deploySiteId = siteId;
      deployZipFile = null;
      deployJsonFile = null;
      document.getElementById('deploy-modal-title').textContent = 'Deploy: ' + siteName;
      document.getElementById('deploy-zip-name').style.display = 'none';
      document.getElementById('deploy-json-name').style.display = 'none';
      document.getElementById('deploy-zip-zone').classList.remove('has-file');
      document.getElementById('deploy-json-zone').classList.remove('has-file');
      document.getElementById('deploy-zip-input').value = '';
      document.getElementById('deploy-json-input').value = '';
      document.getElementById('deploy-dist-path').value = 'dist/';
      document.getElementById('deploy-file-manager').classList.remove('visible');
      document.getElementById('deploy-folder-list').innerHTML = '';
      document.getElementById('deploy-selected-info').style.display = 'none';
      hideMsg('deploy-msg');
      document.getElementById('deploy-modal').classList.add('visible');
    }

    function closeDeployModal() {
      document.getElementById('deploy-modal').classList.remove('visible');
      deploySiteId = null;
      // Reset validation state
      hideMsg('deploy-msg');
      var zipZone = document.getElementById('deploy-zip-zone');
      if (zipZone) zipZone.classList.remove('has-file');
      var zipName = document.getElementById('deploy-zip-name');
      if (zipName) { zipName.textContent = ''; zipName.style.display = 'none'; }
      var jsonName = document.getElementById('deploy-json-name');
      if (jsonName) { jsonName.textContent = ''; jsonName.style.display = 'none'; }
      deployZipFile = null;
      deployJsonFile = null;
    }

    function handleDeployZipSelect(input) {
      if (input.files && input.files[0]) {
        deployZipFile = input.files[0];
        var nameEl = document.getElementById('deploy-zip-name');
        nameEl.textContent = deployZipFile.name + ' (' + (deployZipFile.size / 1024 / 1024).toFixed(2) + ' MB)';
        nameEl.style.display = 'block';
        document.getElementById('deploy-zip-zone').classList.add('has-file');
        hideMsg('deploy-msg');

        // Parse ZIP and show file manager
        parseZipFolders(deployZipFile);
      }
    }

    function parseZipFolders(file) {
      var fm = document.getElementById('deploy-file-manager');
      var listEl = document.getElementById('deploy-folder-list');
      var countEl = document.getElementById('deploy-folder-count');

      if (typeof JSZip === 'undefined') {
        // Fallback: if JSZip not loaded, default to dist/
        selectDeployFolder('dist/');
        return;
      }

      listEl.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.78rem;">Scanning ZIP contents...</div>';
      fm.classList.add('visible');

      JSZip.loadAsync(file).then(function(zip) {
        // Collect all unique top-level directories and the root
        var folders = {};
        var rootFileCount = 0;
        var totalFiles = 0;

        zip.forEach(function(relativePath) {
          totalFiles++;
          var parts = relativePath.split('/');

          if (parts.length === 1 || (parts.length === 2 && parts[1] === '')) {
            // Root-level file or root directory entry
            if (parts[0] && !relativePath.endsWith('/')) {
              rootFileCount++;
            }
          }

          // Track all directories
          if (parts.length >= 2 && parts[0]) {
            var dirName = parts[0] + '/';
            if (!folders[dirName]) {
              folders[dirName] = { name: dirName, count: 0 };
            }
            if (!relativePath.endsWith('/')) {
              folders[dirName].count++;
            }
          }
        });

        // Build folder list: root first, then sorted folders
        var folderList = [];

        // Add root option
        folderList.push({ name: './', label: '/ (root)', count: rootFileCount });

        // Add each folder sorted alphabetically
        var sortedFolders = Object.keys(folders).sort();
        for (var i = 0; i < sortedFolders.length; i++) {
          var f = folders[sortedFolders[i]];
          folderList.push({ name: f.name, label: f.name, count: f.count });
        }

        countEl.textContent = totalFiles + ' files';

        // Render
        var html = '';
        for (var j = 0; j < folderList.length; j++) {
          var item = folderList[j];
          var isRoot = item.name === './';
          var iconSvg = isRoot
            ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>'
            : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';

          html += '<div class="deploy-folder-item" data-path="' + escapeHtml(item.name) + '" onclick="selectDeployFolder(\'' + escapeAttr(item.name) + '\')">';
          html += '<span class="deploy-folder-icon">' + iconSvg + '</span>';
          html += '<span class="deploy-folder-name">' + escapeHtml(item.label) + '</span>';
          html += '<span class="deploy-folder-count">' + item.count + ' file' + (item.count !== 1 ? 's' : '') + '</span>';
          html += '</div>';
        }

        listEl.innerHTML = html;

        // Auto-select the best folder
        var autoSelected = './';
        var assetFolders = ['dist/', 'build/', 'out/', 'public/', 'output/'];
        for (var k = 0; k < assetFolders.length; k++) {
          if (folders[assetFolders[k]]) {
            autoSelected = assetFolders[k];
            break;
          }
        }

        selectDeployFolder(autoSelected);
      }).catch(function() {
        listEl.innerHTML = '<div style="padding:12px;color:var(--error);font-size:0.78rem;">Could not read ZIP file. Defaulting to dist/.</div>';
        selectDeployFolder('dist/');
      });
    }

    function selectDeployFolder(folderPath) {
      document.getElementById('deploy-dist-path').value = folderPath === './' ? '' : folderPath;

      // Update visual selection
      var items = document.querySelectorAll('.deploy-folder-item');
      for (var i = 0; i < items.length; i++) {
        if (items[i].getAttribute('data-path') === folderPath) {
          items[i].classList.add('selected');
        } else {
          items[i].classList.remove('selected');
        }
      }

      // Show selected path info
      var infoEl = document.getElementById('deploy-selected-info');
      var folderEl = document.getElementById('deploy-selected-folder');
      infoEl.style.display = 'block';
      folderEl.textContent = folderPath === './' ? '/ (root)' : folderPath;

      // Check if selected folder has index.html
      checkFolderForIndex(folderPath);
    }

    function checkFolderForIndex(folderPath) {
      if (!deployZipFile || typeof JSZip === 'undefined') return;
      var warnEl = document.getElementById('deploy-index-warning');
      JSZip.loadAsync(deployZipFile).then(function(zip) {
        var prefix = folderPath === './' ? '' : folderPath;
        var hasIndex = !!zip.file(prefix + 'index.html');
        if (warnEl) {
          if (hasIndex) {
            warnEl.style.display = 'none';
          } else {
            warnEl.textContent = 'Warning: No index.html found in ' + (folderPath === './' ? 'root' : folderPath) + '. Your site may not load correctly.';
            warnEl.style.display = 'block';
          }
        }
      }).catch(function() {
        if (warnEl) warnEl.style.display = 'none';
      });
    }

    function handleDeployJsonSelect(input) {
      if (input.files && input.files[0]) {
        deployJsonFile = input.files[0];
        var nameEl = document.getElementById('deploy-json-name');
        nameEl.textContent = deployJsonFile.name;
        nameEl.style.display = 'block';
        document.getElementById('deploy-json-zone').classList.add('has-file');
      }
    }

    function submitDeploy() {
      if (!deploySiteId || !state.session || !state.session.token) return;
      if (!deployZipFile) {
        showMsg('deploy-msg', 'error', 'Please select a ZIP file.');
        return;
      }

      var distPath = document.getElementById('deploy-dist-path').value.trim();
      var btn = document.getElementById('deploy-submit-btn');
      btn.disabled = true;
      btn.innerHTML = 'Deploying <span class="loading-dots"><span></span><span></span><span></span></span>';
      hideMsg('deploy-msg');

      var formData = new FormData();
      formData.append('zip', deployZipFile);
      if (deployJsonFile) formData.append('chat', deployJsonFile);
      formData.append('dist_path', distPath);

      fetch('/api/sites/' + deploySiteId + '/deploy', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + state.session.token
        },
        body: formData
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Deploy failed')); });
          return res.json();
        })
        .then(function() {
          btn.disabled = false;
          btn.textContent = 'Deploy';
          showMsg('deploy-msg', 'success', 'Site deployed successfully!');
          setTimeout(function() {
            closeDeployModal();
            loadAdminDashboard();
          }, 1500);
        })
        .catch(function(err) {
          btn.disabled = false;
          btn.textContent = 'Deploy';
          showMsg('deploy-msg', 'error', err.message || 'Deploy failed.');
        });
    }

    /* ===========================================================
       Enhanced Domain Modal (Tabs + Search + Purchase)
       =========================================================== */
    function switchDomainTab(tab) {
      var tabs = ['existing', 'connect', 'register'];
      for (var i = 0; i < tabs.length; i++) {
        var tabBtn = document.getElementById('domain-tab-' + tabs[i]);
        var panel = document.getElementById('domain-panel-' + tabs[i]);
        if (tabs[i] === tab) {
          if (tabBtn) { tabBtn.classList.add('active'); tabBtn.setAttribute('aria-selected', 'true'); }
          if (panel) panel.style.display = '';
        } else {
          if (tabBtn) { tabBtn.classList.remove('active'); tabBtn.setAttribute('aria-selected', 'false'); }
          if (panel) panel.style.display = 'none';
        }
      }
      hideMsg('domain-modal-msg');
    }

    // Domain search for registration
    var domainSearchTimer = null;
    var domainSearchInput = document.getElementById('domain-search-input');
    if (domainSearchInput) {
      domainSearchInput.addEventListener('input', function() {
        var q = domainSearchInput.value.trim();
        clearTimeout(domainSearchTimer);
        if (q.length < 3) {
          closeDomainSearchResults();
          document.getElementById('domain-search-spinner').style.display = 'none';
          return;
        }
        document.getElementById('domain-search-spinner').style.display = '';
        domainSearchTimer = setTimeout(function() {
          searchDomains(q);
        }, 500);
      });
    }

    function searchDomains(query) {
      // Clean up the query - remove protocol and paths
      query = query.replace(/^https?:\/\//, '').replace(/\/.*$/, '').trim();

      fetch('/api/domains/search?q=' + encodeURIComponent(query), {
        headers: state.session && state.session.token ? { 'Authorization': 'Bearer ' + state.session.token } : {}
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Domain search failed. Please try again.')); });
          return res.json();
        })
        .then(function(d) {
          document.getElementById('domain-search-spinner').style.display = 'none';
          var results = (d && d.data) ? d.data : [];
          renderDomainSearchResults(results, query);
        })
        .catch(function(err) {
          document.getElementById('domain-search-spinner').style.display = 'none';
          var container = document.getElementById('domain-search-results');
          container.innerHTML = '<div style="padding:12px;color:var(--error);font-size:0.85rem;text-align:center;">' + escapeHtml(err.message || 'Domain search failed. Please try again.') + '</div>';
          container.classList.add('open');
        });
    }

    function renderDomainSearchResults(results, query) {
      var container = document.getElementById('domain-search-results');
      // Sort: available first (by price), then unavailable
      results.sort(function(a, b) {
        if (a.available && !b.available) return -1;
        if (!a.available && b.available) return 1;
        return (a.price || 0) - (b.price || 0);
      });

      // Separate: exact queried domain vs alternatives
      var queriedDomain = (query || '').toLowerCase().replace(/^https?:\/\//, '').replace(/\/.*$/, '').trim();
      var queriedResult = null;
      var availableResults = [];
      for (var i = 0; i < results.length; i++) {
        if (results[i].domain && results[i].domain.toLowerCase() === queriedDomain) {
          queriedResult = results[i];
        } else if (results[i].available && results[i].price > 0) {
          // Only keep available alternatives (never show "taken" for non-exact matches)
          availableResults.push(results[i]);
        }
      }

      var html = '<div class="domain-results-table">';

      // Show exact-match queried domain at top (show taken only for exact match)
      if (queriedResult) {
        var isAvail = queriedResult.available && queriedResult.price > 0;
        if (isAvail) {
          html += '<div class="domain-result-item domain-available" style="border-color:rgba(34,197,94,0.25);background:rgba(34,197,94,0.04);">';
          html += '<div class="domain-result-status"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>';
          html += '<div style="flex:1;min-width:0;">';
          html += '<div class="domain-result-name" style="font-weight:700;">' + escapeHtml(queriedResult.domain) + '</div>';
          html += '<div class="domain-result-tld">Exact match &middot; Available</div>';
          html += '</div>';
          html += '<div class="domain-result-price">$' + ((queriedResult.price || 0) / 100).toFixed(2) + '/yr</div>';
          html += '<button class="btn btn-accent" style="padding:7px 16px;font-size:0.75rem;border-radius:8px;" onclick="selectDomainForPurchase(\'' + escapeAttr(queriedResult.domain) + '\', ' + (queriedResult.price || 0) + ')">Get</button>';
          html += '</div>';
        } else {
          // Show taken notice for exact match only
          html += '<div style="padding:12px 14px;margin-bottom:8px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.12);border-radius:10px;display:flex;align-items:center;gap:10px;">';
          html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
          html += '<div style="flex:1;"><span style="font-weight:600;color:var(--text-primary);font-size:0.82rem;">' + escapeHtml(queriedResult.domain) + '</span> <span style="color:var(--text-muted);font-size:0.75rem;">is already registered.</span></div>';
          html += '</div>';
        }
      }

      // Show only available alternative domains
      if (availableResults.length > 0) {
        html += '<div style="padding:4px 6px 10px;font-size:0.72rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">' + availableResults.length + ' available domain' + (availableResults.length !== 1 ? 's' : '') + '</div>';
        for (var j = 0; j < availableResults.length; j++) {
          var r = availableResults[j];
          var tld = r.domain ? '.' + r.domain.split('.').pop() : '';
          html += '<div class="domain-result-item domain-available">';
          html += '<div class="domain-result-status"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>';
          html += '<div style="flex:1;min-width:0;">';
          html += '<div class="domain-result-name">' + escapeHtml(r.domain) + '</div>';
          html += '<div class="domain-result-tld">' + escapeHtml(tld) + ' domain</div>';
          html += '</div>';
          html += '<div class="domain-result-price">$' + ((r.price || 0) / 100).toFixed(2) + '/yr</div>';
          html += '<button class="btn btn-accent" style="padding:7px 16px;font-size:0.75rem;border-radius:8px;" onclick="selectDomainForPurchase(\'' + escapeAttr(r.domain) + '\', ' + (r.price || 0) + ')">Get</button>';
          html += '</div>';
        }
      } else if (!queriedResult || !(queriedResult.available && queriedResult.price > 0)) {
        // No available domains and queried was taken/missing
        html += '<div style="padding:20px;color:var(--text-muted);font-size:0.82rem;text-align:center;">';
        html += '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:8px;opacity:0.4;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><br>';
        html += 'No matching domains available. Try a different name.';
        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;
      container.classList.add('open');
    }

    function closeDomainSearchResults() {
      var el = document.getElementById('domain-search-results');
      if (el) el.classList.remove('open');
    }

    function selectDomainForPurchase(domain, priceCents) {
      closeDomainSearchResults();
      if (!adminDomainModalSiteId || !state.session || !state.session.token) return;

      var priceStr = '$' + (priceCents / 100).toFixed(2) + '/yr';
      if (!confirm('Register ' + domain + ' for ' + priceStr + '?\n\nThis will be billed as a separate Stripe subscription.')) return;

      showMsg('domain-modal-msg', 'info', 'Starting domain purchase for ' + domain + '...');

      fetch('/api/domains/purchase', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + state.session.token
        },
        body: JSON.stringify({
          domain: domain,
          site_id: adminDomainModalSiteId,
          success_url: window.location.origin + '/?domain_purchase=success',
          cancel_url: window.location.origin + '/?domain_purchase=cancel'
        })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Purchase failed')); });
          return res.json();
        })
        .then(function(d) {
          if (d.data && d.data.checkout_url) {
            window.location.href = d.data.checkout_url;
          } else {
            showMsg('domain-modal-msg', 'success', 'Domain ' + domain + ' registered and added!');
            loadHostnames(adminDomainModalSiteId);
          }
        })
        .catch(function(err) {
          showMsg('domain-modal-msg', 'error', err.message || 'Failed to purchase domain.');
        });
    }

    /* ===========================================================
       R2 File Browser
       =========================================================== */

    var filesModalSiteId = null;
    var filesModalSlug = null;
    var filesModalCurrentKey = null;

    function openFilesModal(siteId, siteName, slug) {
      trackEvent('files_modal_opened', { site_id: siteId, slug: slug });
      filesModalSiteId = siteId;
      filesModalSlug = slug;
      document.getElementById('files-modal-title').textContent = 'Files: ' + siteName;
      document.getElementById('files-modal').classList.add('visible');
      document.getElementById('files-editor').style.display = 'none';
      document.getElementById('files-list').style.display = '';
      document.getElementById('files-toolbar').style.display = '';
      loadFilesForSite();
    }

    function closeFilesModal() {
      document.getElementById('files-modal').classList.remove('visible');
      filesModalSiteId = null;
    }

    var _filesTreeData = []; // flat file list from API
    var _expandedFolders = {}; // which folders are expanded
    var _LARGE_FOLDER_THRESHOLD = 10; // folders with more items start collapsed/grayed

    function loadFilesForSite() {
      if (!filesModalSiteId) return;
      var list = document.getElementById('files-list');
      list.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:0.85rem;">Loading files\u2026</div>';

      var hdrs = {};
      if (state.session && state.session.token) hdrs['Authorization'] = 'Bearer ' + state.session.token;

      fetch('/api/sites/' + filesModalSiteId + '/files', { headers: hdrs })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d && d.error ? (typeof d.error === 'string' ? d.error : d.error.message || 'Failed') : 'Failed to load files'); });
          return r.json();
        })
        .then(function(d) {
          _filesTreeData = d.data.files || [];
          document.getElementById('files-breadcrumb').textContent = d.data.prefix || '';
          document.getElementById('files-count').textContent = _filesTreeData.length + ' files';

          if (!_filesTreeData.length) {
            list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:0.85rem;">No files found. Build or deploy your site first.</div>';
            return;
          }
          renderFileTree();
        })
        .catch(function(err) {
          list.innerHTML = '<div style="padding:16px;color:var(--error);font-size:0.85rem;">' + escapeHtml(err.message) + '</div>';
        });
    }

    function buildFolderTree(files) {
      var root = { name: '', children: {}, files: [] };
      for (var i = 0; i < files.length; i++) {
        var parts = files[i].name.split('/');
        var node = root;
        for (var j = 0; j < parts.length - 1; j++) {
          if (!node.children[parts[j]]) node.children[parts[j]] = { name: parts[j], children: {}, files: [] };
          node = node.children[parts[j]];
        }
        node.files.push(files[i]);
      }
      return root;
    }

    function countFolderItems(node) {
      var count = node.files.length;
      var childKeys = Object.keys(node.children);
      for (var i = 0; i < childKeys.length; i++) {
        count += countFolderItems(node.children[childKeys[i]]);
      }
      return count;
    }

    function renderFileTree() {
      var list = document.getElementById('files-list');
      var tree = buildFolderTree(_filesTreeData);
      var html = renderFolderNode(tree, '', 0);
      // Action buttons at bottom (centered)
      html += '<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.06);">';
      html += '<button class="editor-toolbar-btn" style="color:#22c55e;padding:5px 14px;font-size:0.74rem;" onclick="promptNewFile()" data-tooltip="Create a new file"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="margin-right:4px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New File</button>';
      html += '<button class="editor-toolbar-btn" style="color:var(--accent);padding:5px 14px;font-size:0.74rem;" onclick="promptNewFolder(\'\')" data-tooltip="Create a new folder"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="margin-right:4px;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>New Folder</button>';
      html += '<button class="editor-toolbar-btn" style="color:#a78bfa;padding:5px 14px;font-size:0.74rem;" onclick="triggerFileUpload(\'\')" data-tooltip="Upload files"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="margin-right:4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload</button>';
      html += '</div>';
      list.innerHTML = html;
    }

    function renderFolderNode(node, path, depth) {
      var html = '';
      var indent = depth * 16;
      // Render child folders first (sorted)
      var folderNames = Object.keys(node.children).sort();
      for (var fi = 0; fi < folderNames.length; fi++) {
        var fname = folderNames[fi];
        var child = node.children[fname];
        var folderPath = path ? path + '/' + fname : fname;
        var itemCount = countFolderItems(child);
        var isLarge = itemCount > _LARGE_FOLDER_THRESHOLD;
        var isExpanded = !!_expandedFolders[folderPath];
        var grayed = isLarge && !isExpanded;

        html += '<div class="file-item" style="display:flex;align-items:center;gap:8px;padding:6px 12px 6px ' + (12 + indent) + 'px;cursor:pointer;transition:background 0.15s;border-bottom:1px solid rgba(255,255,255,0.02);' + (grayed ? 'opacity:0.45;' : '') + '" onclick="toggleFolder(\'' + escapeAttr(folderPath) + '\')" onmouseover="this.style.background=\'rgba(80,165,219,0.04)\'" onmouseout="this.style.background=\'transparent\'">';
        html += '<span style="color:var(--text-muted);flex-shrink:0;transition:transform 0.15s;transform:rotate(' + (isExpanded ? '90' : '0') + 'deg);"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg></span>';
        html += '<span style="color:#fbbf24;flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>';
        html += '<span style="flex:1;font-size:0.78rem;font-family:\'SF Mono\',\'Fira Code\',monospace;color:var(--text-primary);font-weight:' + (isLarge ? '500' : '400') + ';">' + escapeHtml(fname) + '/</span>';
        html += '<span style="font-size:0.62rem;color:var(--text-muted);flex-shrink:0;">' + itemCount + ' item' + (itemCount !== 1 ? 's' : '') + '</span>';
        if (grayed) html += '<span style="font-size:0.58rem;color:var(--text-muted);padding:1px 5px;border:1px solid var(--border);border-radius:3px;">Click to expand</span>';
        // Folder actions: new folder, upload, delete
        html += '<span style="display:flex;gap:2px;flex-shrink:0;" onclick="event.stopPropagation()">';
        html += '<button onclick="promptNewFolder(\'' + escapeAttr(folderPath + '/') + '\')" data-tooltip="New subfolder" style="background:none;border:none;padding:2px;cursor:pointer;color:var(--text-muted);transition:color 0.15s;display:flex;align-items:center;" onmouseover="this.style.color=\'var(--accent)\'" onmouseout="this.style.color=\'var(--text-muted)\'"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></button>';
        html += '<button onclick="triggerFileUpload(\'' + escapeAttr(folderPath) + '\')" data-tooltip="Upload to folder" style="background:none;border:none;padding:2px;cursor:pointer;color:var(--text-muted);transition:color 0.15s;display:flex;align-items:center;" onmouseover="this.style.color=\'#a78bfa\'" onmouseout="this.style.color=\'var(--text-muted)\'"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>';
        html += '<button onclick="confirmDeleteFolder(\'' + escapeAttr(folderPath + '/') + '\', \'' + escapeAttr(fname) + '\')" data-tooltip="Delete folder" style="background:none;border:none;padding:2px;cursor:pointer;color:var(--text-muted);transition:color 0.15s;display:flex;align-items:center;" onmouseover="this.style.color=\'#ef4444\'" onmouseout="this.style.color=\'var(--text-muted)\'"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
        html += '</span>';
        html += '</div>';

        if (isExpanded) {
          html += renderFolderNode(child, folderPath, depth + 1);
        }
      }
      // Render files in this folder (sorted)
      var sortedFiles = node.files.slice().sort(function(a, b) { return a.name.localeCompare(b.name); });
      for (var i = 0; i < sortedFiles.length; i++) {
        var f = sortedFiles[i];
        var fileName = f.name.split('/').pop();
        var sizeStr = formatFileSize(f.size);
        var isEditable = /\.(html|css|js|json|txt|md|xml|svg|mjs|ts|jsx|tsx)$/i.test(fileName);
        html += '<div class="file-item" style="display:flex;align-items:center;gap:10px;padding:6px 12px 6px ' + (12 + indent) + 'px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:' + (isEditable ? 'pointer' : 'default') + ';transition:background 0.15s;" ' + (isEditable ? 'onclick="openFileForEdit(\'' + escapeAttr(f.key) + '\', \'' + escapeAttr(fileName) + '\')"' : '') + ' onmouseover="this.style.background=\'rgba(80,165,219,0.04)\'" onmouseout="this.style.background=\'transparent\'">';
        html += '<span style="width:10px;flex-shrink:0;"></span>'; // indent spacer for alignment
        html += '<span style="color:' + (isEditable ? 'var(--accent)' : 'var(--text-muted)') + ';flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>';
        html += '<span style="flex:1;font-size:0.76rem;font-family:\'SF Mono\',\'Fira Code\',monospace;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(fileName) + '</span>';
        html += '<span style="font-size:0.65rem;color:var(--text-muted);flex-shrink:0;">' + sizeStr + '</span>';
        if (isEditable) html += '<span style="font-size:0.56rem;color:rgba(148,163,184,0.5);flex-shrink:0;letter-spacing:0.03em;">editable</span>';
        html += '<button onclick="event.stopPropagation();confirmDeleteFile(\'' + escapeAttr(f.key) + '\', \'' + escapeAttr(fileName) + '\')" data-tooltip="Delete file" style="flex-shrink:0;background:none;border:1px solid rgba(239,68,68,0.15);border-radius:4px;padding:2px 4px;cursor:pointer;color:var(--text-muted);transition:all 0.15s;display:flex;align-items:center;" onmouseover="this.style.color=\'#ef4444\';this.style.borderColor=\'rgba(239,68,68,0.4)\'" onmouseout="this.style.color=\'var(--text-muted)\';this.style.borderColor=\'rgba(239,68,68,0.15)\'"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
        html += '</div>';
      }
      return html;
    }

    function toggleFolder(folderPath) {
      if (_expandedFolders[folderPath]) {
        delete _expandedFolders[folderPath];
      } else {
        _expandedFolders[folderPath] = true;
      }
      renderFileTree();
    }

    function promptNewFile() {
      // Insert inline input row at bottom of file list
      var list = document.getElementById('files-list');
      var existing = document.getElementById('new-file-input-row');
      if (existing) { existing.querySelector('input').focus(); return; }
      var row = document.createElement('div');
      row.id = 'new-file-input-row';
      row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid rgba(34,197,94,0.15);background:rgba(34,197,94,0.03);';
      row.innerHTML = '<span style="color:#22c55e;flex-shrink:0;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span>'
        + '<input type="text" id="new-file-path-input" placeholder="e.g. styles/custom.css" style="flex:1;background:rgba(0,0,0,0.3);border:1px solid rgba(34,197,94,0.3);border-radius:5px;padding:5px 8px;color:var(--text-primary);font-size:0.76rem;font-family:\'SF Mono\',monospace;outline:none;" />'
        + '<button onclick="submitNewFile()" style="padding:4px 10px;background:#22c55e;color:#000;border:none;border-radius:5px;font-size:0.7rem;font-weight:600;cursor:pointer;">Create</button>'
        + '<button onclick="cancelNewFile()" style="padding:4px 8px;background:transparent;color:var(--text-muted);border:1px solid var(--border);border-radius:5px;font-size:0.7rem;cursor:pointer;">Cancel</button>';
      // Insert before the add-new-file button
      var addBtn = list.querySelector('[onclick="promptNewFile()"]');
      if (addBtn) list.insertBefore(row, addBtn);
      else list.appendChild(row);
      var inp = row.querySelector('input');
      inp.focus();
      inp.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); submitNewFile(); }
        if (e.key === 'Escape') { e.preventDefault(); cancelNewFile(); }
      });
    }

    function submitNewFile() {
      var inp = document.getElementById('new-file-path-input');
      if (!inp) return;
      var path = inp.value.trim().replace(/^\/+/, '');
      if (!path) { inp.style.borderColor = '#ef4444'; return; }
      if (!/^[a-zA-Z0-9._\-\/]+$/.test(path)) {
        inp.style.borderColor = '#ef4444';
        inp.title = 'Use only letters, numbers, dots, hyphens, underscores, and forward slashes.';
        return;
      }
      cancelNewFile();
      createNewFile(path);
    }

    function cancelNewFile() {
      var row = document.getElementById('new-file-input-row');
      if (row) row.remove();
    }

    function confirmDeleteFile(r2Key, fileName) {
      if (!confirm('Delete "' + fileName + '"?\n\nThis cannot be undone.')) return;
      deleteFile(r2Key, fileName);
    }

    function deleteFile(r2Key, fileName) {
      if (!filesModalSiteId || !state.session || !state.session.token) return;
      fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(r2Key), {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + state.session.token }
      })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to delete file')); });
          showToast('"' + fileName + '" deleted.', 'success');
          trackEvent('file_deleted', { site_id: filesModalSiteId, file: fileName });
          loadFilesForSite();
        })
        .catch(function(err) {
          showToast(err.message || 'Failed to delete file.', 'error');
        });
    }

    function createNewFile(relativePath) {
      if (!filesModalSiteId || !state.session || !state.session.token) return;
      var prefix = document.getElementById('files-breadcrumb').textContent || '';
      var fullKey = prefix + relativePath;

      fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(fullKey), {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + state.session.token
        },
        body: JSON.stringify({ content: '' })
      })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to create file')); });
          return r.json();
        })
        .then(function() {
          // Reload file list then open the new file for editing
          loadFilesForSite();
          setTimeout(function() {
            openFileForEdit(fullKey, relativePath.split('/').pop());
          }, 500);
        })
        .catch(function(err) {
          alert('Error: ' + err.message);
        });
    }

    /* â”€â”€ File Rename (inline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function startFileRename() {
      if (!filesModalCurrentKey) return;
      var nameEl = document.getElementById('files-editor-name');
      var renameWrap = document.getElementById('files-rename-wrap');
      var renameInput = document.getElementById('files-rename-input');
      if (!nameEl || !renameWrap || !renameInput) return;
      var currentName = filesModalCurrentKey.split('/').pop() || '';
      renameInput.value = currentName;
      nameEl.style.display = 'none';
      renameWrap.style.display = 'flex';
      renameInput.focus();
      renameInput.select();
    }

    function cancelFileRename() {
      var nameEl = document.getElementById('files-editor-name');
      var renameWrap = document.getElementById('files-rename-wrap');
      if (nameEl) nameEl.style.display = '';
      if (renameWrap) renameWrap.style.display = 'none';
    }

    function confirmFileRename() {
      var renameInput = document.getElementById('files-rename-input');
      if (!renameInput || !filesModalCurrentKey || !filesModalSiteId) return;
      var newName = renameInput.value.trim();
      if (!newName || !/^[a-zA-Z0-9._\-]+$/.test(newName)) {
        renameInput.style.borderBottom = '1px solid #ef4444';
        return;
      }
      var parts = filesModalCurrentKey.split('/');
      parts[parts.length - 1] = newName;
      var newKey = parts.join('/');
      if (newKey === filesModalCurrentKey) { cancelFileRename(); return; }

      // Read current content, create at new path, delete old
      var currentContent = '';
      if (cmEditor) { currentContent = cmEditor.getValue(); }
      else { var ta = document.getElementById('files-editor-content'); if (ta) currentContent = ta.value; }

      fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(newKey), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.session.token },
        body: JSON.stringify({ content: currentContent })
      }).then(function(r) {
        if (!r.ok) throw new Error('Failed to create renamed file');
        return fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(filesModalCurrentKey), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + state.session.token }
        });
      }).then(function() {
        filesModalCurrentKey = newKey;
        var nameEl = document.getElementById('files-editor-name');
        if (nameEl) nameEl.textContent = newName;
        cancelFileRename();
        showToast('File renamed to ' + newName, 'success');
        trackEvent('file_renamed', { site_id: filesModalSiteId, old_key: filesModalCurrentKey, new_key: newKey });
      }).catch(function(err) {
        showToast(err.message || 'Rename failed', 'error');
      });
    }

    /* â”€â”€ Folder Creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function promptNewFolder(parentPath) {
      var name = prompt('New folder name:');
      if (!name || !name.trim()) return;
      name = name.trim().replace(/[^a-zA-Z0-9._\-]/g, '');
      if (!name) { showToast('Invalid folder name', 'error'); return; }
      var folderPath = (parentPath || '') + name + '/.gitkeep';
      createNewFile(folderPath.replace(/^\/+/, ''));
    }

    /* â”€â”€ Folder Deletion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function confirmDeleteFolder(folderPrefix, folderName) {
      if (!confirm('Delete folder "' + folderName + '" and all its contents?\n\nThis cannot be undone.')) return;
      if (!filesModalSiteId || !state.session || !state.session.token) return;
      // Get all files in this folder
      var filesToDelete = _filesTreeData.filter(function(f) {
        return f.key.startsWith(folderPrefix);
      });
      if (!filesToDelete.length) { showToast('Folder is empty.', 'info'); return; }
      var promises = filesToDelete.map(function(f) {
        return fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(f.key), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + state.session.token }
        });
      });
      Promise.all(promises).then(function() {
        showToast('Folder "' + folderName + '" deleted (' + filesToDelete.length + ' files).', 'success');
        trackEvent('folder_deleted', { site_id: filesModalSiteId, folder: folderPrefix, count: filesToDelete.length });
        loadFilesForSite();
      }).catch(function(err) {
        showToast(err.message || 'Failed to delete folder.', 'error');
      });
    }

    /* â”€â”€ File Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    var MAX_SITE_SIZE = 1024 * 1024 * 1024; // 1GB

    function triggerFileUpload(targetFolder) {
      var input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.style.display = 'none';
      input.accept = '*/*';
      input.onchange = function() {
        if (!input.files || !input.files.length) return;
        uploadFiles(input.files, targetFolder || '');
        input.remove();
      };
      document.body.appendChild(input);
      input.click();
    }

    function uploadFiles(files, targetFolder) {
      if (!filesModalSiteId || !state.session || !state.session.token) return;
      var toUpload = [];
      for (var i = 0; i < files.length; i++) {
        if (files[i].size > MAX_FILE_SIZE) {
          showToast(files[i].name + ' exceeds 50MB limit.', 'error');
          continue;
        }
        toUpload.push(files[i]);
      }
      if (!toUpload.length) return;
      var uploaded = 0;
      var total = toUpload.length;
      showToast('Uploading ' + total + ' file(s)...', 'info');

      toUpload.forEach(function(file) {
        var prefix = document.getElementById('files-breadcrumb').textContent || '';
        var fullKey = prefix + (targetFolder ? targetFolder + '/' : '') + file.name;

        var reader = new FileReader();
        reader.onload = function() {
          var base64 = reader.result.split(',')[1] || '';
          fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(fullKey), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.session.token },
            body: JSON.stringify({ content: base64, encoding: 'base64' })
          }).then(function(r) {
            if (!r.ok) throw new Error('Failed to upload ' + file.name);
            uploaded++;
            if (uploaded === total) {
              showToast(total + ' file(s) uploaded!', 'success');
              trackEvent('files_uploaded', { site_id: filesModalSiteId, count: total });
              loadFilesForSite();
            }
          }).catch(function(err) {
            showToast(err.message, 'error');
          });
        };
        reader.readAsDataURL(file);
      });
    }

    /** CodeMirror editor instance (null if CodeMirror not loaded â€” textarea fallback) */
    var cmEditor = null;
    var cmEditorReady = false;

    /** Check if CodeMirror is available */
    function hasCM() { return typeof CodeMirror !== 'undefined'; }

    /** Get file mode based on extension */
    function getEditorMode(name) {
      var ext = (name || '').split('.').pop().toLowerCase();
      if (ext === 'css') return 'css';
      if (ext === 'js' || ext === 'json') return { name: 'javascript', json: ext === 'json' };
      if (ext === 'xml' || ext === 'svg') return 'xml';
      if (ext === 'html' || ext === 'htm') return 'htmlmixed';
      return 'htmlmixed';
    }

    /** Initialize or get CodeMirror editor */
    function ensureCMEditor(mode) {
      var wrap = document.getElementById('code-editor-wrap');
      if (!wrap) return null;

      if (cmEditor) {
        cmEditor.setOption('mode', mode);
        return cmEditor;
      }

      if (!hasCM()) return null;

      // Hide textarea fallback elements
      var textarea = document.getElementById('files-editor-content');
      var gutter = document.getElementById('code-line-numbers');
      if (textarea) textarea.style.display = 'none';
      if (gutter) gutter.style.display = 'none';

      cmEditor = CodeMirror(wrap, {
        value: '',
        mode: mode,
        theme: 'bolt-dark',
        lineNumbers: true,
        tabSize: 2,
        indentUnit: 2,
        indentWithTabs: false,
        lineWrapping: false,
        matchBrackets: true,
        autoCloseBrackets: true,
        styleActiveLine: true,
        extraKeys: {
          'Ctrl-S': function() { saveCurrentFile(); },
          'Cmd-S': function() { saveCurrentFile(); },
          Tab: function(cm) {
            if (cm.somethingSelected()) {
              cm.indentSelection('add');
            } else {
              cm.replaceSelection('  ', 'end');
            }
          },
          'Shift-Tab': function(cm) { cm.indentSelection('subtract'); }
        }
      });
      cmEditorReady = true;
      return cmEditor;
    }

    /** Get current editor content (CodeMirror or textarea) */
    function getEditorContent() {
      if (cmEditor && cmEditorReady) return cmEditor.getValue();
      var textarea = document.getElementById('files-editor-content');
      return textarea ? textarea.value : '';
    }

    /** Set editor content (CodeMirror or textarea) */
    function setEditorContent(content, mode) {
      if (cmEditor && cmEditorReady) {
        cmEditor.setValue(content);
        if (mode) cmEditor.setOption('mode', mode);
        setTimeout(function() { cmEditor.refresh(); }, 10);
        return;
      }
      var textarea = document.getElementById('files-editor-content');
      if (textarea) {
        textarea.value = content;
        textarea.style.display = '';
      }
      var gutter = document.getElementById('code-line-numbers');
      if (gutter) gutter.style.display = '';
      updateLineNumbers();
    }

    function openFileForEdit(key, name) {
      filesModalCurrentKey = key;
      document.getElementById('files-editor-name').textContent = name;
      // Show directory path prefix (everything before the filename)
      var pathPrefix = document.getElementById('files-editor-path-prefix');
      if (pathPrefix) {
        var parts = key.split('/');
        parts.pop(); // remove filename
        pathPrefix.textContent = parts.length > 0 ? parts.join('/') + '/' : '';
      }
      document.getElementById('files-editor').style.display = 'flex';
      document.getElementById('files-list').style.display = 'none';
      document.getElementById('files-toolbar').style.display = 'none';
      hideMsg('files-editor-msg');

      var mode = getEditorMode(name);
      // Show language tag in toolbar
      var langEl = document.getElementById('files-editor-lang');
      if (langEl) {
        var langMap = { 'htmlmixed': 'HTML', 'css': 'CSS', 'javascript': 'JavaScript', 'application/json': 'JSON', 'xml': 'XML' };
        var modeKey = (typeof mode === 'object' && mode !== null) ? mode.name : mode;
        var isJson = (typeof mode === 'object' && mode !== null && mode.json);
        langEl.textContent = isJson ? 'JSON' : (langMap[modeKey] || modeKey || 'Text');
      }
      var editor = ensureCMEditor(mode);
      if (editor) {
        editor.setValue('Loading...');
      } else {
        setEditorContent('Loading...');
      }

      var hdrs = {};
      if (state.session && state.session.token) hdrs['Authorization'] = 'Bearer ' + state.session.token;

      fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(key), { headers: hdrs })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d && d.error ? (typeof d.error === 'string' ? d.error : d.error.message || 'Failed') : 'Failed to load file'); });
          return r.json();
        })
        .then(function(d) {
          var content = d.data.content || '';
          setEditorContent(content, mode);
          var sizeEl = document.getElementById('files-editor-size');
          if (sizeEl) sizeEl.textContent = formatFileSize(content.length);
        })
        .catch(function(err) {
          showMsg('files-editor-msg', 'error', err.message || 'Failed to load file');
        });
    }

    function closeFileEditor() {
      document.getElementById('files-editor').style.display = 'none';
      document.getElementById('files-list').style.display = '';
      document.getElementById('files-toolbar').style.display = '';
      filesModalCurrentKey = null;
    }

    /** Update line number gutter to match textarea content (fallback only) */
    function updateLineNumbers() {
      if (cmEditor && cmEditorReady) return; // CodeMirror handles its own line numbers
      var textarea = document.getElementById('files-editor-content');
      var gutter = document.getElementById('code-line-numbers');
      if (!textarea || !gutter) return;
      var lines = (textarea.value || '').split('\n').length;
      var nums = '';
      for (var i = 1; i <= lines; i++) { nums += i + '\n'; }
      gutter.textContent = nums;
    }

    /** Sync line number scroll with textarea scroll (fallback only) */
    function syncLineScroll() {
      if (cmEditor && cmEditorReady) return;
      var textarea = document.getElementById('files-editor-content');
      var gutter = document.getElementById('code-line-numbers');
      if (textarea && gutter) gutter.scrollTop = textarea.scrollTop;
    }

    /** Handle editor keydown: Tab indent, Ctrl+S save (fallback only) */
    function handleEditorKeydown(event) {
      if (cmEditor && cmEditorReady) return; // CodeMirror handles its own keybindings
      if (event.key === 'Tab') {
        event.preventDefault();
        var t = event.target;
        var s = t.selectionStart, e = t.selectionEnd;
        t.value = t.value.substring(0, s) + '  ' + t.value.substring(e);
        t.selectionStart = t.selectionEnd = s + 2;
        updateLineNumbers();
      } else if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        saveCurrentFile();
      }
    }

    /** Toggle word wrap on editor */
    var editorWrapping = false;
    function editorWordWrap() {
      editorWrapping = !editorWrapping;
      var btn = document.getElementById('editor-wrap-btn');
      if (cmEditor && cmEditorReady) {
        cmEditor.setOption('lineWrapping', editorWrapping);
      } else {
        var textarea = document.getElementById('files-editor-content');
        if (textarea) {
          textarea.style.whiteSpace = editorWrapping ? 'pre-wrap' : 'pre';
          textarea.style.wordBreak = editorWrapping ? 'break-all' : 'normal';
        }
      }
      if (btn) {
        btn.style.color = editorWrapping ? 'var(--accent)' : '';
        btn.style.borderColor = editorWrapping ? 'var(--accent-dim)' : '';
      }
    }

    function saveCurrentFile() {
      if (!filesModalSiteId || !filesModalCurrentKey) return;
      var content = getEditorContent();
      var saveBtn = document.getElementById('files-save-btn');
      if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving\u2026'; }

      var hdrs = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) hdrs['Authorization'] = 'Bearer ' + state.session.token;

      fetch('/api/sites/' + filesModalSiteId + '/files/' + encodeURIComponent(filesModalCurrentKey), {
        method: 'PUT',
        headers: hdrs,
        body: JSON.stringify({ content: content })
      })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d && d.error ? (typeof d.error === 'string' ? d.error : d.error.message || 'Failed') : 'Failed to save file'); });
          return r.json();
        })
        .then(function() {
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
          showMsg('files-editor-msg', 'success', 'File saved successfully!');
          showToast('File saved successfully', 'success', 3000);
          var sizeEl = document.getElementById('files-editor-size');
          if (sizeEl) sizeEl.textContent = formatFileSize(content.length);
        })
        .catch(function(err) {
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
          showMsg('files-editor-msg', 'error', err.message || 'Failed to save');
          showToast(err.message || 'Failed to save file', 'error');
        });
    }

    /* ===========================================================
       Build Terminal (Real Workflow Status Polling)
       =========================================================== */

    /** Map workflow step names to human-readable descriptions */
    var WORKFLOW_STEP_LABELS = {
      'research-profile': 'Researching business profile & entity data',
      'research-social': 'Crawling social profiles & public web presence',
      'research-brand': 'Analyzing brand identity, colors & fonts',
      'research-selling-points': 'Generating selling points & hero content',
      'research-images': 'Researching image strategies & visual assets',
      'generate-website': 'AI generating full website HTML & content',
      'generate-privacy-page': 'Generating privacy policy page',
      'generate-terms-page': 'Generating terms of service page',
      'score-website': 'Running 8-dimension quality score check',
      'upload-to-r2': 'Uploading files to CDN edge network',
      'update-site-status': 'Finalizing & publishing site'
    };

    /** Ordered steps for the build pipeline display */
    var WORKFLOW_STEP_ORDER = [
      'research-profile',
      'research-social',
      'research-brand',
      'research-selling-points',
      'research-images',
      'generate-website',
      'generate-privacy-page',
      'generate-terms-page',
      'score-website',
      'upload-to-r2',
      'update-site-status'
    ];

    var buildTerminalTimer = null;
    var lastWorkflowStatus = null;
    var terminalLogLines = [];

    function addTerminalLine(text, cls) {
      terminalLogLines.push({ text: text, cls: cls });
      requestAnimationFrame(function() {
        var body = document.getElementById('build-terminal-body');
        if (!body) return;
        var line = document.createElement('div');
        line.className = 'build-terminal-line ' + (cls || '');
        line.textContent = text;
        body.appendChild(line);
        line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }

    function updateTerminalLine(index, text, cls) {
      requestAnimationFrame(function() {
        var body = document.getElementById('build-terminal-body');
        if (!body) return;
        var lines = body.querySelectorAll('.build-terminal-line');
        if (index < lines.length) {
          lines[index].textContent = text;
          lines[index].className = 'build-terminal-line ' + (cls || '');
        }
      });
    }

    function startBuildTerminal() {
      terminalLogLines = [];
      var body = document.getElementById('build-terminal-body');
      if (!body) return;
      body.innerHTML = '';

      // Initial context lines
      var bizName = '';
      var bizAddr = '';
      var placeId = '';
      if (state.selectedBusiness) {
        bizName = state.selectedBusiness.name || state.selectedBusiness.business_name || '';
        bizAddr = state.selectedBusiness.address || state.selectedBusiness.formatted_address || state.selectedBusiness.street_address || '';
        placeId = state.selectedBusiness.place_id || state.selectedBusiness.id || '';
      } else {
        var nameInput = document.getElementById('business-name-input');
        var addrInput = document.getElementById('business-address-input');
        if (nameInput) bizName = nameInput.value.trim();
        if (addrInput) bizAddr = addrInput.value.trim();
      }

      addTerminalLine('Initializing build pipeline...', 'active');
      if (bizName) addTerminalLine('Business: ' + bizName, 'info');
      if (bizAddr) addTerminalLine('Address: ' + bizAddr, 'info');
      if (placeId) addTerminalLine('Google Place ID: ' + placeId, 'info');
      if (state.slug) addTerminalLine('Target: ' + state.slug + '-sites.megabyte.space', 'info');
      addTerminalLine('', '');

      // Add pending steps for each workflow stage
      for (var i = 0; i < WORKFLOW_STEP_ORDER.length; i++) {
        var stepKey = WORKFLOW_STEP_ORDER[i];
        addTerminalLine(WORKFLOW_STEP_LABELS[stepKey] || stepKey, 'pending');
      }

      // Start polling the workflow endpoint
      lastWorkflowStatus = null;
      clearInterval(buildTerminalTimer);
      buildTerminalTimer = setInterval(function() {
        pollWorkflowStatus();
      }, 3000);
      // Immediate first poll
      pollWorkflowStatus();
    }

    /** Track which log IDs we've already processed to avoid duplicates */
    var processedLogIds = {};

    function pollWorkflowStatus() {
      if (!state.siteId) return;
      var headers = {};
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      fetch('/api/sites/' + state.siteId + '/workflow', { headers: headers })
        .then(function(res) {
          if (!res.ok) return null;
          return res.json();
        })
        .then(function(resp) {
          if (!resp || !resp.data) return;
          var data = resp.data;

          requestAnimationFrame(function() {
          var body = document.getElementById('build-terminal-body');
          if (!body) return;
          var lines = body.querySelectorAll('.build-terminal-line');
          if (lines.length === 0) return;

          // Mark initialization as done
          if (lines[0].classList.contains('active')) {
            lines[0].textContent = 'Build pipeline initialized';
            lines[0].className = 'build-terminal-line done';
          }

          var wfStatus = data.workflow_status;
          var siteStatus = data.site_status;
          var wfOutput = data.workflow_output;
          var wfError = data.workflow_error;
          var recentLogs = data.recent_logs || [];

          // Find the step lines (skip info/context lines at the top)
          var stepLineStart = -1;
          for (var j = 0; j < lines.length; j++) {
            if (lines[j].classList.contains('pending') || lines[j].classList.contains('done') || lines[j].classList.contains('active')) {
              var txt = lines[j].textContent.replace(/ â€” .*$/, ''); // Strip timing suffix
              for (var k = 0; k < WORKFLOW_STEP_ORDER.length; k++) {
                if (txt === (WORKFLOW_STEP_LABELS[WORKFLOW_STEP_ORDER[k]] || WORKFLOW_STEP_ORDER[k])) {
                  if (stepLineStart === -1) stepLineStart = j;
                  break;
                }
              }
            }
          }

          if (stepLineStart === -1) return;

          // â”€â”€ Use audit logs to update step status with timing â”€â”€
          if (recentLogs.length > 0) {
            // Build a map of completed/started steps from logs
            var completedSteps = {};
            var startedSteps = {};

            // Process logs chronologically (they come newest-first from API)
            var chronoLogs = recentLogs.slice().reverse();
            for (var li = 0; li < chronoLogs.length; li++) {
              var log = chronoLogs[li];
              if (!log.metadata) continue;
              var step = log.metadata.step;
              if (!step) continue;

              if (log.action === 'workflow.step.complete') {
                completedSteps[step] = log.metadata;
              } else if (log.action === 'workflow.step.started') {
                startedSteps[step] = log.metadata;
              }
            }

            // Update terminal lines based on actual step status
            for (var si = 0; si < WORKFLOW_STEP_ORDER.length; si++) {
              var stepKey = WORKFLOW_STEP_ORDER[si];
              var lineIdx = stepLineStart + si;
              if (lineIdx >= lines.length) break;

              var label = WORKFLOW_STEP_LABELS[stepKey] || stepKey;

              if (completedSteps[stepKey]) {
                var elapsedMs = completedSteps[stepKey].elapsed_ms;
                var timing = elapsedMs ? ' â€” ' + (elapsedMs / 1000).toFixed(1) + 's' : '';
                var msg = completedSteps[stepKey].message;
                lines[lineIdx].textContent = label + timing;
                lines[lineIdx].className = 'build-terminal-line done';
                if (msg && !processedLogIds[stepKey + ':msg']) {
                  processedLogIds[stepKey + ':msg'] = true;
                  addTerminalLine('  â†’ ' + msg, 'info');
                }
              } else if (startedSteps[stepKey]) {
                lines[lineIdx].textContent = label;
                lines[lineIdx].className = 'build-terminal-line active';
              }
            }

            // Show status_update messages from logs
            for (var sui = 0; sui < chronoLogs.length; sui++) {
              var sLog = chronoLogs[sui];
              if (sLog.action === 'workflow.status_update' && sLog.metadata && sLog.metadata.message) {
                var logKey = 'su:' + sLog.created_at;
                if (!processedLogIds[logKey]) {
                  processedLogIds[logKey] = true;
                  addTerminalLine('â–¸ ' + sLog.metadata.message, 'info');
                }
              }
            }
          }

          // â”€â”€ Handle terminal states â”€â”€

          // If site is published, mark everything done
          if (siteStatus === 'published') {
            for (var pi = 0; pi < WORKFLOW_STEP_ORDER.length; pi++) {
              var pLineIdx = stepLineStart + pi;
              if (pLineIdx < lines.length) {
                lines[pLineIdx].className = 'build-terminal-line done';
              }
            }
            clearInterval(buildTerminalTimer);

            var slug = state.slug || '';
            addTerminalLine('', '');
            addTerminalLine('Build completed successfully!', 'done');
            if (slug) {
              addTerminalLine('Deployed to https://' + slug + '-sites.megabyte.space', 'done');
              addTerminalLine('', '');
              addTerminalLine('To use a custom domain, set a CNAME record pointing to sites.megabyte.space', 'info');
            }
            return;
          }

          // If workflow errored, show error
          if (wfStatus === 'errored' || wfStatus === 'failed') {
            clearInterval(buildTerminalTimer);
            addTerminalLine('', '');
            var errorMsg = wfError || 'Unknown error';
            if (typeof errorMsg === 'object') {
              errorMsg = errorMsg.message || errorMsg.name || JSON.stringify(errorMsg);
            }
            addTerminalLine('Build failed: ' + errorMsg, 'error');
            addTerminalLine('Please try rebuilding from the admin panel.', 'info');
            return;
          }

          // If workflow completed but site not yet published, it's finishing up
          if (wfStatus === 'complete' && wfOutput) {
            for (var ci = 0; ci < WORKFLOW_STEP_ORDER.length; ci++) {
              var cLineIdx = stepLineStart + ci;
              if (cLineIdx < lines.length) {
                lines[cLineIdx].className = 'build-terminal-line done';
              }
            }
            addTerminalLine('', '');
            addTerminalLine('Workflow complete. Publishing site...', 'active');
            return;
          }

          // For running workflows without logs, mark first step as active
          if (wfStatus === 'running' && recentLogs.length === 0) {
            if (stepLineStart < lines.length && lines[stepLineStart].classList.contains('pending')) {
              lines[stepLineStart].className = 'build-terminal-line active';
            }
          }
          }); // end requestAnimationFrame
        })
        .catch(function() {
          // Silently continue polling
        });
    }

    function stopBuildTerminal() {
      clearInterval(buildTerminalTimer);
    }

    /* ===========================================================
       Details Modal: Business Name Live Search
       =========================================================== */
    var detailsBizSearchTimer = null;
    var detailsBizNameInput = document.getElementById('business-name-input');
    var detailsBizDropdown = document.getElementById('details-biz-dropdown');

    if (detailsBizNameInput) {
      detailsBizNameInput.addEventListener('input', function() {
        var q = detailsBizNameInput.value.trim();
        clearTimeout(detailsBizSearchTimer);
        if (q.length < 2) {
          closeDetailsBizDropdown();
          return;
        }
        detailsBizSearchTimer = setTimeout(function() {
          fetchDetailsBizResults(q);
        }, 300);
      });

      detailsBizNameInput.addEventListener('focus', function() {
        if (detailsBizNameInput.value.trim().length >= 2 && detailsBizDropdown.children.length > 0) {
          detailsBizDropdown.classList.add('open');
        }
      });

      document.addEventListener('click', function(e) {
        if (!e.target.closest('.details-biz-search-wrap')) {
          closeDetailsBizDropdown();
        }
      });
    }

    var _detailsPreBuiltResults = [];

    function fetchDetailsBizResults(query) {
      var searchUrl = '/api/search/businesses?q=' + encodeURIComponent(query);
      if (state.userLat !== null && state.userLng !== null) {
        searchUrl += '&lat=' + state.userLat + '&lng=' + state.userLng;
      }

      // Search both pre-built sites and Google Places in parallel (same as homepage)
      var sitesP = fetch('/api/sites/search?q=' + encodeURIComponent(query))
        .then(function(res) { return res.ok ? res.json() : { data: [] }; })
        .then(function(d) { return d.data || []; })
        .catch(function() { return []; });

      var placesP = fetch(searchUrl)
        .then(function(res) { return res.json(); })
        .then(function(d) { return d.data || []; })
        .catch(function() { return []; });

      Promise.all([sitesP, placesP])
        .then(function(results) {
          _detailsPreBuiltResults = Array.isArray(results[0]) ? results[0] : [];
          var places = Array.isArray(results[1]) ? results[1] : [];
          renderDetailsBizDropdown(_detailsPreBuiltResults, places);
        })
        .catch(function() {
          closeDetailsBizDropdown();
        });
    }

    function renderDetailsBizDropdown(preBuilt, items) {
      if (!preBuilt.length && !items.length) {
        closeDetailsBizDropdown();
        return;
      }

      var html = '';

      // Pre-built sites first (same styling as homepage dropdown)
      for (var j = 0; j < preBuilt.length; j++) {
        var pb = preBuilt[j];
        html += '<div class="search-result search-result-prebuilt" onclick="selectDetailsPreBuilt(' + j + ')" style="padding:10px 16px;">';
        html += '<div class="search-result-icon" style="width:32px;height:32px;background:rgba(34,197,94,0.12)">';
        html += '<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" style="width:16px;height:16px;">';
        html += '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
        html += '</svg></div>';
        html += '<div class="search-result-text">';
        html += '<div class="search-result-name" style="font-size:0.88rem;">' + escapeHtml(pb.business_name || pb.name || '') + ' <span style="display:inline-block;background:rgba(34,197,94,0.15);color:#22c55e;font-size:0.65rem;font-weight:700;padding:1px 5px;border-radius:3px;margin-left:4px;vertical-align:middle;letter-spacing:0.03em">PRE-BUILT</span></div>';
        html += '<div class="search-result-address" style="font-size:0.78rem;">' + escapeHtml(pb.business_address || pb.address || 'Ready to view') + '</div>';
        html += '</div></div>';
      }

      // Filter out duplicates (same as homepage)
      var preBuiltPlaceIds = {};
      var preBuiltNames = {};
      for (var p = 0; p < preBuilt.length; p++) {
        if (preBuilt[p].google_place_id) preBuiltPlaceIds[preBuilt[p].google_place_id] = true;
        var pbName = (preBuilt[p].business_name || '').toLowerCase().trim();
        if (pbName) preBuiltNames[pbName] = true;
      }
      var filtered = items.filter(function(r) {
        var pid = r.place_id || r.id || '';
        if (pid && preBuiltPlaceIds[pid]) return false;
        var rName = (r.name || r.business_name || '').toLowerCase().trim();
        if (rName && preBuiltNames[rName]) return false;
        return true;
      });

      // Sort by distance (closest first) when location is available
      if (state.userLat !== null && state.userLng !== null) {
        filtered.sort(function(a, b) {
          var distA = (a.lat != null && a.lng != null) ? haversineKm(state.userLat, state.userLng, a.lat, a.lng) : Infinity;
          var distB = (b.lat != null && b.lng != null) ? haversineKm(state.userLat, state.userLng, b.lat, b.lng) : Infinity;
          return distA - distB;
        });
      }

      for (var i = 0; i < filtered.length; i++) {
        var item = filtered[i];
        var dist = '';
        if (state.userLat !== null && item.lat != null && item.lng != null) {
          var km = haversineKm(state.userLat, state.userLng, item.lat, item.lng);
          dist = ' <span style="color:var(--text-muted);font-size:0.75rem;">' + formatDistance(km) + '</span>';
        }
        html += '<div class="search-result" onclick="selectDetailsBusiness(' + i + ')" style="padding:10px 16px;">';
        html += '<div class="search-result-icon" style="width:32px;height:32px;">';
        html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">';
        html += '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>';
        html += '</svg></div>';
        html += '<div class="search-result-text">';
        html += '<div class="search-result-name" style="font-size:0.88rem;">' + escapeHtml(item.name || '') + dist + '</div>';
        html += '<div class="search-result-address" style="font-size:0.78rem;">' + escapeHtml(item.address || item.formatted_address || '') + '</div>';
        html += '</div></div>';
      }
      detailsBizDropdown.innerHTML = html;
      detailsBizDropdown._items = filtered;
      detailsBizDropdown.classList.add('open');
    }

    function selectDetailsPreBuilt(index) {
      var site = _detailsPreBuiltResults[index];
      if (!site) return;
      closeDetailsBizDropdown();
      // Set as selected business
      state.selectedBusiness = {
        name: site.business_name || site.name,
        address: site.business_address || site.address || '',
        place_id: site.google_place_id || ''
      };
      state.mode = 'business';
      document.getElementById('badge-biz-name').textContent = state.selectedBusiness.name || '';
      document.getElementById('badge-biz-addr').textContent = state.selectedBusiness.address || '';
      document.getElementById('details-business-badge').style.display = 'flex';
      document.getElementById('details-manual-fields').style.display = 'none';
      var titleEl = document.getElementById('details-title');
      if (titleEl && !resetSiteId) titleEl.textContent = 'Tell us more about your business';
    }

    function selectDetailsBusiness(index) {
      var items = detailsBizDropdown._items || [];
      var biz = items[index];
      if (!biz) return;

      // Set as selected business and switch to badge mode
      state.selectedBusiness = biz;
      state.mode = 'business';

      // Update the details screen
      document.getElementById('badge-biz-name').textContent = biz.name || '';
      document.getElementById('badge-biz-addr').textContent = biz.address || biz.formatted_address || '';
      document.getElementById('details-business-badge').style.display = 'flex';
      document.getElementById('details-manual-fields').style.display = 'none';

      var titleEl = document.getElementById('details-title');
      if (titleEl && !resetSiteId) titleEl.textContent = 'Tell us more about your business';

      closeDetailsBizDropdown();
    }

    function closeDetailsBizDropdown() {
      if (detailsBizDropdown) detailsBizDropdown.classList.remove('open');
    }

    /* ===========================================================
       Improve with AI
       =========================================================== */
    function improveWithAI() {
      var textarea = document.getElementById('details-textarea');
      var overlay = document.getElementById('improve-ai-overlay');
      var buildBtn = document.getElementById('build-btn');
      var improveBtn = document.getElementById('improve-ai-btn');

      var text = textarea.value.trim();

      // Show overlay, prevent modification
      overlay.classList.add('visible');
      textarea.disabled = true;
      buildBtn.disabled = true;
      improveBtn.style.pointerEvents = 'none';
      improveBtn.style.opacity = '0.5';

      // Gather business context
      var bizName = '';
      var bizAddr = '';
      if (state.selectedBusiness) {
        bizName = state.selectedBusiness.name || state.selectedBusiness.business_name || '';
        bizAddr = state.selectedBusiness.address || state.selectedBusiness.formatted_address || '';
      } else {
        var nameInput = document.getElementById('business-name-input');
        var addrInput = document.getElementById('business-address-input');
        if (nameInput) bizName = nameInput.value.trim();
        if (addrInput) bizAddr = addrInput.value.trim();
      }

      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      fetch('/api/sites/improve-prompt', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          text: text,
          business_name: bizName,
          business_address: bizAddr
        })
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'AI improvement failed')); });
          return res.json();
        })
        .then(function(d) {
          var improved = d.data && d.data.improved_text ? d.data.improved_text : text;
          textarea.value = improved;
          overlay.classList.remove('visible');
          textarea.disabled = false;
          buildBtn.disabled = false;
          improveBtn.style.pointerEvents = '';
          improveBtn.style.opacity = '';
        })
        .catch(function(err) {
          overlay.classList.remove('visible');
          textarea.disabled = false;
          buildBtn.disabled = false;
          improveBtn.style.pointerEvents = '';
          improveBtn.style.opacity = '';
          showMsg('build-msg', 'error', err.message || 'AI improvement failed. Please try again.');
        });
    }

    /* ===========================================================
       Domain Unsubscribe + Delete with Warning
       =========================================================== */
    function unsubscribeDomain(siteId, hostnameId, hostname) {
      var confirmed = confirm(
        'UNSUBSCRIBE DOMAIN: ' + hostname + '\n\n' +
        'WARNING: This will cancel your premium domain subscription. ' +
        'The domain will stop resolving to your site and you may lose the registration. ' +
        'This action cannot be easily undone.\n\n' +
        'Are you sure you want to unsubscribe from this domain?'
      );
      if (!confirmed) return;

      var headers = { 'Content-Type': 'application/json' };
      if (state.session && state.session.token) {
        headers['Authorization'] = 'Bearer ' + state.session.token;
      }

      showMsg('domain-modal-msg', 'info', 'Cancelling domain subscription...');

      fetch('/api/sites/' + siteId + '/hostnames/' + hostnameId + '/unsubscribe', {
        method: 'POST',
        headers: headers
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Unsubscribe failed')); });
          return res.json();
        })
        .then(function() {
          showMsg('domain-modal-msg', 'success', 'Domain subscription cancelled. The domain will be removed at end of billing period.');
          loadHostnames(siteId);
          loadAdminDashboard();
        })
        .catch(function(err) {
          showMsg('domain-modal-msg', 'error', err.message || 'Failed to unsubscribe from domain.');
        });
    }

    function resetPrimaryToDefault(siteId) {
      if (!state.session || !state.session.token || !siteId) return;
      showMsg('domain-modal-msg', 'info', 'Resetting primary to default subdomain...');
      fetch('/api/sites/' + siteId + '/hostnames/reset-primary', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + state.session.token }
      })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(d) { throw new Error(extractErrorMsg(d, 'Failed to reset primary')); });
          return res.json();
        })
        .then(function() {
          showMsg('domain-modal-msg', 'success', 'Primary domain reset to default subdomain.');
          loadHostnames(siteId);
        })
        .catch(function(err) {
          showMsg('domain-modal-msg', 'error', err.message || 'Failed to reset primary domain.');
        });
    }

    function deleteHostnameWithWarning(siteId, hostnameId, hostname, isPremium) {
      var message = 'Remove domain: ' + hostname + '?';
      if (isPremium) {
        message += '\n\nWARNING: This is a PREMIUM domain with an active subscription. ' +
          'Removing it will NOT automatically cancel the subscription billing. ' +
          'Please unsubscribe first using the billing icon button, or manage it through the Billing portal.\n\n' +
          'Are you sure you want to remove this domain?';
      }
      if (!confirm(message)) return;
      deleteHostname(siteId, hostnameId);
    }

    /* ===========================================================
       Scroll-based Animations (Intersection Observer)
       =========================================================== */
    (function initScrollAnimations() {
      var animateSelectors = '.step-card, .feature-card, .handled-card, .dvd-column, .pricing-card, .pricing-card-free, .faq-item';
      var animateEls = document.querySelectorAll(animateSelectors);
      if (!animateEls.length) return;

      if ('IntersectionObserver' in window) {
        var observer = new IntersectionObserver(function(entries) {
          for (var i = 0; i < entries.length; i++) {
            if (entries[i].isIntersecting) {
              entries[i].target.classList.add('animate-in');
              observer.unobserve(entries[i].target);
            }
          }
        }, { threshold: 0.15 });

        for (var i = 0; i < animateEls.length; i++) {
          observer.observe(animateEls[i]);
        }
      } else {
        // Fallback: just show everything
        for (var j = 0; j < animateEls.length; j++) {
          animateEls[j].classList.add('animate-in');
        }
      }
    })();

    /* ===========================================================
       Init
       =========================================================== */
    render();

    // Auto-hide error notifications when user starts typing/interacting
    (function() {
      var autoHidePairs = [
        { input: 'details-textarea', msg: 'build-msg' },
        { input: 'business-name-input', msg: 'build-msg' },
        { input: 'business-address-input', msg: 'build-msg' },
        { input: 'domain-add-input', msg: 'domain-modal-msg' },
        { input: 'domain-search-input', msg: 'domain-modal-msg' },
        { input: 'edit-site-name-input', msg: 'edit-site-msg' },
        { input: 'magic-link-email', msg: 'auth-msg' }
      ];
      autoHidePairs.forEach(function(pair) {
        var el = document.getElementById(pair.input);
        if (el) {
          el.addEventListener('input', function() { hideMsg(pair.msg); });
        }
      });
    })();

    // Register service worker for PWA support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(function() {
        // Service worker registration failed - non-critical
      });
    }

    /* ===========================================================
       Enter Key Form Submission
       =========================================================== */
    (function() {
      // Edit site modal: Enter submits
      var editTitle = document.getElementById('edit-site-title');
      var editSlug = document.getElementById('edit-site-slug');
      if (editTitle) editTitle.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); saveEditSite(); } });
      if (editSlug) editSlug.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); saveEditSite(); } });

      // Email sign-in: Enter sends magic link
      var emailInput = document.getElementById('email-input');
      if (emailInput) emailInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); sendMagicLink(); } });

      // Contact form: Enter on fields submits
      var contactFields = ['contact-name', 'contact-email', 'contact-phone'];
      contactFields.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); submitContactForm(); } });
      });

      // Search input: Enter selects first result
      var searchInputEl = document.getElementById('search-input');
      if (searchInputEl) {
        searchInputEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            var firstResult = document.querySelector('#search-dropdown .search-result');
            if (firstResult) firstResult.click();
          }
        });
      }

      // Domain search: Enter on domain-search-input triggers search
      var domSearchInput = document.getElementById('domain-search-input');
      if (domSearchInput) domSearchInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); searchDomains(domSearchInput.value.trim()); } });
    })();

    /* ===========================================================
       Modal Focus Traps
       =========================================================== */
    (function() {
      function trapFocus(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) return;
        var observer = new MutationObserver(function(mutations) {
          for (var i = 0; i < mutations.length; i++) {
            if (mutations[i].attributeName === 'class') {
              if (modal.classList.contains('visible')) {
                setTimeout(function() {
                  var first = modal.querySelector('input:not([type=hidden]):not([style*="display:none"]), textarea, button:not(.modal-close)');
                  if (first) first.focus();
                }, 100);
              }
            }
          }
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
      }
      trapFocus('domain-modal');
      trapFocus('delete-modal');
      trapFocus('deploy-modal');
      trapFocus('details-modal');
    })();

    /* ===========================================================
       Free Plan Badge â†’ Billing
       =========================================================== */
    document.addEventListener('click', function(e) {
      var badge = e.target.closest('.plan-badge.free');
      if (badge) {
        var siteId = badge.closest('.site-card') ? badge.closest('.site-card').querySelector('.site-card-btn[onclick*="openSiteCheckout"]') : null;
        if (siteId) {
          siteId.click();
        } else {
          openBillingCheckout();
        }
      }
    });

    /* ===========================================================
       Status â†’ Modal (instead of full-screen waiting)
       =========================================================== */
    (function() {
      // Intercept the Status button click to open a modal instead of navigating
      document.addEventListener('click', function(e) {
        var btn = e.target.closest('.site-card-btn');
        if (!btn) return;
        var onclick = btn.getAttribute('onclick');
        if (!onclick || onclick.indexOf('navigateTo(\'waiting\')') === -1) return;
        e.preventDefault();
        e.stopPropagation();

        // Extract siteId and slug from onclick
        var siteIdMatch = onclick.match(/state\.siteId='([^']+)'/);
        var slugMatch = onclick.match(/state\.slug='([^']+)'/);
        if (siteIdMatch) state.siteId = siteIdMatch[1];
        if (slugMatch) state.slug = slugMatch[1];

        openStatusModal();
      }, true);
    })();

    var statusModalOpen = false;

    function openStatusModal() {
      // Create or show the status modal
      var existing = document.getElementById('status-modal-overlay');
      if (!existing) {
        var overlay = document.createElement('div');
        overlay.id = 'status-modal-overlay';
        overlay.className = 'modal-overlay visible';
        overlay.onclick = function(e) { if (e.target === overlay) closeStatusModal(); };
        overlay.innerHTML = '<div class="modal" style="max-width:560px;min-height:400px;">'
          + '<div class="modal-title"><span>Build Status</span><button class="modal-close" onclick="closeStatusModal()">&times;</button></div>'
          + '<div id="status-modal-terminal" style="padding:0;"></div>'
          + '</div>';
        document.body.appendChild(overlay);
      } else {
        existing.classList.add('visible');
      }

      statusModalOpen = true;

      // Clone the terminal into the modal
      var termBody = document.getElementById('status-modal-terminal');
      if (termBody) {
        termBody.innerHTML = '<div class="build-terminal" style="max-height:320px;margin:0;border:none;border-radius:0;">'
          + '<div class="build-terminal-header">'
          + '<div class="build-terminal-dot red"></div><div class="build-terminal-dot yellow"></div><div class="build-terminal-dot green"></div>'
          + '<span class="build-terminal-title">' + escapeHtml(state.slug ? 'build: ' + state.slug : 'build-progress') + '</span>'
          + '</div>'
          + '<div class="build-terminal-body" id="status-modal-terminal-body"></div>'
          + '</div>';
      }

      // Start polling workflow and printing to modal terminal
      startStatusTerminal();
    }

    function closeStatusModal() {
      var overlay = document.getElementById('status-modal-overlay');
      if (overlay) overlay.classList.remove('visible');
      statusModalOpen = false;
      stopStatusTerminal();
    }

    var statusTerminalTimer = null;

    function startStatusTerminal() {
      stopStatusTerminal();
      if (!state.siteId) return;

      var body = document.getElementById('status-modal-terminal-body');
      if (!body) return;
      body.innerHTML = '';

      function addLine(text, cls) {
        var line = document.createElement('div');
        line.className = 'build-terminal-line ' + (cls || '');
        line.textContent = text;
        body.appendChild(line);
        line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      addLine('Checking build status...', 'active');

      statusTerminalTimer = setInterval(function() {
        if (!statusModalOpen) { stopStatusTerminal(); return; }
        var headers = {};
        if (state.session && state.session.token) headers['Authorization'] = 'Bearer ' + state.session.token;

        fetch('/api/sites/' + state.siteId + '/workflow', { headers: headers })
          .then(function(res) { return res.ok ? res.json() : null; })
          .then(function(resp) {
            if (!resp || !resp.data) return;
            var data = resp.data;
            body.innerHTML = '';

            if (data.site_status === 'published') {
              addLine('Build completed successfully!', 'done');
              if (state.slug) addLine('Live at https://' + state.slug + '-sites.megabyte.space', 'done');
              stopStatusTerminal();
              return;
            }

            if (data.workflow_status === 'errored' || data.workflow_status === 'failed') {
              addLine('Build failed', 'error');
              var errMsg = data.workflow_error || 'Unknown error';
              if (typeof errMsg === 'object') errMsg = errMsg.message || JSON.stringify(errMsg);
              addLine(errMsg, 'error');
              stopStatusTerminal();
              return;
            }

            addLine('Workflow: ' + (data.workflow_status || 'unknown'), 'info');
            addLine('Site: ' + (data.site_status || 'unknown'), 'info');

            // Show each step
            for (var i = 0; i < WORKFLOW_STEP_ORDER.length; i++) {
              var step = WORKFLOW_STEP_ORDER[i];
              var label = WORKFLOW_STEP_LABELS[step] || step;
              if (data.workflow_status === 'complete' || data.site_status === 'published') {
                addLine(label, 'done');
              } else if (data.workflow_status === 'running' && i === 0) {
                addLine(label, 'active');
              } else {
                addLine(label, 'pending');
              }
            }
          })
          .catch(function() {});
      }, 3000);

      // Immediate first poll
      setTimeout(function() {
        if (statusTerminalTimer) {
          var headers = {};
          if (state.session && state.session.token) headers['Authorization'] = 'Bearer ' + state.session.token;
          fetch('/api/sites/' + state.siteId + '/workflow', { headers: headers })
            .then(function(res) { return res.ok ? res.json() : null; })
            .then(function(resp) {
              if (!resp || !resp.data) return;
              body.innerHTML = '';
              var data = resp.data;
              var addL = function(text, cls) {
                var line = document.createElement('div');
                line.className = 'build-terminal-line ' + (cls || '');
                line.textContent = text;
                body.appendChild(line);
              };
              addL('Workflow: ' + (data.workflow_status || 'pending'), 'info');
              for (var i = 0; i < WORKFLOW_STEP_ORDER.length; i++) {
                addL(WORKFLOW_STEP_LABELS[WORKFLOW_STEP_ORDER[i]] || WORKFLOW_STEP_ORDER[i], 'pending');
              }
            })
            .catch(function() {});
        }
      }, 100);
    }

    function stopStatusTerminal() {
      if (statusTerminalTimer) {
        clearInterval(statusTerminalTimer);
        statusTerminalTimer = null;
      }
    }
  </script>
  <!-- CodeMirror 5 â€” code editor with syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/selection/active-line.min.js"></script>
</body>
</html>
